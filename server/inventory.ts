import { EventEmitter } from 'events';\n\nexport type InventoryCategory = 'seeds' | 'fertilizer' | 'pesticides' | 'equipment_parts' | 'supplies' | 'other';\nexport type InventoryUnit = 'kg' | 'liter' | 'unit' | 'bag' | 'box' | 'ton';\n\nexport interface InventoryItem {\n  id: string;\n  farmId: string;\n  name: string;\n  category: InventoryCategory;\n  quantity: number;\n  unit: InventoryUnit;\n  minThreshold: number; // Reorder point\n  maxCapacity: number;\n  unitCost: number;\n  totalValue: number;\n  supplier: string;\n  location: string;\n  expiryDate?: number;\n  dateAdded: number;\n  lastUpdated: number;\n  notes: string;\n}\n\nexport interface InventoryTransaction {\n  id: string;\n  itemId: string;\n  farmId: string;\n  type: 'purchase' | 'usage' | 'adjustment' | 'return';\n  quantity: number;\n  date: number;\n  cost?: number;\n  reference: string; // e.g., task ID, field ID\n  notes: string;\n}\n\nexport interface ReorderAlert {\n  id: string;\n  itemId: string;\n  farmId: string;\n  currentQuantity: number;\n  minThreshold: number;\n  recommendedQuantity: number;\n  estimatedCost: number;\n  supplier: string;\n  createdAt: number;\n  status: 'pending' | 'ordered' | 'received';\n}\n\nexport interface InventoryUsage {\n  itemId: string;\n  totalUsed: number;\n  averageDailyUsage: number;\n  daysUntilStockout: number;\n  lastUsedDate: number;\n}\n\nexport interface InventoryReport {\n  id: string;\n  farmId: string;\n  generatedAt: number;\n  period: { start: number; end: number };\n  totalItems: number;\n  totalValue: number;\n  itemsNeedingReorder: number;\n  expiredItems: number;\n  transactions: number;\n  costOfGoodsSold: number;\n}\n\n/**\n * Inventory Management System\n */\nexport class InventoryManager extends EventEmitter {\n  private items: Map<string, InventoryItem> = new Map();\n  private transactions: Map<string, InventoryTransaction> = new Map();\n  private alerts: Map<string, ReorderAlert> = new Map();\n  private reports: Map<string, InventoryReport> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Add inventory item\n   */\n  addInventoryItem(\n    farmId: string,\n    name: string,\n    category: InventoryCategory,\n    quantity: number,\n    unit: InventoryUnit,\n    minThreshold: number,\n    maxCapacity: number,\n    unitCost: number,\n    supplier: string,\n    location: string,\n    expiryDate?: number,\n    notes: string = ''\n  ): InventoryItem {\n    const itemId = `inv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const totalValue = quantity * unitCost;\n\n    const item: InventoryItem = {\n      id: itemId,\n      farmId,\n      name,\n      category,\n      quantity,\n      unit,\n      minThreshold,\n      maxCapacity,\n      unitCost,\n      totalValue,\n      supplier,\n      location,\n      expiryDate,\n      dateAdded: Date.now(),\n      lastUpdated: Date.now(),\n      notes,\n    };\n\n    this.items.set(itemId, item);\n    this.emit('item:added', { itemId, farmId, name });\n    this.checkReorderThreshold(itemId);\n    return item;\n  }\n\n  /**\n   * Get inventory item\n   */\n  getInventoryItem(itemId: string): InventoryItem | null {\n    return this.items.get(itemId) || null;\n  }\n\n  /**\n   * Get inventory by farm\n   */\n  getInventoryByFarm(farmId: string): InventoryItem[] {\n    return Array.from(this.items.values()).filter((i) => i.farmId === farmId);\n  }\n\n  /**\n   * Get inventory by category\n   */\n  getInventoryByCategory(farmId: string, category: InventoryCategory): InventoryItem[] {\n    return Array.from(this.items.values()).filter((i) => i.farmId === farmId && i.category === category);\n  }\n\n  /**\n   * Record inventory transaction\n   */\n  recordTransaction(\n    itemId: string,\n    farmId: string,\n    type: 'purchase' | 'usage' | 'adjustment' | 'return',\n    quantity: number,\n    reference: string,\n    cost?: number,\n    notes: string = ''\n  ): InventoryTransaction {\n    const transactionId = `trans_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const item = this.items.get(itemId);\n    if (!item) throw new Error('Item not found');\n\n    // Update item quantity\n    if (type === 'purchase' || type === 'return') {\n      item.quantity += quantity;\n    } else if (type === 'usage' || type === 'adjustment') {\n      item.quantity = Math.max(0, item.quantity - quantity);\n    }\n\n    item.lastUpdated = Date.now();\n    item.totalValue = item.quantity * item.unitCost;\n\n    const transaction: InventoryTransaction = {\n      id: transactionId,\n      itemId,\n      farmId,\n      type,\n      quantity,\n      date: Date.now(),\n      cost,\n      reference,\n      notes,\n    };\n\n    this.transactions.set(transactionId, transaction);\n    this.emit('transaction:recorded', { transactionId, itemId, type, quantity });\n    this.checkReorderThreshold(itemId);\n    return transaction;\n  }\n\n  /**\n   * Get transactions for item\n   */\n  getTransactions(itemId: string, type?: string): InventoryTransaction[] {\n    let trans = Array.from(this.transactions.values()).filter((t) => t.itemId === itemId);\n    if (type) {\n      trans = trans.filter((t) => t.type === type);\n    }\n    return trans.sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Check reorder threshold\n   */\n  private checkReorderThreshold(itemId: string): void {\n    const item = this.items.get(itemId);\n    if (!item) return;\n\n    if (item.quantity <= item.minThreshold) {\n      const alertId = `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      const recommendedQuantity = item.maxCapacity - item.quantity;\n      const estimatedCost = recommendedQuantity * item.unitCost;\n\n      const alert: ReorderAlert = {\n        id: alertId,\n        itemId,\n        farmId: item.farmId,\n        currentQuantity: item.quantity,\n        minThreshold: item.minThreshold,\n        recommendedQuantity,\n        estimatedCost,\n        supplier: item.supplier,\n        createdAt: Date.now(),\n        status: 'pending',\n      };\n\n      this.alerts.set(alertId, alert);\n      this.emit('alert:reorder', { alertId, itemId, currentQuantity: item.quantity });\n    }\n  }\n\n  /**\n   * Get reorder alerts\n   */\n  getReorderAlerts(farmId: string, status?: string): ReorderAlert[] {\n    let alerts = Array.from(this.alerts.values()).filter((a) => a.farmId === farmId);\n    if (status) {\n      alerts = alerts.filter((a) => a.status === status);\n    }\n    return alerts.sort((a, b) => b.createdAt - a.createdAt);\n  }\n\n  /**\n   * Mark alert as ordered\n   */\n  markAlertAsOrdered(alertId: string): ReorderAlert | null {\n    const alert = this.alerts.get(alertId);\n    if (!alert) return null;\n\n    alert.status = 'ordered';\n    this.emit('alert:ordered', { alertId });\n    return alert;\n  }\n\n  /**\n   * Calculate inventory usage\n   */\n  calculateInventoryUsage(itemId: string, days: number = 30): InventoryUsage {\n    const trans = this.getTransactions(itemId, 'usage');\n    const cutoffDate = Date.now() - days * 86400000;\n    const recentUsage = trans.filter((t) => t.date >= cutoffDate);\n\n    const totalUsed = recentUsage.reduce((sum, t) => sum + t.quantity, 0);\n    const averageDailyUsage = totalUsed / days;\n    const item = this.items.get(itemId);\n    const daysUntilStockout = averageDailyUsage > 0 && item ? Math.floor(item.quantity / averageDailyUsage) : 0;\n    const lastUsedDate = recentUsage.length > 0 ? recentUsage[0].date : 0;\n\n    return {\n      itemId,\n      totalUsed,\n      averageDailyUsage,\n      daysUntilStockout,\n      lastUsedDate,\n    };\n  }\n\n  /**\n   * Get expired items\n   */\n  getExpiredItems(farmId: string): InventoryItem[] {\n    const now = Date.now();\n    return Array.from(this.items.values()).filter(\n      (i) => i.farmId === farmId && i.expiryDate && i.expiryDate < now\n    );\n  }\n\n  /**\n   * Calculate total inventory value\n   */\n  calculateTotalInventoryValue(farmId: string): number {\n    return this.getInventoryByFarm(farmId).reduce((sum, item) => sum + item.totalValue, 0);\n  }\n\n  /**\n   * Generate inventory report\n   */\n  generateInventoryReport(\n    farmId: string,\n    startDate: number,\n    endDate: number\n  ): InventoryReport {\n    const reportId = `report_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const items = this.getInventoryByFarm(farmId);\n    const totalValue = items.reduce((sum, i) => sum + i.totalValue, 0);\n    const itemsNeedingReorder = items.filter((i) => i.quantity <= i.minThreshold).length;\n    const expiredItems = this.getExpiredItems(farmId).length;\n\n    const allTransactions = Array.from(this.transactions.values()).filter(\n      (t) => t.farmId === farmId && t.date >= startDate && t.date <= endDate\n    );\n    const costOfGoodsSold = allTransactions\n      .filter((t) => t.type === 'usage')\n      .reduce((sum, t) => sum + (t.cost || 0), 0);\n\n    const report: InventoryReport = {\n      id: reportId,\n      farmId,\n      generatedAt: Date.now(),\n      period: { start: startDate, end: endDate },\n      totalItems: items.length,\n      totalValue,\n      itemsNeedingReorder,\n      expiredItems,\n      transactions: allTransactions.length,\n      costOfGoodsSold,\n    };\n\n    this.reports.set(reportId, report);\n    this.emit('report:generated', { reportId, farmId });\n    return report;\n  }\n\n  /**\n   * Get inventory report\n   */\n  getInventoryReport(reportId: string): InventoryReport | null {\n    return this.reports.get(reportId) || null;\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalItems: number;\n    totalTransactions: number;\n    totalAlerts: number;\n    totalReports: number;\n  } {\n    return {\n      totalItems: this.items.size,\n      totalTransactions: this.transactions.size,\n      totalAlerts: this.alerts.size,\n      totalReports: this.reports.size,\n    };\n  }\n}\n
