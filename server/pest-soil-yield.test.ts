import { describe, it, expect, beforeEach } from 'vitest';\nimport { PestDiseaseManager } from './pest-disease';\nimport { SoilHealthManager } from './soil-health';\nimport { YieldForecastingManager } from './yield-forecast';\n\n/**\n * Pest & Disease Manager Tests\n */\ndescribe('Pest & Disease Manager', () => {\n  let manager: PestDiseaseManager;\n\n  beforeEach(() => {\n    manager = new PestDiseaseManager();\n  });\n\n  it('should get pest by id', () => {\n    const pest = manager.getPest('pest-aphid');\n    expect(pest).not.toBeNull();\n    expect(pest?.name).toBe('Aphid');\n  });\n\n  it('should get pests by crop', () => {\n    const pests = manager.getPestsByCrop('wheat');\n    expect(pests.length).toBeGreaterThan(0);\n    expect(pests[0].affectedCrops).toContain('wheat');\n  });\n\n  it('should record pest detection', () => {\n    const record = manager.recordPestDiseaseDetection(\n      'farm-1',\n      'field-1',\n      'crop-wheat',\n      'pest',\n      'pest-aphid',\n      'Aphid',\n      'medium',\n      25,\n      'Found on lower leaves'\n    );\n\n    expect(record).not.toBeNull();\n    expect(record.type).toBe('pest');\n    expect(record.severity).toBe('medium');\n  });\n\n  it('should get records by field', () => {\n    manager.recordPestDiseaseDetection('farm-1', 'field-1', 'crop-wheat', 'pest', 'pest-aphid', 'Aphid', 'low', 10);\n    manager.recordPestDiseaseDetection('farm-1', 'field-1', 'crop-wheat', 'disease', 'disease-powdery-mildew', 'Powdery Mildew', 'medium', 15);\n\n    const records = manager.getRecordsByField('field-1');\n    expect(records.length).toBe(2);\n  });\n\n  it('should add treatment to record', () => {\n    const record = manager.recordPestDiseaseDetection(\n      'farm-1',\n      'field-1',\n      'crop-wheat',\n      'pest',\n      'pest-aphid',\n      'Aphid',\n      'medium',\n      25\n    );\n\n    const updated = manager.addTreatmentToRecord(record.id, 'organic', 'Neem Oil', 75, 25);\n    expect(updated?.treatments.length).toBe(1);\n    expect(updated?.treatments[0].name).toBe('Neem Oil');\n  });\n\n  it('should resolve record', () => {\n    const record = manager.recordPestDiseaseDetection(\n      'farm-1',\n      'field-1',\n      'crop-wheat',\n      'pest',\n      'pest-aphid',\n      'Aphid',\n      'medium',\n      25\n    );\n\n    const resolved = manager.resolveRecord(record.id);\n    expect(resolved?.dateResolved).not.toBeUndefined();\n  });\n\n  it('should generate alert', () => {\n    const alert = manager.generateAlert(\n      'farm-1',\n      'field-1',\n      'pest',\n      'Armyworm',\n      75,\n      ['warm temperature', 'high humidity'],\n      ['Monitor closely', 'Apply insecticide']\n    );\n\n    expect(alert).not.toBeNull();\n    expect(alert.riskLevel).toBe(75);\n  });\n\n  it('should create treatment plan', () => {\n    const record = manager.recordPestDiseaseDetection(\n      'farm-1',\n      'field-1',\n      'crop-wheat',\n      'pest',\n      'pest-aphid',\n      'Aphid',\n      'high',\n      40\n    );\n\n    const plan = manager.createTreatmentPlan('farm-1', 'field-1', record.id, [\n      {\n        step: 1,\n        method: 'organic',\n        name: 'Neem Oil',\n        scheduledDate: Date.now() + 86400000,\n        cost: 25,\n        expectedEffectiveness: 75,\n        notes: 'First application',\n      },\n      {\n        step: 2,\n        method: 'chemical',\n        name: 'Insecticide',\n        scheduledDate: Date.now() + 2 * 86400000,\n        cost: 50,\n        expectedEffectiveness: 95,\n        notes: 'Follow-up if needed',\n      },\n    ]);\n\n    expect(plan).not.toBeNull();\n    expect(plan.totalCost).toBe(75);\n    expect(plan.treatments.length).toBe(2);\n  });\n\n  it('should get statistics', () => {\n    manager.recordPestDiseaseDetection('farm-1', 'field-1', 'crop-wheat', 'pest', 'pest-aphid', 'Aphid', 'low', 10);\n\n    const stats = manager.getStatistics();\n    expect(stats.totalPests).toBeGreaterThan(0);\n    expect(stats.totalRecords).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Soil Health Manager Tests\n */\ndescribe('Soil Health Manager', () => {\n  let manager: SoilHealthManager;\n\n  beforeEach(() => {\n    manager = new SoilHealthManager();\n  });\n\n  it('should record soil test', () => {\n    const test = manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      120,\n      20,\n      140,\n      1500,\n      300,\n      50,\n      6.5,\n      3.5,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 },\n      'Good soil condition'\n    );\n\n    expect(test).not.toBeNull();\n    expect(test.pH).toBe(6.5);\n    expect(test.nitrogen).toBe(120);\n  });\n\n  it('should get latest soil test', () => {\n    manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      120,\n      20,\n      140,\n      1500,\n      300,\n      50,\n      6.5,\n      3.5,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    const latest = manager.getLatestSoilTest('field-1');\n    expect(latest).not.toBeNull();\n    expect(latest?.nitrogen).toBe(120);\n  });\n\n  it('should generate nutrient recommendations', () => {\n    const test = manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      80,\n      15,\n      100,\n      1500,\n      300,\n      50,\n      6.8,\n      2.5,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    const rec = manager.generateNutrientRecommendations(test.id);\n    expect(rec).not.toBeNull();\n    expect(rec.nitrogen.current).toBe(80);\n    expect(rec.nitrogen.recommended).toBe(150);\n    expect(rec.totalCost).toBeGreaterThan(0);\n  });\n\n  it('should record soil amendment', () => {\n    const amendment = manager.recordSoilAmendment(\n      'farm-1',\n      'field-1',\n      'Compost',\n      1000,\n      150,\n      'wheat',\n      'Increase organic matter',\n      'Applied in spring'\n    );\n\n    expect(amendment).not.toBeNull();\n    expect(amendment.type).toBe('Compost');\n    expect(amendment.amount).toBe(1000);\n  });\n\n  it('should calculate health score', () => {\n    const test = manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      150,\n      25,\n      150,\n      1500,\n      300,\n      50,\n      6.5,\n      4,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    const score = manager.calculateHealthScore(test.id);\n    expect(score).not.toBeNull();\n    expect(score.overallScore).toBeGreaterThan(0);\n    expect(score.overallScore).toBeLessThanOrEqual(100);\n  });\n\n  it('should get soil trend', () => {\n    manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      100,\n      20,\n      140,\n      1500,\n      300,\n      50,\n      6.5,\n      3,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    manager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      130,\n      22,\n      150,\n      1500,\n      300,\n      50,\n      6.5,\n      3.5,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    const trend = manager.getSoilTrend('field-1', 'nitrogen');\n    expect(trend.values.length).toBe(2);\n    expect(trend.trend).toBe('improving');\n  });\n});\n\n/**\n * Yield Forecasting Manager Tests\n */\ndescribe('Yield Forecasting Manager', () => {\n  let manager: YieldForecastingManager;\n\n  beforeEach(() => {\n    manager = new YieldForecastingManager();\n  });\n\n  it('should generate yield forecast', () => {\n    const forecast = manager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [4500, 5000, 5200],\n      soilHealthScore: 75,\n      nitrogenLevel: 150,\n      phosphorusLevel: 25,\n      potassiumLevel: 150,\n      pH: 6.5,\n      organicMatter: 3.5,\n      rainfall: 600,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 20,\n      diseasePressure: 15,\n      irrigationPlanned: 100,\n    });\n\n    expect(forecast).not.toBeNull();\n    expect(forecast.predictedYield).toBeGreaterThan(0);\n    expect(forecast.confidence).toBeGreaterThan(0);\n    expect(forecast.confidence).toBeLessThanOrEqual(100);\n  });\n\n  it('should include yield range', () => {\n    const forecast = manager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [5000],\n      soilHealthScore: 70,\n      nitrogenLevel: 150,\n      phosphorusLevel: 25,\n      potassiumLevel: 150,\n      pH: 6.5,\n      organicMatter: 3.5,\n      rainfall: 600,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 10,\n      diseasePressure: 10,\n      irrigationPlanned: 100,\n    });\n\n    expect(forecast.yieldRange.low).toBeLessThan(forecast.predictedYield);\n    expect(forecast.yieldRange.high).toBeGreaterThan(forecast.predictedYield);\n  });\n\n  it('should include factors affecting yield', () => {\n    const forecast = manager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [5000],\n      soilHealthScore: 70,\n      nitrogenLevel: 150,\n      phosphorusLevel: 25,\n      potassiumLevel: 150,\n      pH: 6.5,\n      organicMatter: 3.5,\n      rainfall: 600,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 10,\n      diseasePressure: 10,\n      irrigationPlanned: 100,\n    });\n\n    expect(forecast.factors.length).toBeGreaterThan(0);\n    expect(forecast.factors[0].name).toBeDefined();\n    expect(forecast.factors[0].impact).toBeDefined();\n  });\n\n  it('should generate recommendations', () => {\n    const forecast = manager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [5000],\n      soilHealthScore: 50,\n      nitrogenLevel: 80,\n      phosphorusLevel: 15,\n      potassiumLevel: 100,\n      pH: 5.5,\n      organicMatter: 2,\n      rainfall: 400,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 40,\n      diseasePressure: 35,\n      irrigationPlanned: 100,\n    });\n\n    expect(forecast.recommendations.length).toBeGreaterThan(0);\n  });\n\n  it('should analyze yield trends', () => {\n    const analysis = manager.analyzeYieldTrends('field-1', [4500, 5000, 5200], 5500);\n\n    expect(analysis).not.toBeNull();\n    expect(analysis.historicalAverage).toBe(4900);\n    expect(analysis.predictedYield).toBe(5500);\n    expect(analysis.trend).toBe('increasing');\n  });\n\n  it('should get statistics', () => {\n    manager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [5000],\n      soilHealthScore: 70,\n      nitrogenLevel: 150,\n      phosphorusLevel: 25,\n      potassiumLevel: 150,\n      pH: 6.5,\n      organicMatter: 3.5,\n      rainfall: 600,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 10,\n      diseasePressure: 10,\n      irrigationPlanned: 100,\n    });\n\n    const stats = manager.getStatistics();\n    expect(stats.totalForecasts).toBeGreaterThan(0);\n    expect(stats.averagePredictedYield).toBeGreaterThan(0);\n    expect(stats.averageConfidence).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with all three systems together', () => {\n    const pestManager = new PestDiseaseManager();\n    const soilManager = new SoilHealthManager();\n    const yieldManager = new YieldForecastingManager();\n\n    // Record soil test\n    const soilTest = soilManager.recordSoilTest(\n      'farm-1',\n      'field-1',\n      20,\n      150,\n      25,\n      150,\n      1500,\n      300,\n      50,\n      6.5,\n      4,\n      15,\n      'loamy',\n      { sand: 40, silt: 40, clay: 20 },\n      { iron: 50, manganese: 30, zinc: 5, copper: 2, boron: 1 }\n    );\n\n    // Calculate soil health\n    const healthScore = soilManager.calculateHealthScore(soilTest.id);\n    expect(healthScore.overallScore).toBeGreaterThan(0);\n\n    // Record pest detection\n    const pestRecord = pestManager.recordPestDiseaseDetection(\n      'farm-1',\n      'field-1',\n      'crop-wheat',\n      'pest',\n      'pest-aphid',\n      'Aphid',\n      'low',\n      5\n    );\n    expect(pestRecord).not.toBeNull();\n\n    // Generate yield forecast\n    const forecast = yieldManager.generateYieldForecast({\n      cropId: 'crop-wheat',\n      fieldId: 'field-1',\n      plantingDate: Date.now(),\n      historicalYields: [5000],\n      soilHealthScore: healthScore.overallScore,\n      nitrogenLevel: soilTest.nitrogen,\n      phosphorusLevel: soilTest.phosphorus,\n      potassiumLevel: soilTest.potassium,\n      pH: soilTest.pH,\n      organicMatter: soilTest.organicMatter,\n      rainfall: 600,\n      temperature: { min: 15, max: 25 },\n      sunlight: 8,\n      pestPressure: 5,\n      diseasePressure: 0,\n      irrigationPlanned: 100,\n    });\n\n    expect(forecast.predictedYield).toBeGreaterThan(0);\n    expect(forecast.confidence).toBeGreaterThan(0);\n  });\n});\n
