import { describe, it, expect, beforeEach } from 'vitest';\nimport { PredictiveAnalyticsEngine } from './predictive-analytics';\nimport { NotificationPreferencesManager } from './notification-preferences';\nimport { BudgetTrackingManager } from './budget-tracking';\n\n/**\n * Predictive Analytics Tests\n */\ndescribe('Predictive Analytics Engine', () => {\n  let engine: PredictiveAnalyticsEngine;\n\n  beforeEach(() => {\n    engine = new PredictiveAnalyticsEngine();\n  });\n\n  it('should add historical data', () => {\n    const data = engine.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n\n    expect(data).not.toBeNull();\n    expect(data.period).toBe('Q1 2026');\n    expect(data.profit).toBe(20000);\n    expect(data.weather.temperature).toBe(20);\n  });\n\n  it('should forecast revenue', () => {\n    engine.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n    engine.addHistoricalData('farm-1', 'Q2 2026', 110000, 85000, 5500, 25, 160, 70);\n\n    const forecasts = engine.forecastRevenue('farm-1', 3);\n\n    expect(forecasts.length).toBe(3);\n    expect(forecasts[0].predictedRevenue).toBeGreaterThan(0);\n    expect(forecasts[0].confidenceInterval.upper).toBeGreaterThan(forecasts[0].confidenceInterval.lower);\n  });\n\n  it('should analyze expense patterns', () => {\n    engine.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n    engine.addHistoricalData('farm-1', 'Q2 2026', 110000, 85000, 5500, 25, 160, 70);\n\n    const patterns = engine.analyzeExpensePatterns('farm-1');\n\n    expect(patterns.length).toBeGreaterThan(0);\n    expect(patterns[0].category).toBeDefined();\n    expect(patterns[0].averageMonthly).toBeGreaterThan(0);\n  });\n\n  it('should predict supplier performance', () => {\n    const prediction = engine.predictSupplierPerformance('supplier-1', 'Seed Co', 85, 4.2, 5);\n\n    expect(prediction).not.toBeNull();\n    expect(prediction.predictedOnTimeDelivery).toBeGreaterThanOrEqual(85);\n    expect(prediction.riskLevel).toMatch(/low|medium|high/);\n  });\n\n  it('should detect anomalies', () => {\n    engine.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n    engine.addHistoricalData('farm-1', 'Q2 2026', 110000, 85000, 5500, 25, 160, 70);\n    engine.addHistoricalData('farm-1', 'Q3 2026', 50000, 80000, 2500, 15, 80, 55); // Anomaly\n\n    const anomalies = engine.detectAnomalies('farm-1', 1.5);\n\n    expect(anomalies.length).toBeGreaterThan(0);\n    expect(anomalies[0].type).toBe('revenue_anomaly');\n  });\n\n  it('should get statistics', () => {\n    engine.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n    engine.forecastRevenue('farm-1', 3);\n    engine.detectAnomalies('farm-1');\n\n    const stats = engine.getStatistics();\n\n    expect(stats.totalFarms).toBeGreaterThan(0);\n    expect(stats.totalForecasts).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Notification Preferences Tests\n */\ndescribe('Notification Preferences Manager', () => {\n  let manager: NotificationPreferencesManager;\n\n  beforeEach(() => {\n    manager = new NotificationPreferencesManager();\n  });\n\n  it('should create preference', () => {\n    const pref = manager.createPreference(\n      'user-1',\n      'farm-1',\n      'inventory_low',\n      ['email', 'push'],\n      'daily',\n      'medium'\n    );\n\n    expect(pref).not.toBeNull();\n    expect(pref.notificationType).toBe('inventory_low');\n    expect(pref.enabled).toBe(true);\n  });\n\n  it('should get user settings', () => {\n    const settings = manager.getUserSettings('user-1', 'farm-1');\n\n    expect(settings).not.toBeNull();\n    expect(settings.userId).toBe('user-1');\n    expect(settings.defaultChannels).toContain('email');\n  });\n\n  it('should update user settings', () => {\n    const updated = manager.updateUserSettings('user-1', 'farm-1', {\n      doNotDisturb: true,\n      doNotDisturbHours: { start: 22, end: 8 },\n    });\n\n    expect(updated.doNotDisturb).toBe(true);\n    expect(updated.doNotDisturbHours?.start).toBe(22);\n  });\n\n  it('should check if notification should be sent', () => {\n    manager.createPreference(\n      'user-1',\n      'farm-1',\n      'inventory_low',\n      ['email', 'push'],\n      'daily',\n      'medium'\n    );\n\n    const result = manager.shouldSendNotification('user-1', 'farm-1', 'inventory_low', 'high');\n\n    expect(result.should).toBe(true);\n    expect(result.channels).toContain('email');\n  });\n\n  it('should respect do not disturb', () => {\n    manager.updateUserSettings('user-1', 'farm-1', {\n      doNotDisturb: true,\n      doNotDisturbHours: { start: 0, end: 23 }, // All day\n    });\n\n    const result = manager.shouldSendNotification('user-1', 'farm-1', 'inventory_low', 'high');\n\n    expect(result.should).toBe(false);\n  });\n\n  it('should log notification', () => {\n    const log = manager.logNotification('user-1', 'farm-1', 'inventory_low', ['email', 'push'], 'sent');\n\n    expect(log).not.toBeNull();\n    expect(log.status).toBe('sent');\n    expect(log.channels).toContain('email');\n  });\n\n  it('should get notification logs', () => {\n    manager.logNotification('user-1', 'farm-1', 'inventory_low', ['email'], 'sent');\n    manager.logNotification('user-1', 'farm-1', 'weather_alert', ['push'], 'sent');\n\n    const logs = manager.getNotificationLogs('user-1', 'farm-1');\n\n    expect(logs.length).toBe(2);\n  });\n\n  it('should get templates', () => {\n    const templates = manager.getAllTemplates();\n\n    expect(templates.length).toBeGreaterThan(0);\n    expect(templates[0].id).toBeDefined();\n  });\n\n  it('should get statistics', () => {\n    manager.createPreference('user-1', 'farm-1', 'inventory_low', ['email'], 'daily', 'medium');\n    manager.createPreference('user-2', 'farm-2', 'weather_alert', ['push'], 'immediate', 'high');\n\n    const stats = manager.getStatistics();\n\n    expect(stats.totalPreferences).toBe(2);\n    expect(stats.totalTemplates).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Budget Tracking Tests\n */\ndescribe('Budget Tracking Manager', () => {\n  let manager: BudgetTrackingManager;\n\n  beforeEach(() => {\n    manager = new BudgetTrackingManager();\n  });\n\n  it('should create budget', () => {\n    const budget = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000,\n      'Monthly labor budget'\n    );\n\n    expect(budget).not.toBeNull();\n    expect(budget.category).toBe('labor');\n    expect(budget.allocatedAmount).toBe(10000);\n  });\n\n  it('should record expense', () => {\n    const budget = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    const expense = manager.recordExpense(\n      'farm-1',\n      budget.id,\n      'labor',\n      2500,\n      'Weekly payroll',\n      'Payroll System'\n    );\n\n    expect(expense).not.toBeNull();\n    expect(expense.amount).toBe(2500);\n  });\n\n  it('should calculate budget variance', () => {\n    const budget = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    manager.recordExpense('farm-1', budget.id, 'labor', 2500, 'Payroll');\n    manager.recordExpense('farm-1', budget.id, 'labor', 2500, 'Payroll');\n\n    const variance = manager.getBudgetVariance(budget.id);\n\n    expect(variance).not.toBeNull();\n    expect(variance!.actualAmount).toBe(5000);\n    expect(variance!.variance).toBe(5000);\n    expect(variance!.status).toBe('on_track');\n  });\n\n  it('should detect budget overrun', () => {\n    const budget = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    manager.recordExpense('farm-1', budget.id, 'labor', 6000, 'Payroll');\n    manager.recordExpense('farm-1', budget.id, 'labor', 5000, 'Payroll');\n\n    const variance = manager.getBudgetVariance(budget.id);\n\n    expect(variance!.status).toBe('over');\n    expect(variance!.actualAmount).toBe(11000);\n  });\n\n  it('should get budget summary', () => {\n    manager.createBudget('farm-1', 'labor', 'monthly', 10000, Date.now(), Date.now() + 30 * 24 * 60 * 60 * 1000);\n    manager.createBudget('farm-1', 'seeds', 'monthly', 5000, Date.now(), Date.now() + 30 * 24 * 60 * 60 * 1000);\n\n    const summary = manager.getBudgetSummary('farm-1');\n\n    expect(summary.totalAllocated).toBe(15000);\n    expect(summary.budgets.length).toBe(2);\n  });\n\n  it('should get budget alerts', () => {\n    const budget = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    // Record expense that triggers alert (80% threshold)\n    manager.recordExpense('farm-1', budget.id, 'labor', 8500, 'Payroll');\n\n    const alerts = manager.getBudgetAlerts(budget.id);\n\n    expect(alerts.length).toBeGreaterThan(0);\n  });\n\n  it('should get budget performance', () => {\n    const budget1 = manager.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n    const budget2 = manager.createBudget(\n      'farm-1',\n      'seeds',\n      'monthly',\n      5000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    manager.recordExpense('farm-1', budget1.id, 'labor', 5000, 'Payroll');\n    manager.recordExpense('farm-1', budget2.id, 'seeds', 4500, 'Seeds');\n\n    const performance = manager.getBudgetPerformance('farm-1');\n\n    expect(performance.onTrack).toBeGreaterThanOrEqual(0);\n    expect(performance.under).toBeGreaterThanOrEqual(0);\n  });\n\n  it('should get statistics', () => {\n    manager.createBudget('farm-1', 'labor', 'monthly', 10000, Date.now(), Date.now() + 30 * 24 * 60 * 60 * 1000);\n    manager.createBudget('farm-1', 'seeds', 'monthly', 5000, Date.now(), Date.now() + 30 * 24 * 60 * 60 * 1000);\n\n    const stats = manager.getStatistics();\n\n    expect(stats.totalBudgets).toBe(2);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with all three systems together', () => {\n    const analytics = new PredictiveAnalyticsEngine();\n    const notifications = new NotificationPreferencesManager();\n    const budget = new BudgetTrackingManager();\n\n    // Add historical data\n    analytics.addHistoricalData('farm-1', 'Q1 2026', 100000, 80000, 5000, 20, 150, 65);\n\n    // Create budget\n    const budgetAlloc = budget.createBudget(\n      'farm-1',\n      'labor',\n      'monthly',\n      10000,\n      Date.now(),\n      Date.now() + 30 * 24 * 60 * 60 * 1000\n    );\n\n    // Create notification preference\n    notifications.createPreference(\n      'user-1',\n      'farm-1',\n      'budget_exceeded',\n      ['email', 'push'],\n      'immediate',\n      'high'\n    );\n\n    // Record expense\n    budget.recordExpense('farm-1', budgetAlloc.id, 'labor', 8500, 'Payroll');\n\n    // Check if notification should be sent\n    const shouldSend = notifications.shouldSendNotification('user-1', 'farm-1', 'budget_exceeded', 'high');\n\n    expect(shouldSend.should).toBe(true);\n    expect(shouldSend.channels).toContain('email');\n  });\n});\n
