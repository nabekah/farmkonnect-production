import { describe, it, expect, beforeEach, afterEach } from 'vitest';\nimport CampaignPerformanceDashboard from './campaign-dashboard';\nimport TemplateCustomizationBuilder from './template-customization-builder';\n\ndescribe('CampaignPerformanceDashboard', () => {\n  let dashboard: CampaignPerformanceDashboard;\n\n  beforeEach(() => {\n    dashboard = new CampaignPerformanceDashboard();\n  });\n\n  afterEach(() => {\n    dashboard.destroy();\n  });\n\n  describe('Campaign Management', () => {\n    it('should create campaign', () => {\n      const campaign = dashboard.createCampaign('camp-1', 'Newsletter', 1000);\n\n      expect(campaign).toBeDefined();\n      expect(campaign.campaignName).toBe('Newsletter');\n      expect(campaign.totalRecipients).toBe(1000);\n      expect(campaign.status).toBe('draft');\n    });\n\n    it('should get campaign metrics', () => {\n      const created = dashboard.createCampaign('camp-1', 'Test', 500);\n      const retrieved = dashboard.getCampaignMetrics('camp-1');\n\n      expect(retrieved?.campaignName).toBe('Test');\n      expect(retrieved?.totalRecipients).toBe(500);\n    });\n\n    it('should update campaign status', () => {\n      dashboard.createCampaign('camp-1', 'Test', 500);\n      const updated = dashboard.updateCampaignStatus('camp-1', 'running');\n\n      expect(updated).toBe(true);\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.status).toBe('running');\n    });\n  });\n\n  describe('Recipient Events', () => {\n    it('should record sent event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      const recorded = dashboard.recordRecipientEvent(\n        'camp-1',\n        'user-1',\n        'user@example.com',\n        'sent'\n      );\n\n      expect(recorded).toBe(true);\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.sent).toBe(1);\n    });\n\n    it('should record delivered event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'delivered');\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.delivered).toBe(1);\n    });\n\n    it('should record opened event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'delivered');\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'opened');\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.opened).toBe(1);\n    });\n\n    it('should record clicked event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'clicked');\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.clicked).toBe(1);\n    });\n\n    it('should record converted event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'converted');\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.converted).toBe(1);\n    });\n\n    it('should record failed event', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'failed', {\n        reason: 'Invalid email',\n      });\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.failed).toBe(1);\n    });\n  });\n\n  describe('Metrics Calculation', () => {\n    it('should calculate delivery rate', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      for (let i = 0; i < 10; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'sent');\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'delivered');\n      }\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.deliveryRate).toBe(100);\n    });\n\n    it('should calculate open rate', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      for (let i = 0; i < 10; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'sent');\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'delivered');\n      }\n      for (let i = 0; i < 5; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'opened');\n      }\n\n      const campaign = dashboard.getCampaignMetrics('camp-1');\n      expect(campaign?.openRate).toBe(50);\n    });\n  });\n\n  describe('Recipient Status', () => {\n    it('should get recipient status', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n\n      const status = dashboard.getRecipientStatus('camp-1', 'user-1');\n      expect(status?.status).toBe('sent');\n      expect(status?.email).toBe('user@example.com');\n    });\n\n    it('should get all recipient statuses', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      for (let i = 0; i < 5; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'sent');\n      }\n\n      const statuses = dashboard.getRecipientStatuses('camp-1');\n      expect(statuses.length).toBe(5);\n    });\n\n    it('should filter recipient statuses', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      for (let i = 0; i < 5; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'sent');\n      }\n      for (let i = 5; i < 8; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'delivered');\n      }\n\n      const sent = dashboard.getRecipientStatuses('camp-1', { status: 'sent' });\n      expect(sent.length).toBe(5);\n    });\n  });\n\n  describe('Campaign Comparison', () => {\n    it('should compare campaigns', () => {\n      dashboard.createCampaign('camp-1', 'Campaign 1', 100);\n      dashboard.createCampaign('camp-2', 'Campaign 2', 100);\n\n      for (let i = 0; i < 10; i++) {\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'sent');\n        dashboard.recordRecipientEvent('camp-1', `user-${i}`, `user${i}@example.com`, 'delivered');\n      }\n\n      const comparison = dashboard.compareCampaigns(['camp-1', 'camp-2']);\n      expect(comparison.length).toBe(2);\n      expect(comparison[0].campaignName).toBe('Campaign 1');\n    });\n  });\n\n  describe('Snapshots', () => {\n    it('should capture snapshot', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n\n      const snapshot = dashboard.getLatestSnapshot();\n      expect(snapshot).toBeDefined();\n    });\n\n    it('should get snapshots', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      const snapshots = dashboard.getSnapshots();\n      expect(Array.isArray(snapshots)).toBe(true);\n    });\n  });\n\n  describe('Campaign Summary', () => {\n    it('should get campaign summary', () => {\n      dashboard.createCampaign('camp-1', 'Test', 100);\n      dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n      dashboard.recordRecipientEvent('camp-1', 'user-2', 'user2@example.com', 'delivered');\n\n      const summary = dashboard.getCampaignSummary('camp-1');\n      expect(summary).toBeDefined();\n      expect(summary?.campaign.campaignName).toBe('Test');\n    });\n  });\n});\n\ndescribe('TemplateCustomizationBuilder', () => {\n  let builder: TemplateCustomizationBuilder;\n\n  beforeEach(() => {\n    builder = new TemplateCustomizationBuilder();\n  });\n\n  afterEach(() => {\n    builder.destroy();\n  });\n\n  describe('Template Management', () => {\n    it('should create template', () => {\n      const template = builder.createTemplate('Custom Template', 'base-1');\n\n      expect(template).toBeDefined();\n      expect(template.name).toBe('Custom Template');\n      expect(template.baseTemplateId).toBe('base-1');\n    });\n\n    it('should get template', () => {\n      const created = builder.createTemplate('Test', 'base-1');\n      const retrieved = builder.getTemplate(created.id);\n\n      expect(retrieved?.name).toBe('Test');\n    });\n\n    it('should duplicate template', () => {\n      const original = builder.createTemplate('Original', 'base-1');\n      const duplicate = builder.duplicateTemplate(original.id, 'Duplicate');\n\n      expect(duplicate?.name).toBe('Duplicate');\n      expect(duplicate?.baseTemplateId).toBe(original.baseTemplateId);\n    });\n\n    it('should delete template', () => {\n      const template = builder.createTemplate('ToDelete', 'base-1');\n      const deleted = builder.deleteTemplate(template.id);\n\n      expect(deleted).toBe(true);\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved).toBeUndefined();\n    });\n  });\n\n  describe('Block Management', () => {\n    it('should add block', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const block = {\n        id: 'block-1',\n        type: 'text' as const,\n        order: 0,\n        content: 'Hello',\n      };\n\n      const added = builder.addBlock(template.id, block);\n      expect(added).toBe(true);\n\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved?.blocks.length).toBe(1);\n    });\n\n    it('should update block', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const block = {\n        id: 'block-1',\n        type: 'text' as const,\n        order: 0,\n        content: 'Original',\n      };\n\n      builder.addBlock(template.id, block);\n      const updated = builder.updateBlock(template.id, 'block-1', { content: 'Updated' });\n\n      expect(updated).toBe(true);\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved?.blocks[0].content).toBe('Updated');\n    });\n\n    it('should remove block', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const block = {\n        id: 'block-1',\n        type: 'text' as const,\n        order: 0,\n        content: 'Hello',\n      };\n\n      builder.addBlock(template.id, block);\n      const removed = builder.removeBlock(template.id, 'block-1');\n\n      expect(removed).toBe(true);\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved?.blocks.length).toBe(0);\n    });\n\n    it('should reorder blocks', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const block1 = { id: 'block-1', type: 'text' as const, order: 0, content: 'First' };\n      const block2 = { id: 'block-2', type: 'text' as const, order: 1, content: 'Second' };\n\n      builder.addBlock(template.id, block1);\n      builder.addBlock(template.id, block2);\n      const reordered = builder.reorderBlocks(template.id, ['block-2', 'block-1']);\n\n      expect(reordered).toBe(true);\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved?.blocks[0].id).toBe('block-2');\n    });\n  });\n\n  describe('Variables', () => {\n    it('should add variable', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const added = builder.addVariable(template.id, 'firstName', 'John');\n\n      expect(added).toBe(true);\n      const variables = builder.getVariables(template.id);\n      expect(variables.firstName).toBe('John');\n    });\n  });\n\n  describe('Variants', () => {\n    it('should create variant', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const variant = builder.createVariant(template.id, 'Variant A', 50);\n\n      expect(variant).toBeDefined();\n      expect(variant?.name).toBe('Variant A');\n      expect(variant?.testWeight).toBe(50);\n    });\n\n    it('should get variant', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const created = builder.createVariant(template.id, 'Variant A');\n\n      if (created) {\n        const retrieved = builder.getVariant(created.id);\n        expect(retrieved?.name).toBe('Variant A');\n      }\n    });\n\n    it('should get variants for template', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      builder.createVariant(template.id, 'Variant A');\n      builder.createVariant(template.id, 'Variant B');\n\n      const variants = builder.getVariants(template.id);\n      expect(variants.length).toBe(2);\n    });\n\n    it('should record variant performance', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const variant = builder.createVariant(template.id, 'Variant A');\n\n      if (variant) {\n        const recorded = builder.recordVariantPerformance(variant.id, 100, 50, 10);\n        expect(recorded).toBe(true);\n\n        const retrieved = builder.getVariant(variant.id);\n        expect(retrieved?.performanceMetrics?.opens).toBe(100);\n      }\n    });\n  });\n\n  describe('Block Presets', () => {\n    it('should get block presets', () => {\n      const presets = builder.getBlockPresets();\n      expect(presets.length).toBeGreaterThan(0);\n    });\n\n    it('should get presets by category', () => {\n      const presets = builder.getBlockPresets('common');\n      expect(presets.length).toBeGreaterThan(0);\n    });\n\n    it('should add block from preset', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const presets = builder.getBlockPresets();\n      const preset = presets[0];\n\n      const added = builder.addBlockFromPreset(template.id, preset.id);\n      expect(added).toBe(true);\n\n      const retrieved = builder.getTemplate(template.id);\n      expect(retrieved?.blocks.length).toBe(1);\n    });\n  });\n\n  describe('HTML Generation', () => {\n    it('should generate HTML preview', () => {\n      const template = builder.createTemplate('Test', 'base-1');\n      const block = {\n        id: 'block-1',\n        type: 'text' as const,\n        order: 0,\n        content: 'Hello {{firstName}}',\n      };\n\n      builder.addBlock(template.id, block);\n      const html = builder.generateHtmlPreview(template.id, { firstName: 'John' });\n\n      expect(html).toContain('Hello John');\n      expect(html).toContain('<html>');\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let dashboard: CampaignPerformanceDashboard;\n  let builder: TemplateCustomizationBuilder;\n\n  beforeEach(() => {\n    dashboard = new CampaignPerformanceDashboard();\n    builder = new TemplateCustomizationBuilder();\n  });\n\n  afterEach(() => {\n    dashboard.destroy();\n    builder.destroy();\n  });\n\n  it('should integrate dashboard with template builder', () => {\n    // Create template\n    const template = builder.createTemplate('Campaign Template', 'base-1');\n    const block = {\n      id: 'block-1',\n      type: 'text' as const,\n      order: 0,\n      content: 'Welcome {{firstName}}',\n    };\n    builder.addBlock(template.id, block);\n\n    // Create campaign\n    const campaign = dashboard.createCampaign('camp-1', 'Test Campaign', 100);\n\n    // Record events\n    dashboard.recordRecipientEvent('camp-1', 'user-1', 'user@example.com', 'sent');\n\n    // Verify\n    expect(template).toBeDefined();\n    expect(campaign).toBeDefined();\n    expect(campaign.sent).toBe(1);\n  });\n\n  it('should use template variants in campaign', () => {\n    const template = builder.createTemplate('Test', 'base-1');\n    const variant = builder.createVariant(template.id, 'Variant A');\n\n    const campaign = dashboard.createCampaign('camp-1', 'Test', 100);\n\n    expect(variant).toBeDefined();\n    expect(campaign).toBeDefined();\n  });\n});\n
