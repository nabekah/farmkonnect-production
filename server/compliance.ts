import { EventEmitter } from 'events';\n\nexport type CertificationType = 'organic' | 'fair_trade' | 'gmo_free' | 'rainforest_alliance' | 'iso' | 'other';\nexport type ComplianceStatus = 'compliant' | 'non_compliant' | 'pending_review' | 'expired';\n\nexport interface Certification {\n  id: string;\n  farmId: string;\n  type: CertificationType;\n  name: string;\n  issuer: string;\n  issueDate: number;\n  expiryDate: number;\n  certificateNumber: string;\n  scope: string; // e.g., \"Wheat, Corn\"\n  status: ComplianceStatus;\n  documentUrl?: string;\n  notes: string;\n}\n\nexport interface ComplianceRequirement {\n  id: string;\n  farmId: string;\n  category: string; // e.g., \"Pesticide Use\", \"Water Management\"\n  description: string;\n  requirement: string;\n  regulatoryBody: string; // e.g., \"EPA\", \"USDA\"\n  dueDate: number;\n  status: ComplianceStatus;\n  priority: 'low' | 'medium' | 'high' | 'critical';\n  notes: string;\n}\n\nexport interface AuditTrail {\n  id: string;\n  farmId: string;\n  action: string;\n  actor: string; // User or system\n  timestamp: number;\n  details: Record<string, any>;\n  severity: 'info' | 'warning' | 'error';\n}\n\nexport interface ComplianceCheckpoint {\n  id: string;\n  farmId: string;\n  date: number;\n  checklistItems: {\n    id: string;\n    description: string;\n    completed: boolean;\n    notes: string;\n  }[];\n  overallStatus: ComplianceStatus;\n  nextCheckDate: number;\n  auditorName: string;\n}\n\nexport interface ComplianceReport {\n  id: string;\n  farmId: string;\n  generatedAt: number;\n  period: { start: number; end: number };\n  certifications: Certification[];\n  requirements: ComplianceRequirement[];\n  checkpoints: ComplianceCheckpoint[];\n  auditTrailCount: number;\n  overallCompliance: number; // percentage\n  issues: string[];\n  recommendations: string[];\n}\n\n/**\n * Compliance & Certifications System\n */\nexport class ComplianceManager extends EventEmitter {\n  private certifications: Map<string, Certification> = new Map();\n  private requirements: Map<string, ComplianceRequirement> = new Map();\n  private auditTrails: Map<string, AuditTrail> = new Map();\n  private checkpoints: Map<string, ComplianceCheckpoint> = new Map();\n  private reports: Map<string, ComplianceReport> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Add certification\n   */\n  addCertification(\n    farmId: string,\n    type: CertificationType,\n    name: string,\n    issuer: string,\n    issueDate: number,\n    expiryDate: number,\n    certificateNumber: string,\n    scope: string,\n    documentUrl?: string,\n    notes: string = ''\n  ): Certification {\n    const certId = `cert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const now = Date.now();\n    let status: ComplianceStatus = 'compliant';\n\n    if (expiryDate < now) {\n      status = 'expired';\n    }\n\n    const cert: Certification = {\n      id: certId,\n      farmId,\n      type,\n      name,\n      issuer,\n      issueDate,\n      expiryDate,\n      certificateNumber,\n      scope,\n      status,\n      documentUrl,\n      notes,\n    };\n\n    this.certifications.set(certId, cert);\n    this.recordAuditTrail(farmId, `Added certification: ${name}`, 'system', { certId }, 'info');\n    this.emit('certification:added', { certId, farmId, type });\n    return cert;\n  }\n\n  /**\n   * Get certifications\n   */\n  getCertifications(farmId: string): Certification[] {\n    return Array.from(this.certifications.values()).filter((c) => c.farmId === farmId);\n  }\n\n  /**\n   * Get certification by ID\n   */\n  getCertification(certId: string): Certification | null {\n    return this.certifications.get(certId) || null;\n  }\n\n  /**\n   * Check expiring certifications\n   */\n  getExpiringCertifications(farmId: string, daysUntilExpiry: number = 90): Certification[] {\n    const cutoffDate = Date.now() + daysUntilExpiry * 86400000;\n    return this.getCertifications(farmId).filter(\n      (c) => c.expiryDate <= cutoffDate && c.expiryDate > Date.now() && c.status !== 'expired'\n    );\n  }\n\n  /**\n   * Add compliance requirement\n   */\n  addComplianceRequirement(\n    farmId: string,\n    category: string,\n    description: string,\n    requirement: string,\n    regulatoryBody: string,\n    dueDate: number,\n    priority: 'low' | 'medium' | 'high' | 'critical' = 'medium',\n    notes: string = ''\n  ): ComplianceRequirement {\n    const reqId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const status: ComplianceStatus = dueDate < Date.now() ? 'non_compliant' : 'pending_review';\n\n    const req: ComplianceRequirement = {\n      id: reqId,\n      farmId,\n      category,\n      description,\n      requirement,\n      regulatoryBody,\n      dueDate,\n      status,\n      priority,\n      notes,\n    };\n\n    this.requirements.set(reqId, req);\n    this.recordAuditTrail(farmId, `Added compliance requirement: ${category}`, 'system', { reqId }, 'info');\n    this.emit('requirement:added', { reqId, farmId, category });\n    return req;\n  }\n\n  /**\n   * Get compliance requirements\n   */\n  getComplianceRequirements(farmId: string, status?: ComplianceStatus): ComplianceRequirement[] {\n    let reqs = Array.from(this.requirements.values()).filter((r) => r.farmId === farmId);\n    if (status) {\n      reqs = reqs.filter((r) => r.status === status);\n    }\n    return reqs.sort((a, b) => a.dueDate - b.dueDate);\n  }\n\n  /**\n   * Update requirement status\n   */\n  updateRequirementStatus(\n    reqId: string,\n    status: ComplianceStatus,\n    notes?: string\n  ): ComplianceRequirement | null {\n    const req = this.requirements.get(reqId);\n    if (!req) return null;\n\n    req.status = status;\n    if (notes) req.notes = notes;\n\n    this.recordAuditTrail(req.farmId, `Updated requirement status: ${status}`, 'system', { reqId }, 'info');\n    this.emit('requirement:updated', { reqId, status });\n    return req;\n  }\n\n  /**\n   * Record audit trail\n   */\n  recordAuditTrail(\n    farmId: string,\n    action: string,\n    actor: string,\n    details: Record<string, any> = {},\n    severity: 'info' | 'warning' | 'error' = 'info'\n  ): AuditTrail {\n    const trailId = `trail_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const trail: AuditTrail = {\n      id: trailId,\n      farmId,\n      action,\n      actor,\n      timestamp: Date.now(),\n      details,\n      severity,\n    };\n\n    this.auditTrails.set(trailId, trail);\n    this.emit('audit:recorded', { trailId, farmId, severity });\n    return trail;\n  }\n\n  /**\n   * Get audit trail\n   */\n  getAuditTrail(farmId: string, startDate?: number, endDate?: number): AuditTrail[] {\n    let trails = Array.from(this.auditTrails.values()).filter((t) => t.farmId === farmId);\n\n    if (startDate && endDate) {\n      trails = trails.filter((t) => t.timestamp >= startDate && t.timestamp <= endDate);\n    }\n\n    return trails.sort((a, b) => b.timestamp - a.timestamp);\n  }\n\n  /**\n   * Create compliance checkpoint\n   */\n  createComplianceCheckpoint(\n    farmId: string,\n    checklistItems: { description: string; completed: boolean; notes?: string }[],\n    auditorName: string,\n    nextCheckDate: number\n  ): ComplianceCheckpoint {\n    const checkpointId = `checkpoint_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const completedCount = checklistItems.filter((item) => item.completed).length;\n    const overallStatus =\n      completedCount === checklistItems.length\n        ? 'compliant'\n        : completedCount === 0\n          ? 'non_compliant'\n          : 'pending_review';\n\n    const checkpoint: ComplianceCheckpoint = {\n      id: checkpointId,\n      farmId,\n      date: Date.now(),\n      checklistItems: checklistItems.map((item, idx) => ({\n        id: `item_${idx}`,\n        description: item.description,\n        completed: item.completed,\n        notes: item.notes || '',\n      })),\n      overallStatus,\n      nextCheckDate,\n      auditorName,\n    };\n\n    this.checkpoints.set(checkpointId, checkpoint);\n    this.recordAuditTrail(\n      farmId,\n      `Compliance checkpoint created: ${overallStatus}`,\n      auditorName,\n      { checkpointId },\n      'info'\n    );\n    this.emit('checkpoint:created', { checkpointId, farmId, overallStatus });\n    return checkpoint;\n  }\n\n  /**\n   * Get compliance checkpoints\n   */\n  getComplianceCheckpoints(farmId: string): ComplianceCheckpoint[] {\n    return Array.from(this.checkpoints.values())\n      .filter((c) => c.farmId === farmId)\n      .sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Calculate overall compliance\n   */\n  calculateOverallCompliance(farmId: string): number {\n    const certs = this.getCertifications(farmId);\n    const reqs = this.getComplianceRequirements(farmId);\n    const checkpoints = this.getComplianceCheckpoints(farmId);\n\n    let complianceScore = 0;\n    let totalItems = 0;\n\n    // Certifications (40% weight)\n    if (certs.length > 0) {\n      const certCompliance = certs.filter((c) => c.status === 'compliant').length;\n      complianceScore += (certCompliance / certs.length) * 40;\n      totalItems += 40;\n    }\n\n    // Requirements (40% weight)\n    if (reqs.length > 0) {\n      const reqCompliance = reqs.filter((r) => r.status === 'compliant').length;\n      complianceScore += (reqCompliance / reqs.length) * 40;\n      totalItems += 40;\n    }\n\n    // Checkpoints (20% weight)\n    if (checkpoints.length > 0) {\n      const latestCheckpoint = checkpoints[0];\n      const checkpointScore =\n        latestCheckpoint.overallStatus === 'compliant'\n          ? 20\n          : latestCheckpoint.overallStatus === 'pending_review'\n            ? 10\n            : 0;\n      complianceScore += checkpointScore;\n      totalItems += 20;\n    }\n\n    return totalItems > 0 ? Math.round((complianceScore / totalItems) * 100) : 0;\n  }\n\n  /**\n   * Generate compliance report\n   */\n  generateComplianceReport(\n    farmId: string,\n    startDate: number,\n    endDate: number\n  ): ComplianceReport {\n    const reportId = `report_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const certifications = this.getCertifications(farmId);\n    const requirements = this.getComplianceRequirements(farmId);\n    const checkpoints = this.getComplianceCheckpoints(farmId);\n    const auditTrail = this.getAuditTrail(farmId, startDate, endDate);\n\n    const issues: string[] = [];\n    const recommendations: string[] = [];\n\n    // Check for expired certifications\n    const expiredCerts = certifications.filter((c) => c.status === 'expired');\n    if (expiredCerts.length > 0) {\n      issues.push(`${expiredCerts.length} certification(s) expired`);\n      recommendations.push('Renew expired certifications immediately');\n    }\n\n    // Check for expiring certifications\n    const expiringCerts = this.getExpiringCertifications(farmId, 90);\n    if (expiringCerts.length > 0) {\n      issues.push(`${expiringCerts.length} certification(s) expiring within 90 days`);\n      recommendations.push('Schedule certification renewals');\n    }\n\n    // Check for non-compliant requirements\n    const nonCompliantReqs = requirements.filter((r) => r.status === 'non_compliant');\n    if (nonCompliantReqs.length > 0) {\n      issues.push(`${nonCompliantReqs.length} non-compliant requirement(s)`);\n      recommendations.push('Address non-compliant requirements urgently');\n    }\n\n    const overallCompliance = this.calculateOverallCompliance(farmId);\n\n    const report: ComplianceReport = {\n      id: reportId,\n      farmId,\n      generatedAt: Date.now(),\n      period: { start: startDate, end: endDate },\n      certifications,\n      requirements,\n      checkpoints,\n      auditTrailCount: auditTrail.length,\n      overallCompliance,\n      issues,\n      recommendations,\n    };\n\n    this.reports.set(reportId, report);\n    this.recordAuditTrail(farmId, 'Compliance report generated', 'system', { reportId }, 'info');\n    this.emit('report:generated', { reportId, farmId, overallCompliance });\n    return report;\n  }\n\n  /**\n   * Get compliance report\n   */\n  getComplianceReport(reportId: string): ComplianceReport | null {\n    return this.reports.get(reportId) || null;\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalCertifications: number;\n    totalRequirements: number;\n    totalAuditTrails: number;\n    totalCheckpoints: number;\n    totalReports: number;\n  } {\n    return {\n      totalCertifications: this.certifications.size,\n      totalRequirements: this.requirements.size,\n      totalAuditTrails: this.auditTrails.size,\n      totalCheckpoints: this.checkpoints.size,\n      totalReports: this.reports.size,\n    };\n  }\n}\n
