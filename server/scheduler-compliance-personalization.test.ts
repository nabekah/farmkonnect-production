import { describe, it, expect, beforeEach, afterEach } from 'vitest';\nimport SmartNotificationScheduler from './smart-scheduler';\nimport CompliancePrivacyManager from './compliance-privacy';\nimport NotificationPersonalizationEngine from './personalization-engine';\n\ndescribe('SmartNotificationScheduler', () => {\n  let scheduler: SmartNotificationScheduler;\n\n  beforeEach(() => {\n    scheduler = new SmartNotificationScheduler();\n  });\n\n  afterEach(() => {\n    scheduler.destroy();\n  });\n\n  describe('Engagement Pattern Recording', () => {\n    it('should record engagement events', () => {\n      scheduler.recordEngagementEvent('user-1', 9, 0.8);\n      scheduler.recordEngagementEvent('user-1', 14, 0.6);\n      scheduler.recordEngagementEvent('user-1', 20, 0.9);\n\n      const pattern = scheduler.getEngagementPattern('user-1');\n      expect(pattern).toBeDefined();\n      expect(pattern?.optimalHour).toBe(20);\n    });\n\n    it('should identify peak hours', () => {\n      for (let i = 0; i < 10; i++) {\n        scheduler.recordEngagementEvent('user-1', 9, 0.9);\n        scheduler.recordEngagementEvent('user-1', 14, 0.3);\n      }\n\n      const pattern = scheduler.getEngagementPattern('user-1');\n      expect(pattern?.peakHours).toContain(9);\n    });\n  });\n\n  describe('Notification Scheduling', () => {\n    it('should schedule notification with optimal_time strategy', () => {\n      scheduler.recordEngagementEvent('user-1', 10, 0.9);\n      const scheduled = scheduler.scheduleNotification(\n        'notif-1',\n        'user-1',\n        'optimal_time',\n        'engagement_score'\n      );\n\n      expect(scheduled).toBeDefined();\n      expect(scheduled.strategy).toBe('optimal_time');\n      expect(scheduled.status).toBe('scheduled');\n    });\n\n    it('should schedule with timezone_aware strategy', () => {\n      const scheduled = scheduler.scheduleNotification(\n        'notif-2',\n        'user-1',\n        'timezone_aware',\n        'open_rate',\n        { timezone: 'PST' }\n      );\n\n      expect(scheduled.metadata?.timezone).toBe('PST');\n    });\n\n    it('should schedule with engagement_based strategy', () => {\n      scheduler.recordEngagementEvent('user-1', 15, 0.85);\n      const scheduled = scheduler.scheduleNotification(\n        'notif-3',\n        'user-1',\n        'engagement_based',\n        'click_rate'\n      );\n\n      expect(scheduled.strategy).toBe('engagement_based');\n    });\n\n    it('should schedule with batch strategy', () => {\n      const scheduled = scheduler.scheduleNotification(\n        'notif-4',\n        'user-1',\n        'batch',\n        'conversion_rate',\n        { minDelay: 5 * 60 * 1000, maxDelay: 60 * 60 * 1000 }\n      );\n\n      expect(scheduled.scheduledTime).toBeGreaterThan(Date.now());\n    });\n\n    it('should schedule with immediate strategy', () => {\n      const scheduled = scheduler.scheduleNotification(\n        'notif-5',\n        'user-1',\n        'immediate',\n        'engagement_score'\n      );\n\n      expect(scheduled.scheduledTime).toBeLessThanOrEqual(Date.now() + 1000);\n    });\n  });\n\n  describe('Optimal Time Prediction', () => {\n    beforeEach(() => {\n      for (let i = 0; i < 20; i++) {\n        scheduler.recordEngagementEvent('user-1', 9, 0.9);\n        scheduler.recordEngagementEvent('user-1', 14, 0.5);\n        scheduler.recordEngagementEvent('user-1', 20, 0.7);\n      }\n    });\n\n    it('should predict optimal time slots', () => {\n      const predictions = scheduler.predictOptimalTimeSlot('user-1');\n\n      expect(predictions.length).toBeGreaterThan(0);\n      expect(predictions[0].recommendedSend).toBe(true);\n    });\n\n    it('should calculate confidence scores', () => {\n      const predictions = scheduler.predictOptimalTimeSlot('user-1');\n\n      for (const prediction of predictions) {\n        expect(prediction.confidence).toBeGreaterThanOrEqual(0);\n        expect(prediction.confidence).toBeLessThanOrEqual(1);\n      }\n    });\n  });\n\n  describe('Queue Management', () => {\n    it('should track queue status', () => {\n      scheduler.scheduleNotification('notif-1', 'user-1', 'immediate', 'engagement_score');\n      scheduler.scheduleNotification('notif-2', 'user-1', 'batch', 'open_rate');\n\n      const status = scheduler.getQueueStatus();\n      expect(status.queueLength).toBeGreaterThan(0);\n    });\n\n    it('should cancel scheduled notification', () => {\n      const scheduled = scheduler.scheduleNotification(\n        'notif-1',\n        'user-1',\n        'batch',\n        'engagement_score'\n      );\n\n      const cancelled = scheduler.cancelScheduled(scheduled.id);\n      expect(cancelled).toBe(true);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should track statistics', () => {\n      scheduler.scheduleNotification('notif-1', 'user-1', 'optimal_time', 'engagement_score');\n      scheduler.scheduleNotification('notif-2', 'user-2', 'timezone_aware', 'open_rate');\n\n      const stats = scheduler.getStatistics();\n      expect(stats.totalScheduled).toBe(2);\n    });\n  });\n});\n\ndescribe('CompliancePrivacyManager', () => {\n  let manager: CompliancePrivacyManager;\n\n  beforeEach(() => {\n    manager = new CompliancePrivacyManager();\n  });\n\n  afterEach(() => {\n    manager.destroy();\n  });\n\n  describe('Consent Management', () => {\n    it('should request consent', () => {\n      const consent = manager.requestConsent('user-1', 'marketing');\n\n      expect(consent).toBeDefined();\n      expect(consent.granted).toBe(false);\n    });\n\n    it('should grant consent', () => {\n      manager.requestConsent('user-1', 'marketing');\n      const granted = manager.grantConsent('user-1', 'marketing');\n\n      expect(granted).toBe(true);\n      expect(manager.hasConsent('user-1', 'marketing')).toBe(true);\n    });\n\n    it('should revoke consent', () => {\n      manager.requestConsent('user-1', 'marketing');\n      manager.grantConsent('user-1', 'marketing');\n      const revoked = manager.revokeConsent('user-1', 'marketing');\n\n      expect(revoked).toBe(true);\n      expect(manager.hasConsent('user-1', 'marketing')).toBe(false);\n    });\n\n    it('should handle multiple consent types', () => {\n      manager.requestConsent('user-1', 'marketing');\n      manager.requestConsent('user-1', 'analytics');\n      manager.grantConsent('user-1', 'marketing');\n\n      expect(manager.hasConsent('user-1', 'marketing')).toBe(true);\n      expect(manager.hasConsent('user-1', 'analytics')).toBe(false);\n    });\n  });\n\n  describe('Data Management', () => {\n    it('should store user data', () => {\n      const record = manager.storeUserData('user-1', 'email', 'user@example.com', '90_days');\n\n      expect(record).toBeDefined();\n      expect(record.dataType).toBe('email');\n    });\n\n    it('should export user data', () => {\n      manager.storeUserData('user-1', 'email', 'user@example.com', '90_days');\n      manager.storeUserData('user-1', 'phone', '555-1234', '90_days');\n\n      const json = manager.exportUserData('user-1', 'json');\n      expect(json).toContain('email');\n      expect(json).toContain('phone');\n    });\n\n    it('should delete user data', () => {\n      manager.storeUserData('user-1', 'email', 'user@example.com', '90_days');\n      manager.storeUserData('user-1', 'phone', '555-1234', '90_days');\n\n      const deleted = manager.deleteUserData('user-1', 'email');\n      expect(deleted).toBe(1);\n    });\n\n    it('should delete all user data', () => {\n      manager.storeUserData('user-1', 'email', 'user@example.com', '90_days');\n      manager.storeUserData('user-1', 'phone', '555-1234', '90_days');\n\n      const deleted = manager.deleteUserData('user-1');\n      expect(deleted).toBe(2);\n    });\n  });\n\n  describe('Retention Policies', () => {\n    it('should set retention policy', () => {\n      const policy = manager.setRetentionPolicy('email', '90_days');\n\n      expect(policy).toBeDefined();\n      expect(policy.policy).toBe('90_days');\n    });\n\n    it('should get retention policy', () => {\n      manager.setRetentionPolicy('email', '30_days');\n      const policy = manager.getRetentionPolicy('email');\n\n      expect(policy?.policy).toBe('30_days');\n    });\n  });\n\n  describe('Privacy Policies', () => {\n    it('should publish privacy policy', () => {\n      const policy = manager.publishPrivacyPolicy(\n        'GDPR',\n        '1.0',\n        'GDPR Privacy Policy Content',\n        'admin'\n      );\n\n      expect(policy).toBeDefined();\n      expect(policy.framework).toBe('GDPR');\n    });\n\n    it('should get privacy policy', () => {\n      manager.publishPrivacyPolicy('GDPR', '1.0', 'Content', 'admin');\n      const policy = manager.getPrivacyPolicy('GDPR');\n\n      expect(policy?.version).toBe('1.0');\n    });\n  });\n\n  describe('Audit Logging', () => {\n    it('should log audit actions', () => {\n      manager.requestConsent('user-1', 'marketing');\n      manager.grantConsent('user-1', 'marketing');\n\n      const logs = manager.getAuditLogs('user-1');\n      expect(logs.length).toBeGreaterThan(0);\n    });\n\n    it('should filter audit logs by action', () => {\n      manager.requestConsent('user-1', 'marketing');\n      manager.grantConsent('user-1', 'marketing');\n\n      const logs = manager.getAuditLogs('user-1', 'consent_update');\n      expect(logs.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should track statistics', () => {\n      manager.requestConsent('user-1', 'marketing');\n      manager.grantConsent('user-1', 'marketing');\n      manager.storeUserData('user-1', 'email', 'user@example.com', '90_days');\n\n      const stats = manager.getStatistics();\n      expect(stats.totalUsers).toBeGreaterThan(0);\n      expect(stats.dataRecordsStored).toBeGreaterThan(0);\n    });\n  });\n});\n\ndescribe('NotificationPersonalizationEngine', () => {\n  let engine: NotificationPersonalizationEngine;\n\n  beforeEach(() => {\n    engine = new NotificationPersonalizationEngine();\n  });\n\n  describe('User Profiles', () => {\n    it('should create user profile', () => {\n      const profile = engine.createUserProfile('user-1', {\n        name: 'John Doe',\n        location: 'New York',\n        interests: ['farming', 'technology'],\n      });\n\n      expect(profile).toBeDefined();\n      expect(profile.name).toBe('John Doe');\n      expect(profile.interests).toContain('farming');\n    });\n\n    it('should update user profile', () => {\n      engine.createUserProfile('user-1', { name: 'John' });\n      const updated = engine.updateUserProfile('user-1', {\n        interests: ['farming', 'sustainability'],\n      });\n\n      expect(updated).toBe(true);\n      const profile = engine.getUserProfile('user-1');\n      expect(profile?.interests).toContain('sustainability');\n    });\n  });\n\n  describe('Behavior Tracking', () => {\n    it('should record user behavior', () => {\n      engine.createUserProfile('user-1');\n      engine.recordBehavior('user-1', 'viewed_product', { productId: '123' });\n\n      const profile = engine.getUserProfile('user-1');\n      expect(profile?.behaviorHistory.length).toBe(1);\n    });\n\n    it('should record purchase', () => {\n      engine.createUserProfile('user-1');\n      engine.recordPurchase('user-1', 'fertilizer', 49.99);\n\n      const profile = engine.getUserProfile('user-1');\n      expect(profile?.purchaseHistory.length).toBe(1);\n      expect(profile?.purchaseHistory[0].amount).toBe(49.99);\n    });\n\n    it('should update engagement score', () => {\n      engine.createUserProfile('user-1', { interests: ['farming', 'tech'] });\n      engine.recordBehavior('user-1', 'clicked', {});\n      engine.recordPurchase('user-1', 'seeds', 29.99);\n\n      const profile = engine.getUserProfile('user-1');\n      expect(profile?.engagementScore).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Personalization Templates', () => {\n    it('should create template', () => {\n      const template = engine.createTemplate(\n        'Welcome Template',\n        'Hello {{name}}, welcome to our platform!',\n        'behavioral',\n        {\n          variables: [{ name: 'name', type: 'name', defaultValue: 'User' }],\n        }\n      );\n\n      expect(template).toBeDefined();\n      expect(template.name).toBe('Welcome Template');\n    });\n\n    it('should get template', () => {\n      const created = engine.createTemplate(\n        'Test',\n        'Content',\n        'demographic'\n      );\n      const retrieved = engine.getTemplate(created.id);\n\n      expect(retrieved?.name).toBe('Test');\n    });\n  });\n\n  describe('Content Personalization', () => {\n    it('should personalize content', () => {\n      engine.createUserProfile('user-1', { name: 'Alice' });\n      const template = engine.createTemplate(\n        'Greeting',\n        'Hello {{name}}!',\n        'demographic',\n        {\n          variables: [{ name: 'name', type: 'name', defaultValue: 'Friend' }],\n        }\n      );\n\n      const personalized = engine.personalizeContent('user-1', template.id);\n      expect(personalized?.content).toContain('Alice');\n    });\n\n    it('should apply multiple variables', () => {\n      engine.createUserProfile('user-1', {\n        name: 'Bob',\n        location: 'California',\n        interests: ['farming', 'sustainability'],\n      });\n\n      const template = engine.createTemplate(\n        'Multi-var',\n        'Hi {{name}} from {{location}}, interested in {{interests}}',\n        'demographic',\n        {\n          variables: [\n            { name: 'name', type: 'name', defaultValue: 'User' },\n            { name: 'location', type: 'location', defaultValue: 'USA' },\n            { name: 'interests', type: 'interests', defaultValue: 'farming' },\n          ],\n        }\n      );\n\n      const personalized = engine.personalizeContent('user-1', template.id);\n      expect(personalized?.content).toContain('Bob');\n      expect(personalized?.content).toContain('California');\n    });\n\n    it('should apply different strategies', () => {\n      engine.createUserProfile('user-1', { interests: ['farming'] });\n      engine.recordBehavior('user-1', 'viewed', {});\n\n      const template = engine.createTemplate(\n        'Test',\n        'Content {{name}}',\n        'behavioral',\n        {\n          variables: [{ name: 'name', type: 'name', defaultValue: 'User' }],\n        }\n      );\n\n      const personalized = engine.personalizeContent('user-1', template.id, 'behavioral');\n      expect(personalized?.appliedStrategy).toBe('behavioral');\n    });\n  });\n\n  describe('Recommendations', () => {\n    it('should generate recommendations', () => {\n      engine.createUserProfile('user-1', { interests: ['farming'] });\n\n      const items = [\n        { id: '1', title: 'Fertilizer', description: 'Organic fertilizer', tags: ['farming'] },\n        { id: '2', title: 'Seeds', description: 'Premium seeds', tags: ['farming', 'organic'] },\n        { id: '3', title: 'Laptop', description: 'Computer', tags: ['tech'] },\n      ];\n\n      const recommendations = engine.generateRecommendations('user-1', items);\n      expect(recommendations.length).toBeGreaterThan(0);\n      expect(recommendations[0].relevanceScore).toBeGreaterThan(0);\n    });\n\n    it('should rank by relevance', () => {\n      engine.createUserProfile('user-1', { interests: ['farming', 'organic'] });\n\n      const items = [\n        { id: '1', title: 'Fertilizer', description: 'Organic', tags: ['farming', 'organic'] },\n        { id: '2', title: 'Tech', description: 'Computer', tags: ['tech'] },\n      ];\n\n      const recommendations = engine.generateRecommendations('user-1', items);\n      expect(recommendations[0].itemId).toBe('1');\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should track statistics', () => {\n      engine.createUserProfile('user-1');\n      engine.createUserProfile('user-2');\n      const template = engine.createTemplate('Test', 'Content', 'behavioral');\n      engine.personalizeContent('user-1', template.id);\n\n      const stats = engine.getStatistics();\n      expect(stats.totalProfiles).toBe(2);\n      expect(stats.totalTemplates).toBe(1);\n      expect(stats.totalPersonalizations).toBe(1);\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let scheduler: SmartNotificationScheduler;\n  let compliance: CompliancePrivacyManager;\n  let personalization: NotificationPersonalizationEngine;\n\n  beforeEach(() => {\n    scheduler = new SmartNotificationScheduler();\n    compliance = new CompliancePrivacyManager();\n    personalization = new NotificationPersonalizationEngine();\n  });\n\n  afterEach(() => {\n    scheduler.destroy();\n    compliance.destroy();\n  });\n\n  it('should integrate scheduler with personalization', () => {\n    // Create profile\n    personalization.createUserProfile('user-1', { name: 'Alice' });\n    personalization.recordBehavior('user-1', 'viewed', {});\n\n    // Record engagement\n    scheduler.recordEngagementEvent('user-1', 10, 0.9);\n\n    // Schedule notification\n    const scheduled = scheduler.scheduleNotification(\n      'notif-1',\n      'user-1',\n      'optimal_time',\n      'engagement_score'\n    );\n\n    expect(scheduled).toBeDefined();\n    expect(personalization.getUserProfile('user-1')).toBeDefined();\n  });\n\n  it('should integrate compliance with personalization', () => {\n    // Request consent\n    compliance.requestConsent('user-1', 'marketing');\n    compliance.grantConsent('user-1', 'marketing');\n\n    // Create profile\n    personalization.createUserProfile('user-1');\n\n    // Store data\n    compliance.storeUserData('user-1', 'preferences', { interests: ['farming'] }, '90_days');\n\n    expect(compliance.hasConsent('user-1', 'marketing')).toBe(true);\n    expect(personalization.getUserProfile('user-1')).toBeDefined();\n  });\n\n  it('should handle full notification workflow', () => {\n    // 1. Check compliance\n    compliance.requestConsent('user-1', 'marketing');\n    compliance.grantConsent('user-1', 'marketing');\n\n    // 2. Create personalized profile\n    personalization.createUserProfile('user-1', { name: 'Bob', interests: ['farming'] });\n\n    // 3. Record engagement\n    scheduler.recordEngagementEvent('user-1', 14, 0.85);\n\n    // 4. Schedule notification\n    const scheduled = scheduler.scheduleNotification(\n      'notif-1',\n      'user-1',\n      'optimal_time',\n      'engagement_score'\n    );\n\n    // 5. Personalize content\n    const template = personalization.createTemplate(\n      'Notification',\n      'Hello {{name}}, check out our new farming tools!',\n      'demographic',\n      {\n        variables: [{ name: 'name', type: 'name', defaultValue: 'Farmer' }],\n      }\n    );\n\n    const personalized = personalization.personalizeContent('user-1', template.id);\n\n    // Verify\n    expect(compliance.hasConsent('user-1', 'marketing')).toBe(true);\n    expect(scheduled.status).toBe('scheduled');\n    expect(personalized?.content).toContain('Bob');\n  });\n});\n
