import { EventEmitter } from 'events';\n\nexport type BudgetCategory = 'labor' | 'equipment' | 'seeds' | 'fertilizer' | 'pesticides' | 'fuel' | 'utilities' | 'other';\nexport type BudgetPeriod = 'monthly' | 'quarterly' | 'annual';\n\nexport interface BudgetAllocation {\n  id: string;\n  farmId: string;\n  category: BudgetCategory;\n  period: BudgetPeriod;\n  allocatedAmount: number;\n  startDate: number;\n  endDate: number;\n  notes: string;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface ActualExpense {\n  id: string;\n  farmId: string;\n  budgetId: string;\n  category: BudgetCategory;\n  amount: number;\n  description: string;\n  date: number;\n  vendor?: string;\n  receiptUrl?: string;\n  createdAt: number;\n}\n\nexport interface BudgetVariance {\n  budgetId: string;\n  category: BudgetCategory;\n  allocatedAmount: number;\n  actualAmount: number;\n  variance: number;\n  variancePercentage: number;\n  status: 'under' | 'on_track' | 'over';\n  remainingBudget: number;\n  projectedFinalAmount: number;\n  daysRemaining: number;\n}\n\nexport interface BudgetAlert {\n  id: string;\n  budgetId: string;\n  farmId: string;\n  category: BudgetCategory;\n  alertType: 'threshold_exceeded' | 'projection_exceeded' | 'near_limit';\n  severity: 'warning' | 'critical';\n  message: string;\n  createdAt: number;\n}\n\n/**\n * Budget vs Actual Tracking System\n */\nexport class BudgetTrackingManager extends EventEmitter {\n  private budgets: Map<string, BudgetAllocation> = new Map();\n  private expenses: Map<string, ActualExpense[]> = new Map();\n  private alerts: Map<string, BudgetAlert[]> = new Map();\n  private thresholdPercentage: number = 80; // Alert at 80% of budget\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Create budget allocation\n   */\n  createBudget(\n    farmId: string,\n    category: BudgetCategory,\n    period: BudgetPeriod,\n    allocatedAmount: number,\n    startDate: number,\n    endDate: number,\n    notes: string = ''\n  ): BudgetAllocation {\n    const budgetId = `budget_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const budget: BudgetAllocation = {\n      id: budgetId,\n      farmId,\n      category,\n      period,\n      allocatedAmount,\n      startDate,\n      endDate,\n      notes,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.budgets.set(budgetId, budget);\n    this.emit('budget:created', { budgetId, farmId, category });\n    return budget;\n  }\n\n  /**\n   * Record actual expense\n   */\n  recordExpense(\n    farmId: string,\n    budgetId: string,\n    category: BudgetCategory,\n    amount: number,\n    description: string,\n    vendor?: string,\n    receiptUrl?: string\n  ): ActualExpense {\n    const expenseId = `expense_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const expense: ActualExpense = {\n      id: expenseId,\n      farmId,\n      budgetId,\n      category,\n      amount,\n      description,\n      date: Date.now(),\n      vendor,\n      receiptUrl,\n      createdAt: Date.now(),\n    };\n\n    if (!this.expenses.has(budgetId)) {\n      this.expenses.set(budgetId, []);\n    }\n    this.expenses.get(budgetId)!.push(expense);\n\n    // Check for budget alerts\n    this.checkBudgetAlerts(budgetId);\n\n    this.emit('expense:recorded', { expenseId, budgetId, amount });\n    return expense;\n  }\n\n  /**\n   * Get budget variance\n   */\n  getBudgetVariance(budgetId: string): BudgetVariance | null {\n    const budget = this.budgets.get(budgetId);\n    if (!budget) return null;\n\n    const expenses = this.expenses.get(budgetId) || [];\n    const actualAmount = expenses.reduce((sum, e) => sum + e.amount, 0);\n    const variance = budget.allocatedAmount - actualAmount;\n    const variancePercentage = (variance / budget.allocatedAmount) * 100;\n\n    let status: 'under' | 'on_track' | 'over' = 'on_track';\n    if (actualAmount > budget.allocatedAmount) {\n      status = 'over';\n    } else if (variancePercentage > 20) {\n      status = 'under';\n    }\n\n    const daysRemaining = Math.max(0, Math.floor((budget.endDate - Date.now()) / (1000 * 60 * 60 * 24)));\n    const daysTotal = Math.floor((budget.endDate - budget.startDate) / (1000 * 60 * 60 * 24));\n    const daysElapsed = daysTotal - daysRemaining;\n    const dailyBudget = budget.allocatedAmount / daysTotal;\n    const projectedFinalAmount = actualAmount + dailyBudget * daysRemaining;\n\n    return {\n      budgetId,\n      category: budget.category,\n      allocatedAmount: budget.allocatedAmount,\n      actualAmount,\n      variance,\n      variancePercentage,\n      status,\n      remainingBudget: Math.max(0, variance),\n      projectedFinalAmount,\n      daysRemaining,\n    };\n  }\n\n  /**\n   * Check budget alerts\n   */\n  private checkBudgetAlerts(budgetId: string): void {\n    const budget = this.budgets.get(budgetId);\n    if (!budget) return;\n\n    const variance = this.getBudgetVariance(budgetId);\n    if (!variance) return;\n\n    const percentageUsed = (variance.actualAmount / budget.allocatedAmount) * 100;\n\n    // Check if threshold exceeded\n    if (percentageUsed >= this.thresholdPercentage && percentageUsed < 100) {\n      this.createAlert(\n        budgetId,\n        budget.farmId,\n        budget.category,\n        'threshold_exceeded',\n        'warning',\n        `${budget.category} spending has reached ${percentageUsed.toFixed(1)}% of budget`\n      );\n    }\n\n    // Check if over budget\n    if (variance.status === 'over') {\n      this.createAlert(\n        budgetId,\n        budget.farmId,\n        budget.category,\n        'projection_exceeded',\n        'critical',\n        `${budget.category} budget exceeded by $${(variance.actualAmount - budget.allocatedAmount).toFixed(2)}`\n      );\n    }\n\n    // Check if projected to exceed\n    if (variance.projectedFinalAmount > budget.allocatedAmount * 1.1) {\n      this.createAlert(\n        budgetId,\n        budget.farmId,\n        budget.category,\n        'projection_exceeded',\n        'warning',\n        `${budget.category} projected to exceed budget by ${((variance.projectedFinalAmount / budget.allocatedAmount - 1) * 100).toFixed(1)}%`\n      );\n    }\n  }\n\n  /**\n   * Create alert\n   */\n  private createAlert(\n    budgetId: string,\n    farmId: string,\n    category: BudgetCategory,\n    alertType: 'threshold_exceeded' | 'projection_exceeded' | 'near_limit',\n    severity: 'warning' | 'critical',\n    message: string\n  ): BudgetAlert {\n    const alertId = `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const alert: BudgetAlert = {\n      id: alertId,\n      budgetId,\n      farmId,\n      category,\n      alertType,\n      severity,\n      message,\n      createdAt: Date.now(),\n    };\n\n    if (!this.alerts.has(budgetId)) {\n      this.alerts.set(budgetId, []);\n    }\n    this.alerts.get(budgetId)!.push(alert);\n\n    this.emit('alert:created', { alertId, budgetId, severity });\n    return alert;\n  }\n\n  /**\n   * Get budget summary\n   */\n  getBudgetSummary(farmId: string, period?: BudgetPeriod): {\n    totalAllocated: number;\n    totalActual: number;\n    totalVariance: number;\n    budgets: BudgetVariance[];\n  } {\n    const farmBudgets = Array.from(this.budgets.values()).filter(\n      (b) => b.farmId === farmId && (!period || b.period === period)\n    );\n\n    const budgetVariances = farmBudgets\n      .map((b) => this.getBudgetVariance(b.id))\n      .filter((v): v is BudgetVariance => v !== null);\n\n    const totalAllocated = budgetVariances.reduce((sum, v) => sum + v.allocatedAmount, 0);\n    const totalActual = budgetVariances.reduce((sum, v) => sum + v.actualAmount, 0);\n    const totalVariance = totalAllocated - totalActual;\n\n    return {\n      totalAllocated,\n      totalActual,\n      totalVariance,\n      budgets: budgetVariances,\n    };\n  }\n\n  /**\n   * Get budget alerts\n   */\n  getBudgetAlerts(budgetId: string): BudgetAlert[] {\n    return this.alerts.get(budgetId) || [];\n  }\n\n  /**\n   * Get farm alerts\n   */\n  getFarmAlerts(farmId: string, severity?: 'warning' | 'critical'): BudgetAlert[] {\n    const allAlerts = Array.from(this.alerts.values()).flat();\n    return allAlerts.filter(\n      (a) => a.farmId === farmId && (!severity || a.severity === severity)\n    );\n  }\n\n  /**\n   * Update budget\n   */\n  updateBudget(budgetId: string, updates: Partial<BudgetAllocation>): BudgetAllocation | null {\n    const budget = this.budgets.get(budgetId);\n    if (!budget) return null;\n\n    const updated = {\n      ...budget,\n      ...updates,\n      updatedAt: Date.now(),\n    };\n\n    this.budgets.set(budgetId, updated);\n    this.emit('budget:updated', { budgetId });\n    return updated;\n  }\n\n  /**\n   * Get expenses for budget\n   */\n  getExpenses(budgetId: string): ActualExpense[] {\n    return this.expenses.get(budgetId) || [];\n  }\n\n  /**\n   * Get expenses by category\n   */\n  getExpensesByCategory(farmId: string, category: BudgetCategory): ActualExpense[] {\n    const allExpenses = Array.from(this.expenses.values()).flat();\n    return allExpenses.filter((e) => e.farmId === farmId && e.category === category);\n  }\n\n  /**\n   * Get budget performance\n   */\n  getBudgetPerformance(farmId: string): {\n    onTrack: number;\n    under: number;\n    over: number;\n    averageVariance: number;\n  } {\n    const summary = this.getBudgetSummary(farmId);\n    const budgets = summary.budgets;\n\n    const onTrack = budgets.filter((b) => b.status === 'on_track').length;\n    const under = budgets.filter((b) => b.status === 'under').length;\n    const over = budgets.filter((b) => b.status === 'over').length;\n    const averageVariance = budgets.length > 0 ? budgets.reduce((sum, b) => sum + b.variancePercentage, 0) / budgets.length : 0;\n\n    return {\n      onTrack,\n      under,\n      over,\n      averageVariance,\n    };\n  }\n\n  /**\n   * Set alert threshold\n   */\n  setAlertThreshold(percentage: number): void {\n    this.thresholdPercentage = Math.min(100, Math.max(0, percentage));\n    this.emit('threshold:updated', { percentage: this.thresholdPercentage });\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalBudgets: number;\n    totalExpenses: number;\n    totalAlerts: number;\n    averageVariance: number;\n  } {\n    const budgetArray = Array.from(this.budgets.values());\n    const expenseArray = Array.from(this.expenses.values()).flat();\n    const alertArray = Array.from(this.alerts.values()).flat();\n\n    const variances = budgetArray\n      .map((b) => this.getBudgetVariance(b.id))\n      .filter((v): v is BudgetVariance => v !== null);\n\n    const averageVariance = variances.length > 0 ? variances.reduce((sum, v) => sum + v.variancePercentage, 0) / variances.length : 0;\n\n    return {\n      totalBudgets: budgetArray.length,\n      totalExpenses: expenseArray.length,\n      totalAlerts: alertArray.length,\n      averageVariance,\n    };\n  }\n}\n
