import { describe, it, expect, beforeEach } from 'vitest';\nimport { EmailIntegration } from './email-integration';\n\n/**\n * Email Integration Tests\n */\ndescribe('Email Integration', () => {\n  let emailService: EmailIntegration;\n\n  beforeEach(() => {\n    emailService = new EmailIntegration({\n      apiKey: 'test-key',\n      fromEmail: 'noreply@farmkonnect.com',\n      fromName: 'FarmKonnect',\n    });\n  });\n\n  it('should send email successfully', async () => {\n    const message = await emailService.sendEmail(\n      ['user@example.com'],\n      'Test Subject',\n      '<p>Test content</p>',\n      'Test content'\n    );\n\n    expect(message).not.toBeNull();\n    expect(message.status).toBe('sent');\n    expect(message.to).toContain('user@example.com');\n  });\n\n  it('should send email to multiple recipients', async () => {\n    const recipients = ['user1@example.com', 'user2@example.com', 'user3@example.com'];\n    const message = await emailService.sendEmail(recipients, 'Test Subject', '<p>Test</p>');\n\n    expect(message.to.length).toBe(3);\n    expect(message.to).toEqual(recipients);\n  });\n\n  it('should send template email', async () => {\n    const message = await emailService.sendTemplateEmail(\n      'template-report',\n      ['user@example.com'],\n      {\n        reportType: 'Monthly Financial',\n        period: 'January 2026',\n        recipientName: 'John Doe',\n        revenue: '125000',\n        expenses: '95000',\n        profit: '30000',\n        reportUrl: 'https://example.com/report',\n      }\n    );\n\n    expect(message.status).toBe('sent');\n    expect(message.htmlContent).toContain('Monthly Financial');\n    expect(message.htmlContent).toContain('January 2026');\n  });\n\n  it('should create email campaign', () => {\n    const campaign = emailService.createCampaign(\n      'Monthly Report Campaign',\n      'template-report',\n      ['user1@example.com', 'user2@example.com'],\n      [\n        { recipientName: 'User 1', revenue: '100000', expenses: '80000', profit: '20000' },\n        { recipientName: 'User 2', revenue: '150000', expenses: '110000', profit: '40000' },\n      ]\n    );\n\n    expect(campaign).not.toBeNull();\n    expect(campaign.status).toBe('draft');\n    expect(campaign.totalRecipients).toBe(2);\n  });\n\n  it('should schedule campaign', () => {\n    const campaign = emailService.createCampaign(\n      'Test Campaign',\n      'template-report',\n      ['user@example.com'],\n      [{ recipientName: 'User' }]\n    );\n\n    const scheduledFor = Date.now() + 24 * 60 * 60 * 1000;\n    const scheduled = emailService.scheduleCampaign(campaign.id, scheduledFor);\n\n    expect(scheduled.status).toBe('scheduled');\n    expect(scheduled.scheduledFor).toBe(scheduledFor);\n  });\n\n  it('should send campaign', async () => {\n    const campaign = emailService.createCampaign(\n      'Test Campaign',\n      'template-report',\n      ['user1@example.com', 'user2@example.com'],\n      [\n        { recipientName: 'User 1', revenue: '100000', expenses: '80000', profit: '20000' },\n        { recipientName: 'User 2', revenue: '150000', expenses: '110000', profit: '40000' },\n      ]\n    );\n\n    const sent = await emailService.sendCampaign(campaign.id);\n\n    expect(sent.status).toBe('completed');\n    expect(sent.successCount).toBe(2);\n    expect(sent.sentAt).toBeDefined();\n  });\n\n  it('should get all templates', () => {\n    const templates = emailService.getAllTemplates();\n\n    expect(templates.length).toBeGreaterThan(0);\n    expect(templates.some((t) => t.id === 'template-report')).toBe(true);\n  });\n\n  it('should create custom template', () => {\n    const template = emailService.createTemplate(\n      'Custom Template',\n      'Custom Subject {{name}}',\n      '<p>Hello {{name}}</p>',\n      'Hello {{name}}',\n      ['name']\n    );\n\n    expect(template).not.toBeNull();\n    expect(template.name).toBe('Custom Template');\n    expect(template.variables).toContain('name');\n  });\n\n  it('should validate email addresses', () => {\n    expect(emailService.validateEmail('valid@example.com')).toBe(true);\n    expect(emailService.validateEmail('invalid.email')).toBe(false);\n    expect(emailService.validateEmail('user@domain.co.uk')).toBe(true);\n  });\n\n  it('should validate email list', () => {\n    const emails = ['valid@example.com', 'invalid.email', 'another@valid.com'];\n    const result = emailService.validateEmailList(emails);\n\n    expect(result.valid.length).toBe(2);\n    expect(result.invalid.length).toBe(1);\n  });\n\n  it('should get campaign statistics', () => {\n    const campaign = emailService.createCampaign(\n      'Test Campaign',\n      'template-report',\n      ['user1@example.com', 'user2@example.com'],\n      [{ recipientName: 'User 1' }, { recipientName: 'User 2' }]\n    );\n\n    emailService.sendCampaign(campaign.id);\n    const stats = emailService.getCampaignStats(campaign.id);\n\n    expect(stats.totalRecipients).toBe(2);\n    expect(stats.status).toBe('completed');\n  });\n\n  it('should get overall statistics', () => {\n    emailService.sendEmail(['user@example.com'], 'Test', '<p>Test</p>');\n    emailService.createCampaign('Campaign', 'template-report', ['user@example.com'], [{}]);\n\n    const stats = emailService.getStatistics();\n\n    expect(stats.totalMessages).toBeGreaterThan(0);\n    expect(stats.totalCampaigns).toBeGreaterThan(0);\n    expect(stats.totalTemplates).toBeGreaterThan(0);\n  });\n\n  it('should emit email:sent event', (done) => {\n    emailService.on('email:sent', (message) => {\n      expect(message.status).toBe('sent');\n      done();\n    });\n\n    emailService.sendEmail(['user@example.com'], 'Test', '<p>Test</p>');\n  });\n\n  it('should emit campaign:created event', (done) => {\n    emailService.on('campaign:created', (campaign) => {\n      expect(campaign.status).toBe('draft');\n      done();\n    });\n\n    emailService.createCampaign('Test', 'template-report', ['user@example.com'], [{}]);\n  });\n\n  it('should emit campaign:scheduled event', (done) => {\n    const campaign = emailService.createCampaign('Test', 'template-report', ['user@example.com'], [{}]);\n\n    emailService.on('campaign:scheduled', (scheduled) => {\n      expect(scheduled.status).toBe('scheduled');\n      done();\n    });\n\n    emailService.scheduleCampaign(campaign.id, Date.now() + 24 * 60 * 60 * 1000);\n  });\n\n  it('should emit campaign:sent event', (done) => {\n    const campaign = emailService.createCampaign('Test', 'template-report', ['user@example.com'], [{}]);\n\n    emailService.on('campaign:sent', (sent) => {\n      expect(sent.status).toBe('completed');\n      done();\n    });\n\n    emailService.sendCampaign(campaign.id);\n  });\n\n  it('should get message by ID', async () => {\n    const sent = await emailService.sendEmail(['user@example.com'], 'Test', '<p>Test</p>');\n    const retrieved = emailService.getMessage(sent.id);\n\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(sent.id);\n  });\n\n  it('should get messages by status', async () => {\n    await emailService.sendEmail(['user@example.com'], 'Test', '<p>Test</p>');\n    const sent = emailService.getMessagesByStatus('sent');\n\n    expect(sent.length).toBeGreaterThan(0);\n  });\n\n  it('should get campaign by ID', () => {\n    const campaign = emailService.createCampaign('Test', 'template-report', ['user@example.com'], [{}]);\n    const retrieved = emailService.getCampaign(campaign.id);\n\n    expect(retrieved).not.toBeNull();\n    expect(retrieved?.id).toBe(campaign.id);\n  });\n\n  it('should handle template variable interpolation', async () => {\n    const message = await emailService.sendTemplateEmail(\n      'template-alert',\n      ['user@example.com'],\n      {\n        recipientName: 'John Doe',\n        alertType: 'Budget Exceeded',\n        alertMessage: 'Your budget has exceeded by 10%',\n        status: 'Active',\n        dashboardUrl: 'https://example.com/dashboard',\n      }\n    );\n\n    expect(message.htmlContent).toContain('John Doe');\n    expect(message.htmlContent).toContain('Budget Exceeded');\n  });\n\n  it('should handle multiple campaigns', () => {\n    const campaign1 = emailService.createCampaign('Campaign 1', 'template-report', ['user1@example.com'], [{}]);\n    const campaign2 = emailService.createCampaign('Campaign 2', 'template-alert', ['user2@example.com'], [{}]);\n\n    const allCampaigns = emailService.getAllCampaigns();\n\n    expect(allCampaigns.length).toBe(2);\n    expect(allCampaigns.map((c) => c.id)).toContain(campaign1.id);\n    expect(allCampaigns.map((c) => c.id)).toContain(campaign2.id);\n  });\n\n  it('should handle campaign with multiple recipients and variables', async () => {\n    const recipients = ['user1@example.com', 'user2@example.com', 'user3@example.com'];\n    const variables = [\n      { recipientName: 'User 1', revenue: '100000' },\n      { recipientName: 'User 2', revenue: '200000' },\n      { recipientName: 'User 3', revenue: '300000' },\n    ];\n\n    const campaign = emailService.createCampaign('Multi-recipient Campaign', 'template-report', recipients, variables);\n    const sent = await emailService.sendCampaign(campaign.id);\n\n    expect(sent.totalRecipients).toBe(3);\n    expect(sent.successCount).toBe(3);\n  });\n});\n
