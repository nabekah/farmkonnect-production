import { describe, it, expect, beforeEach } from 'vitest';\nimport { FinancialDashboard } from './financial-dashboard';\nimport { InventoryManager } from './inventory';\nimport { ComplianceManager } from './compliance';\n\n/**\n * Financial Dashboard Tests\n */\ndescribe('Financial Dashboard', () => {\n  let dashboard: FinancialDashboard;\n\n  beforeEach(() => {\n    dashboard = new FinancialDashboard();\n  });\n\n  it('should record cash flow', () => {\n    const flow = dashboard.recordCashFlow('farm-1', 5000, 2000, 'Weekly sales');\n    expect(flow).not.toBeNull();\n    expect(flow.balance).toBe(3000);\n  });\n\n  it('should get cash flow history', () => {\n    dashboard.recordCashFlow('farm-1', 5000, 2000, 'Weekly sales');\n    dashboard.recordCashFlow('farm-1', 3000, 1000, 'Equipment purchase');\n\n    const history = dashboard.getCashFlowHistory('farm-1');\n    expect(history.length).toBe(2);\n  });\n\n  it('should create budget plan', () => {\n    const budget = dashboard.createBudgetPlan(\n      'farm-1',\n      2026,\n      10000,\n      20000,\n      5000,\n      8000,\n      6000,\n      4000,\n      2000\n    );\n\n    expect(budget).not.toBeNull();\n    expect(budget.totalBudget).toBe(55000);\n  });\n\n  it('should calculate financial metrics', () => {\n    const metrics = dashboard.calculateFinancialMetrics('farm-1', 100000, 60000, 50000, Date.now() - 86400000, Date.now());\n\n    expect(metrics.profit).toBe(40000);\n    expect(metrics.profitMargin).toBe(40);\n    expect(metrics.roi).toBe(80);\n  });\n\n  it('should calculate expense breakdown', () => {\n    const breakdown = dashboard.calculateExpenseBreakdown(10000, 20000, 5000, 8000, 6000, 4000, 2000);\n\n    expect(breakdown.total).toBe(55000);\n    expect(breakdown.labor).toBe(20000);\n  });\n\n  it('should analyze profitability', () => {\n    const analysis = dashboard.analyzeProfitability(\n      'farm-1',\n      100000,\n      60000,\n      1000,\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    expect(analysis.netProfit).toBe(40000);\n    expect(analysis.profitMargin).toBe(40);\n    expect(analysis.costPerUnit).toBe(60);\n    expect(analysis.revenuePerUnit).toBe(100);\n  });\n\n  it('should generate financial report', () => {\n    const expenses = dashboard.calculateExpenseBreakdown(10000, 20000, 5000, 8000, 6000, 4000, 2000);\n    const revenue = dashboard.calculateRevenueBreakdown(30000, 25000, 20000, 15000, 10000, 0);\n\n    const report = dashboard.generateFinancialReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now(),\n      100000,\n      expenses,\n      revenue,\n      1000\n    );\n\n    expect(report).not.toBeNull();\n    expect(report.metrics.profit).toBe(40000);\n  });\n\n  it('should calculate cumulative metrics', () => {\n    dashboard.recordCashFlow('farm-1', 5000, 2000, 'Sales');\n    dashboard.recordCashFlow('farm-1', 3000, 1000, 'Purchase');\n\n    const metrics = dashboard.calculateCumulativeMetrics(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    expect(metrics.totalInflow).toBe(8000);\n    expect(metrics.totalOutflow).toBe(3000);\n    expect(metrics.netCashFlow).toBe(5000);\n  });\n});\n\n/**\n * Inventory Manager Tests\n */\ndescribe('Inventory Manager', () => {\n  let manager: InventoryManager;\n\n  beforeEach(() => {\n    manager = new InventoryManager();\n  });\n\n  it('should add inventory item', () => {\n    const item = manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    expect(item).not.toBeNull();\n    expect(item.quantity).toBe(1000);\n    expect(item.totalValue).toBe(50000);\n  });\n\n  it('should get inventory by farm', () => {\n    manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    const items = manager.getInventoryByFarm('farm-1');\n    expect(items.length).toBe(1);\n  });\n\n  it('should record transaction', () => {\n    const item = manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    const transaction = manager.recordTransaction(item.id, 'farm-1', 'usage', 100, 'field-1', 5000);\n\n    expect(transaction).not.toBeNull();\n    expect(transaction.type).toBe('usage');\n    expect(item.quantity).toBe(900);\n  });\n\n  it('should calculate inventory usage', () => {\n    const item = manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    manager.recordTransaction(item.id, 'farm-1', 'usage', 100, 'field-1', 5000);\n    manager.recordTransaction(item.id, 'farm-1', 'usage', 50, 'field-2', 2500);\n\n    const usage = manager.calculateInventoryUsage(item.id, 30);\n    expect(usage.totalUsed).toBe(150);\n    expect(usage.averageDailyUsage).toBeGreaterThan(0);\n  });\n\n  it('should get reorder alerts', () => {\n    const item = manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      150,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    const alerts = manager.getReorderAlerts('farm-1');\n    expect(alerts.length).toBeGreaterThan(0);\n  });\n\n  it('should generate inventory report', () => {\n    manager.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n\n    const report = manager.generateInventoryReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    expect(report).not.toBeNull();\n    expect(report.totalItems).toBe(1);\n    expect(report.totalValue).toBeGreaterThan(0);\n  });\n});\n\n/**\n * Compliance Manager Tests\n */\ndescribe('Compliance Manager', () => {\n  let manager: ComplianceManager;\n\n  beforeEach(() => {\n    manager = new ComplianceManager();\n  });\n\n  it('should add certification', () => {\n    const cert = manager.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 365 * 86400000,\n      'CERT-2024-001',\n      'Wheat, Corn'\n    );\n\n    expect(cert).not.toBeNull();\n    expect(cert.status).toBe('compliant');\n  });\n\n  it('should get certifications', () => {\n    manager.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 365 * 86400000,\n      'CERT-2024-001',\n      'Wheat, Corn'\n    );\n\n    const certs = manager.getCertifications('farm-1');\n    expect(certs.length).toBe(1);\n  });\n\n  it('should detect expiring certifications', () => {\n    manager.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 30 * 86400000,\n      'CERT-2024-001',\n      'Wheat, Corn'\n    );\n\n    const expiring = manager.getExpiringCertifications('farm-1', 90);\n    expect(expiring.length).toBe(1);\n  });\n\n  it('should add compliance requirement', () => {\n    const req = manager.addComplianceRequirement(\n      'farm-1',\n      'Pesticide Use',\n      'Comply with EPA pesticide regulations',\n      'Must use approved pesticides only',\n      'EPA',\n      Date.now() + 86400000,\n      'high'\n    );\n\n    expect(req).not.toBeNull();\n    expect(req.status).toBe('pending_review');\n  });\n\n  it('should get compliance requirements', () => {\n    manager.addComplianceRequirement(\n      'farm-1',\n      'Pesticide Use',\n      'Comply with EPA pesticide regulations',\n      'Must use approved pesticides only',\n      'EPA',\n      Date.now() + 86400000,\n      'high'\n    );\n\n    const reqs = manager.getComplianceRequirements('farm-1');\n    expect(reqs.length).toBe(1);\n  });\n\n  it('should record audit trail', () => {\n    const trail = manager.recordAuditTrail('farm-1', 'Pesticide applied', 'farmer-1', { fieldId: 'field-1' });\n\n    expect(trail).not.toBeNull();\n    expect(trail.action).toBe('Pesticide applied');\n  });\n\n  it('should get audit trail', () => {\n    manager.recordAuditTrail('farm-1', 'Pesticide applied', 'farmer-1', { fieldId: 'field-1' });\n    manager.recordAuditTrail('farm-1', 'Fertilizer applied', 'farmer-1', { fieldId: 'field-2' });\n\n    const trail = manager.getAuditTrail('farm-1');\n    expect(trail.length).toBe(2);\n  });\n\n  it('should create compliance checkpoint', () => {\n    const checkpoint = manager.createComplianceCheckpoint(\n      'farm-1',\n      [\n        { description: 'Pesticide storage compliant', completed: true },\n        { description: 'Water quality tested', completed: true },\n      ],\n      'Auditor John',\n      Date.now() + 90 * 86400000\n    );\n\n    expect(checkpoint).not.toBeNull();\n    expect(checkpoint.overallStatus).toBe('compliant');\n  });\n\n  it('should calculate overall compliance', () => {\n    manager.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 365 * 86400000,\n      'CERT-2024-001',\n      'Wheat, Corn'\n    );\n\n    manager.addComplianceRequirement(\n      'farm-1',\n      'Pesticide Use',\n      'Comply with EPA pesticide regulations',\n      'Must use approved pesticides only',\n      'EPA',\n      Date.now() + 86400000,\n      'high'\n    );\n\n    const compliance = manager.calculateOverallCompliance('farm-1');\n    expect(compliance).toBeGreaterThanOrEqual(0);\n    expect(compliance).toBeLessThanOrEqual(100);\n  });\n\n  it('should generate compliance report', () => {\n    manager.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 365 * 86400000,\n      'CERT-2024-001',\n      'Wheat, Corn'\n    );\n\n    const report = manager.generateComplianceReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    expect(report).not.toBeNull();\n    expect(report.certifications.length).toBe(1);\n    expect(report.overallCompliance).toBeGreaterThanOrEqual(0);\n  });\n});\n\n/**\n * Integration Tests\n */\ndescribe('Integration Tests', () => {\n  it('should work with all three systems together', () => {\n    const financial = new FinancialDashboard();\n    const inventory = new InventoryManager();\n    const compliance = new ComplianceManager();\n\n    // Financial: Record cash flow\n    financial.recordCashFlow('farm-1', 100000, 60000, 'Harvest sales');\n\n    // Inventory: Add and use items\n    const seeds = inventory.addInventoryItem(\n      'farm-1',\n      'Wheat Seeds',\n      'seeds',\n      1000,\n      'kg',\n      200,\n      2000,\n      50,\n      'Supplier A',\n      'Storage A'\n    );\n    inventory.recordTransaction(seeds.id, 'farm-1', 'usage', 500, 'field-1', 25000);\n\n    // Compliance: Add certification\n    compliance.addCertification(\n      'farm-1',\n      'organic',\n      'Organic Certification',\n      'USDA',\n      Date.now() - 365 * 86400000,\n      Date.now() + 365 * 86400000,\n      'CERT-2024-001',\n      'Wheat'\n    );\n\n    // Generate reports\n    const expenses = financial.calculateExpenseBreakdown(10000, 20000, 5000, 8000, 6000, 4000, 2000);\n    const revenue = financial.calculateRevenueBreakdown(30000, 25000, 20000, 15000, 10000, 0);\n    const financialReport = financial.generateFinancialReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now(),\n      100000,\n      expenses,\n      revenue,\n      1000\n    );\n\n    const inventoryReport = inventory.generateInventoryReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    const complianceReport = compliance.generateComplianceReport(\n      'farm-1',\n      Date.now() - 86400000,\n      Date.now()\n    );\n\n    // Verify all systems\n    expect(financialReport).not.toBeNull();\n    expect(inventoryReport).not.toBeNull();\n    expect(complianceReport).not.toBeNull();\n    expect(financialReport.metrics.profit).toBe(40000);\n    expect(inventoryReport.totalItems).toBe(1);\n    expect(complianceReport.certifications.length).toBe(1);\n  });\n});\n
