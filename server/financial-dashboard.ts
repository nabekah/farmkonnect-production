import { EventEmitter } from 'events';\n\nexport interface FinancialMetrics {\n  farmId: string;\n  period: { start: number; end: number };\n  revenue: number;\n  expenses: number;\n  profit: number;\n  profitMargin: number; // percentage\n  roi: number; // Return on Investment percentage\n}\n\nexport interface ExpenseBreakdown {\n  equipment: number;\n  labor: number;\n  fuel: number;\n  seeds: number;\n  fertilizer: number;\n  pesticides: number;\n  other: number;\n  total: number;\n}\n\nexport interface RevenueBreakdown {\n  wheat: number;\n  corn: number;\n  soybean: number;\n  rice: number;\n  barley: number;\n  other: number;\n  total: number;\n}\n\nexport interface CashFlow {\n  id: string;\n  farmId: string;\n  date: number;\n  inflow: number;\n  outflow: number;\n  balance: number;\n  description: string;\n}\n\nexport interface ProfitabilityAnalysis {\n  farmId: string;\n  period: { start: number; end: number };\n  totalRevenue: number;\n  totalExpenses: number;\n  grossProfit: number;\n  netProfit: number;\n  profitMargin: number;\n  breakEvenPoint: number; // units\n  costPerUnit: number;\n  revenuePerUnit: number;\n  profitPerUnit: number;\n}\n\nexport interface BudgetPlan {\n  id: string;\n  farmId: string;\n  year: number;\n  categories: {\n    equipment: number;\n    labor: number;\n    fuel: number;\n    seeds: number;\n    fertilizer: number;\n    pesticides: number;\n    other: number;\n  };\n  totalBudget: number;\n  notes: string;\n}\n\nexport interface BudgetVariance {\n  category: string;\n  budgeted: number;\n  actual: number;\n  variance: number;\n  variancePercentage: number;\n}\n\nexport interface FinancialReport {\n  id: string;\n  farmId: string;\n  period: { start: number; end: number };\n  generatedAt: number;\n  metrics: FinancialMetrics;\n  expenseBreakdown: ExpenseBreakdown;\n  revenueBreakdown: RevenueBreakdown;\n  profitability: ProfitabilityAnalysis;\n  budgetVariances: BudgetVariance[];\n}\n\n/**\n * Financial Dashboard System\n */\nexport class FinancialDashboard extends EventEmitter {\n  private cashFlows: Map<string, CashFlow> = new Map();\n  private budgetPlans: Map<string, BudgetPlan> = new Map();\n  private financialReports: Map<string, FinancialReport> = new Map();\n\n  constructor() {\n    super();\n  }\n\n  /**\n   * Record cash flow\n   */\n  recordCashFlow(\n    farmId: string,\n    inflow: number,\n    outflow: number,\n    description: string\n  ): CashFlow {\n    const flowId = `cashflow_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const balance = inflow - outflow;\n\n    const flow: CashFlow = {\n      id: flowId,\n      farmId,\n      date: Date.now(),\n      inflow,\n      outflow,\n      balance,\n      description,\n    };\n\n    this.cashFlows.set(flowId, flow);\n    this.emit('cashflow:recorded', { flowId, farmId, balance });\n    return flow;\n  }\n\n  /**\n   * Get cash flow history\n   */\n  getCashFlowHistory(farmId: string, startDate?: number, endDate?: number): CashFlow[] {\n    let flows = Array.from(this.cashFlows.values()).filter((f) => f.farmId === farmId);\n\n    if (startDate && endDate) {\n      flows = flows.filter((f) => f.date >= startDate && f.date <= endDate);\n    }\n\n    return flows.sort((a, b) => b.date - a.date);\n  }\n\n  /**\n   * Create budget plan\n   */\n  createBudgetPlan(\n    farmId: string,\n    year: number,\n    equipment: number,\n    labor: number,\n    fuel: number,\n    seeds: number,\n    fertilizer: number,\n    pesticides: number,\n    other: number,\n    notes: string = ''\n  ): BudgetPlan {\n    const budgetId = `budget_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const totalBudget = equipment + labor + fuel + seeds + fertilizer + pesticides + other;\n\n    const budget: BudgetPlan = {\n      id: budgetId,\n      farmId,\n      year,\n      categories: {\n        equipment,\n        labor,\n        fuel,\n        seeds,\n        fertilizer,\n        pesticides,\n        other,\n      },\n      totalBudget,\n      notes,\n    };\n\n    this.budgetPlans.set(budgetId, budget);\n    this.emit('budget:created', { budgetId, farmId, totalBudget });\n    return budget;\n  }\n\n  /**\n   * Get budget plan\n   */\n  getBudgetPlan(budgetId: string): BudgetPlan | null {\n    return this.budgetPlans.get(budgetId) || null;\n  }\n\n  /**\n   * Calculate financial metrics\n   */\n  calculateFinancialMetrics(\n    farmId: string,\n    revenue: number,\n    expenses: number,\n    initialInvestment: number,\n    startDate: number,\n    endDate: number\n  ): FinancialMetrics {\n    const profit = revenue - expenses;\n    const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;\n    const roi = initialInvestment > 0 ? (profit / initialInvestment) * 100 : 0;\n\n    return {\n      farmId,\n      period: { start: startDate, end: endDate },\n      revenue,\n      expenses,\n      profit,\n      profitMargin,\n      roi,\n    };\n  }\n\n  /**\n   * Calculate expense breakdown\n   */\n  calculateExpenseBreakdown(\n    equipment: number,\n    labor: number,\n    fuel: number,\n    seeds: number,\n    fertilizer: number,\n    pesticides: number,\n    other: number\n  ): ExpenseBreakdown {\n    const total = equipment + labor + fuel + seeds + fertilizer + pesticides + other;\n\n    return {\n      equipment,\n      labor,\n      fuel,\n      seeds,\n      fertilizer,\n      pesticides,\n      other,\n      total,\n    };\n  }\n\n  /**\n   * Calculate revenue breakdown\n   */\n  calculateRevenueBreakdown(\n    wheat: number,\n    corn: number,\n    soybean: number,\n    rice: number,\n    barley: number,\n    other: number\n  ): RevenueBreakdown {\n    const total = wheat + corn + soybean + rice + barley + other;\n\n    return {\n      wheat,\n      corn,\n      soybean,\n      rice,\n      barley,\n      other,\n      total,\n    };\n  }\n\n  /**\n   * Analyze profitability\n   */\n  analyzeProfitability(\n    farmId: string,\n    totalRevenue: number,\n    totalExpenses: number,\n    totalUnitsProduced: number,\n    startDate: number,\n    endDate: number\n  ): ProfitabilityAnalysis {\n    const grossProfit = totalRevenue;\n    const netProfit = totalRevenue - totalExpenses;\n    const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;\n    const costPerUnit = totalUnitsProduced > 0 ? totalExpenses / totalUnitsProduced : 0;\n    const revenuePerUnit = totalUnitsProduced > 0 ? totalRevenue / totalUnitsProduced : 0;\n    const profitPerUnit = revenuePerUnit - costPerUnit;\n    const breakEvenPoint = costPerUnit > 0 ? Math.ceil(totalExpenses / costPerUnit) : 0;\n\n    return {\n      farmId,\n      period: { start: startDate, end: endDate },\n      totalRevenue,\n      totalExpenses,\n      grossProfit,\n      netProfit,\n      profitMargin,\n      breakEvenPoint,\n      costPerUnit,\n      revenuePerUnit,\n      profitPerUnit,\n    };\n  }\n\n  /**\n   * Calculate budget variance\n   */\n  calculateBudgetVariance(\n    budgetPlan: BudgetPlan,\n    actualExpenses: ExpenseBreakdown\n  ): BudgetVariance[] {\n    const categories = [\n      'equipment',\n      'labor',\n      'fuel',\n      'seeds',\n      'fertilizer',\n      'pesticides',\n      'other',\n    ];\n\n    return categories.map((category) => {\n      const budgeted = budgetPlan.categories[category as keyof typeof budgetPlan.categories];\n      const actual = actualExpenses[category as keyof typeof actualExpenses];\n      const variance = actual - budgeted;\n      const variancePercentage = budgeted > 0 ? (variance / budgeted) * 100 : 0;\n\n      return {\n        category,\n        budgeted,\n        actual,\n        variance,\n        variancePercentage,\n      };\n    });\n  }\n\n  /**\n   * Generate financial report\n   */\n  generateFinancialReport(\n    farmId: string,\n    startDate: number,\n    endDate: number,\n    revenue: number,\n    expenses: ExpenseBreakdown,\n    revenueBreakdown: RevenueBreakdown,\n    totalUnitsProduced: number,\n    budgetPlan?: BudgetPlan\n  ): FinancialReport {\n    const reportId = `report_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const metrics = this.calculateFinancialMetrics(\n      farmId,\n      revenue,\n      expenses.total,\n      0,\n      startDate,\n      endDate\n    );\n\n    const profitability = this.analyzeProfitability(\n      farmId,\n      revenue,\n      expenses.total,\n      totalUnitsProduced,\n      startDate,\n      endDate\n    );\n\n    const budgetVariances = budgetPlan\n      ? this.calculateBudgetVariance(budgetPlan, expenses)\n      : [];\n\n    const report: FinancialReport = {\n      id: reportId,\n      farmId,\n      period: { start: startDate, end: endDate },\n      generatedAt: Date.now(),\n      metrics,\n      expenseBreakdown: expenses,\n      revenueBreakdown,\n      profitability,\n      budgetVariances,\n    };\n\n    this.financialReports.set(reportId, report);\n    this.emit('report:generated', { reportId, farmId });\n    return report;\n  }\n\n  /**\n   * Get financial report\n   */\n  getFinancialReport(reportId: string): FinancialReport | null {\n    return this.financialReports.get(reportId) || null;\n  }\n\n  /**\n   * Get reports by farm\n   */\n  getReportsByFarm(farmId: string): FinancialReport[] {\n    return Array.from(this.financialReports.values())\n      .filter((r) => r.farmId === farmId)\n      .sort((a, b) => b.generatedAt - a.generatedAt);\n  }\n\n  /**\n   * Calculate cumulative metrics\n   */\n  calculateCumulativeMetrics(\n    farmId: string,\n    startDate: number,\n    endDate: number\n  ): {\n    totalInflow: number;\n    totalOutflow: number;\n    netCashFlow: number;\n    averageDailyFlow: number;\n  } {\n    const flows = this.getCashFlowHistory(farmId, startDate, endDate);\n    const totalInflow = flows.reduce((sum, f) => sum + f.inflow, 0);\n    const totalOutflow = flows.reduce((sum, f) => sum + f.outflow, 0);\n    const netCashFlow = totalInflow - totalOutflow;\n    const days = (endDate - startDate) / 86400000;\n    const averageDailyFlow = days > 0 ? netCashFlow / days : 0;\n\n    return {\n      totalInflow,\n      totalOutflow,\n      netCashFlow,\n      averageDailyFlow,\n    };\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalCashFlows: number;\n    totalBudgetPlans: number;\n    totalReports: number;\n  } {\n    return {\n      totalCashFlows: this.cashFlows.size,\n      totalBudgetPlans: this.budgetPlans.size,\n      totalReports: this.financialReports.size,\n    };\n  }\n}\n
