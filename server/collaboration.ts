import { EventEmitter } from 'events';\n\nexport type UserRole = 'admin' | 'manager' | 'worker' | 'viewer';\nexport type TaskStatus = 'pending' | 'in-progress' | 'completed' | 'cancelled';\nexport type TaskPriority = 'low' | 'medium' | 'high' | 'urgent';\n\nexport interface TeamMember {\n  /**\n   * User ID\n   */\n  userId: string;\n  /**\n   * Farm ID\n   */\n  farmId: string;\n  /**\n   * Name\n   */\n  name: string;\n  /**\n   * Email\n   */\n  email: string;\n  /**\n   * Role\n   */\n  role: UserRole;\n  /**\n   * Permissions\n   */\n  permissions: string[];\n  /**\n   * Status\n   */\n  status: 'active' | 'inactive' | 'pending';\n  /**\n   * Joined at\n   */\n  joinedAt: number;\n}\n\nexport interface Task {\n  /**\n   * Task ID\n   */\n  id: string;\n  /**\n   * Farm ID\n   */\n  farmId: string;\n  /**\n   * Title\n   */\n  title: string;\n  /**\n   * Description\n   */\n  description: string;\n  /**\n   * Assigned to\n   */\n  assignedTo: string;\n  /**\n   * Created by\n   */\n  createdBy: string;\n  /**\n   * Status\n   */\n  status: TaskStatus;\n  /**\n   * Priority\n   */\n  priority: TaskPriority;\n  /**\n   * Due date\n   */\n  dueDate: number;\n  /**\n   * Completed at\n   */\n  completedAt?: number;\n  /**\n   * Created at\n   */\n  createdAt: number;\n}\n\nexport interface TeamComment {\n  /**\n   * Comment ID\n   */\n  id: string;\n  /**\n   * Task ID\n   */\n  taskId: string;\n  /**\n   * Author ID\n   */\n  authorId: string;\n  /**\n   * Content\n   */\n  content: string;\n  /**\n   * Created at\n   */\n  createdAt: number;\n}\n\nexport interface Permission {\n  /**\n   * Permission ID\n   */\n  id: string;\n  /**\n   * Name\n   */\n  name: string;\n  /**\n   * Description\n   */\n  description: string;\n  /**\n   * Resource\n   */\n  resource: string;\n  /**\n   * Action\n   */\n  action: string;\n}\n\n/**\n * Team Collaboration Manager\n */\nexport class TeamCollaborationManager extends EventEmitter {\n  private teamMembers: Map<string, TeamMember[]> = new Map();\n  private tasks: Map<string, Task[]> = new Map();\n  private comments: Map<string, TeamComment[]> = new Map();\n  private permissions: Map<UserRole, string[]> = new Map();\n  private rolePermissions: Map<string, Permission> = new Map();\n\n  constructor() {\n    super();\n    this.initializePermissions();\n  }\n\n  /**\n   * Initialize default permissions\n   */\n  private initializePermissions(): void {\n    this.permissions.set('admin', [\n      'manage_team',\n      'create_task',\n      'edit_task',\n      'delete_task',\n      'assign_task',\n      'view_reports',\n      'manage_permissions',\n      'view_all_tasks',\n    ]);\n\n    this.permissions.set('manager', [\n      'create_task',\n      'edit_task',\n      'assign_task',\n      'view_reports',\n      'view_team_tasks',\n    ]);\n\n    this.permissions.set('worker', ['view_assigned_tasks', 'update_task_status', 'comment_on_tasks']);\n\n    this.permissions.set('viewer', ['view_team_tasks', 'view_reports']);\n  }\n\n  /**\n   * Add team member\n   */\n  addTeamMember(\n    farmId: string,\n    userId: string,\n    name: string,\n    email: string,\n    role: UserRole\n  ): TeamMember {\n    const member: TeamMember = {\n      userId,\n      farmId,\n      name,\n      email,\n      role,\n      permissions: this.permissions.get(role) || [],\n      status: 'pending',\n      joinedAt: Date.now(),\n    };\n\n    if (!this.teamMembers.has(farmId)) {\n      this.teamMembers.set(farmId, []);\n    }\n    this.teamMembers.get(farmId)!.push(member);\n\n    this.emit('member:added', { farmId, userId, role });\n    return member;\n  }\n\n  /**\n   * Get team members\n   */\n  getTeamMembers(farmId: string): TeamMember[] {\n    return this.teamMembers.get(farmId) || [];\n  }\n\n  /**\n   * Update member role\n   */\n  updateMemberRole(farmId: string, userId: string, newRole: UserRole): boolean {\n    const members = this.teamMembers.get(farmId);\n    if (!members) return false;\n\n    const member = members.find((m) => m.userId === userId);\n    if (!member) return false;\n\n    member.role = newRole;\n    member.permissions = this.permissions.get(newRole) || [];\n\n    this.emit('member:updated', { farmId, userId, newRole });\n    return true;\n  }\n\n  /**\n   * Remove team member\n   */\n  removeTeamMember(farmId: string, userId: string): boolean {\n    const members = this.teamMembers.get(farmId);\n    if (!members) return false;\n\n    const index = members.findIndex((m) => m.userId === userId);\n    if (index === -1) return false;\n\n    members.splice(index, 1);\n    this.emit('member:removed', { farmId, userId });\n    return true;\n  }\n\n  /**\n   * Check permission\n   */\n  hasPermission(farmId: string, userId: string, permission: string): boolean {\n    const members = this.teamMembers.get(farmId);\n    if (!members) return false;\n\n    const member = members.find((m) => m.userId === userId);\n    if (!member) return false;\n\n    return member.permissions.includes(permission);\n  }\n\n  /**\n   * Create task\n   */\n  createTask(\n    farmId: string,\n    createdBy: string,\n    title: string,\n    description: string,\n    assignedTo: string,\n    priority: TaskPriority,\n    dueDate: number\n  ): Task {\n    if (!this.hasPermission(farmId, createdBy, 'create_task')) {\n      throw new Error('Permission denied: create_task');\n    }\n\n    const task: Task = {\n      id: `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      farmId,\n      title,\n      description,\n      assignedTo,\n      createdBy,\n      status: 'pending',\n      priority,\n      dueDate,\n      createdAt: Date.now(),\n    };\n\n    if (!this.tasks.has(farmId)) {\n      this.tasks.set(farmId, []);\n    }\n    this.tasks.get(farmId)!.push(task);\n\n    this.emit('task:created', { farmId, taskId: task.id, assignedTo });\n    return task;\n  }\n\n  /**\n   * Get tasks\n   */\n  getTasks(farmId: string, userId?: string): Task[] {\n    const tasks = this.tasks.get(farmId) || [];\n    if (userId) {\n      return tasks.filter((t) => t.assignedTo === userId);\n    }\n    return tasks;\n  }\n\n  /**\n   * Update task status\n   */\n  updateTaskStatus(farmId: string, taskId: string, userId: string, status: TaskStatus): boolean {\n    const tasks = this.tasks.get(farmId);\n    if (!tasks) return false;\n\n    const task = tasks.find((t) => t.id === taskId);\n    if (!task) return false;\n\n    if (task.assignedTo !== userId && !this.hasPermission(farmId, userId, 'edit_task')) {\n      throw new Error('Permission denied: update_task_status');\n    }\n\n    task.status = status;\n    if (status === 'completed') {\n      task.completedAt = Date.now();\n    }\n\n    this.emit('task:updated', { farmId, taskId, status });\n    return true;\n  }\n\n  /**\n   * Add comment to task\n   */\n  addComment(farmId: string, taskId: string, authorId: string, content: string): TeamComment {\n    if (!this.hasPermission(farmId, authorId, 'comment_on_tasks')) {\n      throw new Error('Permission denied: comment_on_tasks');\n    }\n\n    const comment: TeamComment = {\n      id: `comment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      taskId,\n      authorId,\n      content,\n      createdAt: Date.now(),\n    };\n\n    if (!this.comments.has(taskId)) {\n      this.comments.set(taskId, []);\n    }\n    this.comments.get(taskId)!.push(comment);\n\n    this.emit('comment:added', { farmId, taskId, commentId: comment.id });\n    return comment;\n  }\n\n  /**\n   * Get task comments\n   */\n  getTaskComments(taskId: string): TeamComment[] {\n    return this.comments.get(taskId) || [];\n  }\n\n  /**\n   * Get team stats\n   */\n  getTeamStats(farmId: string): {\n    totalMembers: number;\n    activeMembers: number;\n    totalTasks: number;\n    completedTasks: number;\n    pendingTasks: number;\n    byRole: Record<UserRole, number>;\n  } {\n    const members = this.teamMembers.get(farmId) || [];\n    const tasks = this.tasks.get(farmId) || [];\n\n    const stats = {\n      totalMembers: members.length,\n      activeMembers: members.filter((m) => m.status === 'active').length,\n      totalTasks: tasks.length,\n      completedTasks: tasks.filter((t) => t.status === 'completed').length,\n      pendingTasks: tasks.filter((t) => t.status === 'pending').length,\n      byRole: {\n        admin: members.filter((m) => m.role === 'admin').length,\n        manager: members.filter((m) => m.role === 'manager').length,\n        worker: members.filter((m) => m.role === 'worker').length,\n        viewer: members.filter((m) => m.role === 'viewer').length,\n      },\n    };\n\n    return stats;\n  }\n\n  /**\n   * Get task stats\n   */\n  getTaskStats(farmId: string): {\n    total: number;\n    byStatus: Record<TaskStatus, number>;\n    byPriority: Record<TaskPriority, number>;\n    overdue: number;\n  } {\n    const tasks = this.tasks.get(farmId) || [];\n    const now = Date.now();\n\n    const stats = {\n      total: tasks.length,\n      byStatus: {\n        pending: tasks.filter((t) => t.status === 'pending').length,\n        'in-progress': tasks.filter((t) => t.status === 'in-progress').length,\n        completed: tasks.filter((t) => t.status === 'completed').length,\n        cancelled: tasks.filter((t) => t.status === 'cancelled').length,\n      },\n      byPriority: {\n        low: tasks.filter((t) => t.priority === 'low').length,\n        medium: tasks.filter((t) => t.priority === 'medium').length,\n        high: tasks.filter((t) => t.priority === 'high').length,\n        urgent: tasks.filter((t) => t.priority === 'urgent').length,\n      },\n      overdue: tasks.filter((t) => t.dueDate < now && t.status !== 'completed').length,\n    };\n\n    return stats;\n  }\n\n  /**\n   * Get member permissions\n   */\n  getMemberPermissions(farmId: string, userId: string): string[] {\n    const members = this.teamMembers.get(farmId);\n    if (!members) return [];\n\n    const member = members.find((m) => m.userId === userId);\n    return member?.permissions || [];\n  }\n}\n
