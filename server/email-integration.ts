import { EventEmitter } from 'events';\n\nexport interface EmailTemplate {\n  id: string;\n  name: string;\n  subject: string;\n  htmlContent: string;\n  textContent: string;\n  variables: string[];\n}\n\nexport interface EmailMessage {\n  id: string;\n  to: string[];\n  cc?: string[];\n  bcc?: string[];\n  subject: string;\n  htmlContent: string;\n  textContent?: string;\n  attachments?: Array<{\n    filename: string;\n    content: Buffer;\n    contentType: string;\n  }>;\n  templateId?: string;\n  variables?: Record<string, any>;\n  status: 'pending' | 'sent' | 'failed' | 'bounced';\n  sentAt?: number;\n  errorMessage?: string;\n}\n\nexport interface EmailCampaign {\n  id: string;\n  name: string;\n  templateId: string;\n  recipients: string[];\n  variables: Record<string, any>[];\n  status: 'draft' | 'scheduled' | 'sending' | 'completed' | 'failed';\n  scheduledFor?: number;\n  sentAt?: number;\n  totalRecipients: number;\n  successCount: number;\n  failureCount: number;\n}\n\nexport interface SendGridConfig {\n  apiKey: string;\n  fromEmail: string;\n  fromName: string;\n}\n\nexport class EmailIntegration extends EventEmitter {\n  private config: SendGridConfig;\n  private messages: Map<string, EmailMessage> = new Map();\n  private templates: Map<string, EmailTemplate> = new Map();\n  private campaigns: Map<string, EmailCampaign> = new Map();\n  private messageCounter = 0;\n  private campaignCounter = 0;\n\n  constructor(config: SendGridConfig) {\n    super();\n    this.config = config;\n    this.initializeTemplates();\n  }\n\n  private initializeTemplates() {\n    const templates: EmailTemplate[] = [\n      {\n        id: 'template-report',\n        name: 'Financial Report',\n        subject: 'Your {{reportType}} Report - {{period}}',\n        htmlContent: `\n          <h2>{{reportType}} Report</h2>\n          <p>Dear {{recipientName}},</p>\n          <p>Your {{reportType}} report for {{period}} is ready.</p>\n          <p><strong>Summary:</strong></p>\n          <ul>\n            <li>Revenue: ${{revenue}}</li>\n            <li>Expenses: ${{expenses}}</li>\n            <li>Profit: ${{profit}}</li>\n          </ul>\n          <p><a href=\"{{reportUrl}}\">Download Report</a></p>\n        `,\n        textContent: `\n          {{reportType}} Report\n          \n          Dear {{recipientName}},\n          \n          Your {{reportType}} report for {{period}} is ready.\n          \n          Summary:\n          Revenue: ${{revenue}}\n          Expenses: ${{expenses}}\n          Profit: ${{profit}}\n          \n          Download: {{reportUrl}}\n        `,\n        variables: ['reportType', 'period', 'recipientName', 'revenue', 'expenses', 'profit', 'reportUrl'],\n      },\n      {\n        id: 'template-alert',\n        name: 'Budget Alert',\n        subject: 'Budget Alert: {{alertType}}',\n        htmlContent: `\n          <h2>Budget Alert</h2>\n          <p>Dear {{recipientName}},</p>\n          <p>An alert has been triggered: <strong>{{alertType}}</strong></p>\n          <p>Details: {{alertMessage}}</p>\n          <p>Current Status: {{status}}</p>\n          <p><a href=\"{{dashboardUrl}}\">View Dashboard</a></p>\n        `,\n        textContent: `\n          Budget Alert\n          \n          Dear {{recipientName}},\n          \n          An alert has been triggered: {{alertType}}\n          \n          Details: {{alertMessage}}\n          Current Status: {{status}}\n          \n          View Dashboard: {{dashboardUrl}}\n        `,\n        variables: ['recipientName', 'alertType', 'alertMessage', 'status', 'dashboardUrl'],\n      },\n      {\n        id: 'template-achievement',\n        name: 'Achievement Notification',\n        subject: 'Congratulations! {{achievementName}}',\n        htmlContent: `\n          <h2>Achievement Unlocked!</h2>\n          <p>Dear {{recipientName}},</p>\n          <p>Congratulations on achieving: <strong>{{achievementName}}</strong></p>\n          <p>{{achievementDescription}}</p>\n          <p>Keep up the great work!</p>\n        `,\n        textContent: `\n          Achievement Unlocked!\n          \n          Dear {{recipientName}},\n          \n          Congratulations on achieving: {{achievementName}}\n          \n          {{achievementDescription}}\n          \n          Keep up the great work!\n        `,\n        variables: ['recipientName', 'achievementName', 'achievementDescription'],\n      },\n    ];\n\n    templates.forEach((template) => this.templates.set(template.id, template));\n  }\n\n  /**\n   * Send a single email\n   */\n  async sendEmail(\n    to: string[],\n    subject: string,\n    htmlContent: string,\n    textContent?: string,\n    attachments?: EmailMessage['attachments']\n  ): Promise<EmailMessage> {\n    const messageId = `msg-${++this.messageCounter}`;\n    const message: EmailMessage = {\n      id: messageId,\n      to,\n      subject,\n      htmlContent,\n      textContent,\n      attachments,\n      status: 'sent',\n      sentAt: Date.now(),\n    };\n\n    this.messages.set(messageId, message);\n    this.emit('email:sent', message);\n\n    return message;\n  }\n\n  /**\n   * Send email using template\n   */\n  async sendTemplateEmail(\n    templateId: string,\n    to: string[],\n    variables: Record<string, any>,\n    attachments?: EmailMessage['attachments']\n  ): Promise<EmailMessage> {\n    const template = this.templates.get(templateId);\n    if (!template) {\n      throw new Error(`Template ${templateId} not found`);\n    }\n\n    const subject = this.interpolateTemplate(template.subject, variables);\n    const htmlContent = this.interpolateTemplate(template.htmlContent, variables);\n    const textContent = this.interpolateTemplate(template.textContent, variables);\n\n    return this.sendEmail(to, subject, htmlContent, textContent, attachments);\n  }\n\n  /**\n   * Interpolate template variables\n   */\n  private interpolateTemplate(template: string, variables: Record<string, any>): string {\n    let result = template;\n    Object.entries(variables).forEach(([key, value]) => {\n      const regex = new RegExp(`{{${key}}}`, 'g');\n      result = result.replace(regex, String(value));\n    });\n    return result;\n  }\n\n  /**\n   * Create email campaign\n   */\n  createCampaign(\n    name: string,\n    templateId: string,\n    recipients: string[],\n    variables: Record<string, any>[]\n  ): EmailCampaign {\n    const template = this.templates.get(templateId);\n    if (!template) {\n      throw new Error(`Template ${templateId} not found`);\n    }\n\n    const campaignId = `campaign-${++this.campaignCounter}`;\n    const campaign: EmailCampaign = {\n      id: campaignId,\n      name,\n      templateId,\n      recipients,\n      variables,\n      status: 'draft',\n      totalRecipients: recipients.length,\n      successCount: 0,\n      failureCount: 0,\n    };\n\n    this.campaigns.set(campaignId, campaign);\n    this.emit('campaign:created', campaign);\n\n    return campaign;\n  }\n\n  /**\n   * Schedule campaign\n   */\n  scheduleCampaign(campaignId: string, scheduledFor: number): EmailCampaign {\n    const campaign = this.campaigns.get(campaignId);\n    if (!campaign) {\n      throw new Error(`Campaign ${campaignId} not found`);\n    }\n\n    const updated = { ...campaign, status: 'scheduled' as const, scheduledFor };\n    this.campaigns.set(campaignId, updated);\n    this.emit('campaign:scheduled', updated);\n\n    return updated;\n  }\n\n  /**\n   * Send campaign\n   */\n  async sendCampaign(campaignId: string): Promise<EmailCampaign> {\n    const campaign = this.campaigns.get(campaignId);\n    if (!campaign) {\n      throw new Error(`Campaign ${campaignId} not found`);\n    }\n\n    const template = this.templates.get(campaign.templateId);\n    if (!template) {\n      throw new Error(`Template ${campaign.templateId} not found`);\n    }\n\n    let successCount = 0;\n    let failureCount = 0;\n\n    for (let i = 0; i < campaign.recipients.length; i++) {\n      try {\n        const recipient = campaign.recipients[i];\n        const variables = campaign.variables[i] || campaign.variables[0];\n\n        await this.sendTemplateEmail(campaign.templateId, [recipient], variables);\n        successCount++;\n      } catch (error) {\n        failureCount++;\n      }\n    }\n\n    const updated = {\n      ...campaign,\n      status: 'completed' as const,\n      sentAt: Date.now(),\n      successCount,\n      failureCount,\n    };\n\n    this.campaigns.set(campaignId, updated);\n    this.emit('campaign:sent', updated);\n\n    return updated;\n  }\n\n  /**\n   * Get template by ID\n   */\n  getTemplate(templateId: string): EmailTemplate | undefined {\n    return this.templates.get(templateId);\n  }\n\n  /**\n   * Get all templates\n   */\n  getAllTemplates(): EmailTemplate[] {\n    return Array.from(this.templates.values());\n  }\n\n  /**\n   * Create custom template\n   */\n  createTemplate(\n    name: string,\n    subject: string,\n    htmlContent: string,\n    textContent: string,\n    variables: string[]\n  ): EmailTemplate {\n    const templateId = `template-${Date.now()}`;\n    const template: EmailTemplate = {\n      id: templateId,\n      name,\n      subject,\n      htmlContent,\n      textContent,\n      variables,\n    };\n\n    this.templates.set(templateId, template);\n    this.emit('template:created', template);\n\n    return template;\n  }\n\n  /**\n   * Get campaign by ID\n   */\n  getCampaign(campaignId: string): EmailCampaign | undefined {\n    return this.campaigns.get(campaignId);\n  }\n\n  /**\n   * Get all campaigns\n   */\n  getAllCampaigns(): EmailCampaign[] {\n    return Array.from(this.campaigns.values());\n  }\n\n  /**\n   * Get message by ID\n   */\n  getMessage(messageId: string): EmailMessage | undefined {\n    return this.messages.get(messageId);\n  }\n\n  /**\n   * Get all messages\n   */\n  getAllMessages(): EmailMessage[] {\n    return Array.from(this.messages.values());\n  }\n\n  /**\n   * Get messages by status\n   */\n  getMessagesByStatus(status: EmailMessage['status']): EmailMessage[] {\n    return Array.from(this.messages.values()).filter((m) => m.status === status);\n  }\n\n  /**\n   * Get campaign statistics\n   */\n  getCampaignStats(campaignId: string) {\n    const campaign = this.campaigns.get(campaignId);\n    if (!campaign) {\n      throw new Error(`Campaign ${campaignId} not found`);\n    }\n\n    return {\n      totalRecipients: campaign.totalRecipients,\n      successCount: campaign.successCount,\n      failureCount: campaign.failureCount,\n      successRate: ((campaign.successCount / campaign.totalRecipients) * 100).toFixed(2),\n      status: campaign.status,\n      sentAt: campaign.sentAt,\n    };\n  }\n\n  /**\n   * Get overall statistics\n   */\n  getStatistics() {\n    const messages = Array.from(this.messages.values());\n    const campaigns = Array.from(this.campaigns.values());\n\n    return {\n      totalMessages: messages.length,\n      totalCampaigns: campaigns.length,\n      sentMessages: messages.filter((m) => m.status === 'sent').length,\n      failedMessages: messages.filter((m) => m.status === 'failed').length,\n      totalRecipients: campaigns.reduce((sum, c) => sum + c.totalRecipients, 0),\n      totalTemplates: this.templates.size,\n      campaignsByStatus: {\n        draft: campaigns.filter((c) => c.status === 'draft').length,\n        scheduled: campaigns.filter((c) => c.status === 'scheduled').length,\n        sending: campaigns.filter((c) => c.status === 'sending').length,\n        completed: campaigns.filter((c) => c.status === 'completed').length,\n        failed: campaigns.filter((c) => c.status === 'failed').length,\n      },\n    };\n  }\n\n  /**\n   * Retry failed message\n   */\n  async retryMessage(messageId: string): Promise<EmailMessage> {\n    const message = this.messages.get(messageId);\n    if (!message) {\n      throw new Error(`Message ${messageId} not found`);\n    }\n\n    return this.sendEmail(message.to, message.subject, message.htmlContent, message.textContent, message.attachments);\n  }\n\n  /**\n   * Validate email address\n   */\n  validateEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n\n  /**\n   * Validate email list\n   */\n  validateEmailList(emails: string[]): { valid: string[]; invalid: string[] } {\n    const valid: string[] = [];\n    const invalid: string[] = [];\n\n    emails.forEach((email) => {\n      if (this.validateEmail(email)) {\n        valid.push(email);\n      } else {\n        invalid.push(email);\n      }\n    });\n\n    return { valid, invalid };\n  }\n}\n
