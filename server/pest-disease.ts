import { EventEmitter } from 'events';\n\nexport type PestType = 'insect' | 'mite' | 'nematode' | 'mollusk' | 'rodent' | 'bird';\nexport type DiseaseType = 'fungal' | 'bacterial' | 'viral' | 'physiological';\nexport type SeverityLevel = 'low' | 'medium' | 'high' | 'critical';\nexport type TreatmentMethod = 'chemical' | 'organic' | 'biological' | 'cultural' | 'mechanical';\n\nexport interface Pest {\n  id: string;\n  name: string;\n  type: PestType;\n  affectedCrops: string[];\n  symptoms: string[];\n  lifecycleDays: number;\n  optimalTemperature: { min: number; max: number };\n  optimalHumidity: { min: number; max: number };\n  treatments: Array<{\n    method: TreatmentMethod;\n    name: string;\n    effectiveness: number; // 0-100\n    applicationDays: number;\n    cost: number;\n    organic: boolean;\n  }>;\n}\n\nexport interface Disease {\n  id: string;\n  name: string;\n  type: DiseaseType;\n  affectedCrops: string[];\n  symptoms: string[];\n  incubationDays: number;\n  spreadConditions: string[];\n  optimalTemperature: { min: number; max: number };\n  optimalHumidity: { min: number; max: number };\n  treatments: Array<{\n    method: TreatmentMethod;\n    name: string;\n    effectiveness: number; // 0-100\n    applicationDays: number;\n    cost: number;\n    organic: boolean;\n  }>;\n}\n\nexport interface PestDiseaseRecord {\n  id: string;\n  farmId: string;\n  fieldId: string;\n  cropId: string;\n  type: 'pest' | 'disease';\n  pestDiseaseId: string;\n  name: string;\n  severity: SeverityLevel;\n  affectedArea: number; // percentage\n  dateDetected: number;\n  dateResolved?: number;\n  treatments: Array<{\n    method: TreatmentMethod;\n    name: string;\n    dateApplied: number;\n    effectiveness: number;\n    cost: number;\n  }>;\n  notes: string;\n}\n\nexport interface PestDiseaseAlert {\n  id: string;\n  farmId: string;\n  fieldId: string;\n  type: 'pest' | 'disease';\n  name: string;\n  riskLevel: number; // 0-100\n  conditions: string[];\n  recommendedActions: string[];\n  generatedAt: number;\n}\n\nexport interface TreatmentPlan {\n  id: string;\n  farmId: string;\n  fieldId: string;\n  recordId: string;\n  treatments: Array<{\n    step: number;\n    method: TreatmentMethod;\n    name: string;\n    scheduledDate: number;\n    cost: number;\n    expectedEffectiveness: number;\n    notes: string;\n  }>;\n  totalCost: number;\n  expectedDuration: number; // days\n  createdAt: number;\n}\n\n/**\n * Pest & Disease Management System\n */\nexport class PestDiseaseManager extends EventEmitter {\n  private pests: Map<string, Pest> = new Map();\n  private diseases: Map<string, Disease> = new Map();\n  private records: Map<string, PestDiseaseRecord> = new Map();\n  private alerts: Map<string, PestDiseaseAlert> = new Map();\n  private treatmentPlans: Map<string, TreatmentPlan> = new Map();\n\n  constructor() {\n    super();\n    this.initializePestsAndDiseases();\n  }\n\n  /**\n   * Initialize default pests and diseases\n   */\n  private initializePestsAndDiseases(): void {\n    // Common pests\n    const pests: Pest[] = [\n      {\n        id: 'pest-aphid',\n        name: 'Aphid',\n        type: 'insect',\n        affectedCrops: ['wheat', 'corn', 'lettuce', 'cabbage'],\n        symptoms: ['curled leaves', 'sticky residue', 'yellowing', 'stunted growth'],\n        lifecycleDays: 7,\n        optimalTemperature: { min: 15, max: 25 },\n        optimalHumidity: { min: 50, max: 80 },\n        treatments: [\n          {\n            method: 'organic',\n            name: 'Neem Oil',\n            effectiveness: 75,\n            applicationDays: 7,\n            cost: 25,\n            organic: true,\n          },\n          {\n            method: 'chemical',\n            name: 'Insecticide',\n            effectiveness: 95,\n            applicationDays: 10,\n            cost: 50,\n            organic: false,\n          },\n          {\n            method: 'biological',\n            name: 'Ladybugs',\n            effectiveness: 70,\n            applicationDays: 14,\n            cost: 30,\n            organic: true,\n          },\n        ],\n      },\n      {\n        id: 'pest-armyworm',\n        name: 'Armyworm',\n        type: 'insect',\n        affectedCrops: ['corn', 'wheat', 'soybean'],\n        symptoms: ['leaf damage', 'holes in leaves', 'wilting'],\n        lifecycleDays: 30,\n        optimalTemperature: { min: 20, max: 30 },\n        optimalHumidity: { min: 60, max: 90 },\n        treatments: [\n          {\n            method: 'chemical',\n            name: 'Pyrethroid',\n            effectiveness: 90,\n            applicationDays: 7,\n            cost: 60,\n            organic: false,\n          },\n          {\n            method: 'organic',\n            name: 'Bt Spray',\n            effectiveness: 80,\n            applicationDays: 5,\n            cost: 35,\n            organic: true,\n          },\n        ],\n      },\n    ];\n\n    const diseases: Disease[] = [\n      {\n        id: 'disease-powdery-mildew',\n        name: 'Powdery Mildew',\n        type: 'fungal',\n        affectedCrops: ['wheat', 'cucumber', 'squash'],\n        symptoms: ['white powder', 'leaf spots', 'reduced photosynthesis'],\n        incubationDays: 3,\n        spreadConditions: ['high humidity', 'poor air circulation', 'moderate temperature'],\n        optimalTemperature: { min: 15, max: 25 },\n        optimalHumidity: { min: 40, max: 60 },\n        treatments: [\n          {\n            method: 'organic',\n            name: 'Sulfur Dust',\n            effectiveness: 85,\n            applicationDays: 7,\n            cost: 20,\n            organic: true,\n          },\n          {\n            method: 'chemical',\n            name: 'Fungicide',\n            effectiveness: 95,\n            applicationDays: 10,\n            cost: 45,\n            organic: false,\n          },\n        ],\n      },\n      {\n        id: 'disease-late-blight',\n        name: 'Late Blight',\n        type: 'fungal',\n        affectedCrops: ['tomato', 'potato'],\n        symptoms: ['water-soaked spots', 'brown lesions', 'white mold'],\n        incubationDays: 2,\n        spreadConditions: ['high humidity', 'cool temperature', 'wet foliage'],\n        optimalTemperature: { min: 10, max: 20 },\n        optimalHumidity: { min: 80, max: 100 },\n        treatments: [\n          {\n            method: 'chemical',\n            name: 'Copper Fungicide',\n            effectiveness: 90,\n            applicationDays: 7,\n            cost: 40,\n            organic: false,\n          },\n          {\n            method: 'cultural',\n            name: 'Remove Infected Plants',\n            effectiveness: 70,\n            applicationDays: 1,\n            cost: 0,\n            organic: true,\n          },\n        ],\n      },\n    ];\n\n    for (const pest of pests) {\n      this.pests.set(pest.id, pest);\n    }\n    for (const disease of diseases) {\n      this.diseases.set(disease.id, disease);\n    }\n  }\n\n  /**\n   * Get pest by ID\n   */\n  getPest(pestId: string): Pest | null {\n    return this.pests.get(pestId) || null;\n  }\n\n  /**\n   * Get disease by ID\n   */\n  getDisease(diseaseId: string): Disease | null {\n    return this.diseases.get(diseaseId) || null;\n  }\n\n  /**\n   * Get pests by affected crop\n   */\n  getPestsByCrop(cropName: string): Pest[] {\n    return Array.from(this.pests.values()).filter((p) => p.affectedCrops.includes(cropName));\n  }\n\n  /**\n   * Get diseases by affected crop\n   */\n  getDiseasesByCrop(cropName: string): Disease[] {\n    return Array.from(this.diseases.values()).filter((d) => d.affectedCrops.includes(cropName));\n  }\n\n  /**\n   * Record pest/disease detection\n   */\n  recordPestDiseaseDetection(\n    farmId: string,\n    fieldId: string,\n    cropId: string,\n    type: 'pest' | 'disease',\n    pestDiseaseId: string,\n    name: string,\n    severity: SeverityLevel,\n    affectedArea: number,\n    notes: string = ''\n  ): PestDiseaseRecord {\n    const recordId = `record_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const record: PestDiseaseRecord = {\n      id: recordId,\n      farmId,\n      fieldId,\n      cropId,\n      type,\n      pestDiseaseId,\n      name,\n      severity,\n      affectedArea,\n      dateDetected: Date.now(),\n      treatments: [],\n      notes,\n    };\n\n    this.records.set(recordId, record);\n    this.emit('record:created', { recordId, farmId, type, name });\n    return record;\n  }\n\n  /**\n   * Get records by field\n   */\n  getRecordsByField(fieldId: string): PestDiseaseRecord[] {\n    return Array.from(this.records.values())\n      .filter((r) => r.fieldId === fieldId)\n      .sort((a, b) => b.dateDetected - a.dateDetected);\n  }\n\n  /**\n   * Get active records (not resolved)\n   */\n  getActiveRecords(fieldId: string): PestDiseaseRecord[] {\n    return this.getRecordsByField(fieldId).filter((r) => !r.dateResolved);\n  }\n\n  /**\n   * Add treatment to record\n   */\n  addTreatmentToRecord(\n    recordId: string,\n    method: TreatmentMethod,\n    name: string,\n    effectiveness: number,\n    cost: number\n  ): PestDiseaseRecord | null {\n    const record = this.records.get(recordId);\n    if (!record) return null;\n\n    record.treatments.push({\n      method,\n      name,\n      dateApplied: Date.now(),\n      effectiveness,\n      cost,\n    });\n\n    this.emit('treatment:added', { recordId, method, name });\n    return record;\n  }\n\n  /**\n   * Resolve record\n   */\n  resolveRecord(recordId: string): PestDiseaseRecord | null {\n    const record = this.records.get(recordId);\n    if (!record) return null;\n\n    record.dateResolved = Date.now();\n    this.emit('record:resolved', { recordId });\n    return record;\n  }\n\n  /**\n   * Generate pest/disease alert based on weather\n   */\n  generateAlert(\n    farmId: string,\n    fieldId: string,\n    type: 'pest' | 'disease',\n    name: string,\n    riskLevel: number,\n    conditions: string[],\n    recommendedActions: string[]\n  ): PestDiseaseAlert {\n    const alertId = `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    const alert: PestDiseaseAlert = {\n      id: alertId,\n      farmId,\n      fieldId,\n      type,\n      name,\n      riskLevel: Math.min(100, Math.max(0, riskLevel)),\n      conditions,\n      recommendedActions,\n      generatedAt: Date.now(),\n    };\n\n    this.alerts.set(alertId, alert);\n    this.emit('alert:generated', { alertId, farmId, type, riskLevel });\n    return alert;\n  }\n\n  /**\n   * Get alerts by field\n   */\n  getAlertsByField(fieldId: string): PestDiseaseAlert[] {\n    return Array.from(this.alerts.values())\n      .filter((a) => a.fieldId === fieldId)\n      .sort((a, b) => b.riskLevel - a.riskLevel);\n  }\n\n  /**\n   * Create treatment plan\n   */\n  createTreatmentPlan(\n    farmId: string,\n    fieldId: string,\n    recordId: string,\n    treatments: Array<{\n      step: number;\n      method: TreatmentMethod;\n      name: string;\n      scheduledDate: number;\n      cost: number;\n      expectedEffectiveness: number;\n      notes: string;\n    }>\n  ): TreatmentPlan {\n    const planId = `plan_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const totalCost = treatments.reduce((sum, t) => sum + t.cost, 0);\n    const expectedDuration = treatments.length > 0 ? treatments[treatments.length - 1].step * 7 : 0;\n\n    const plan: TreatmentPlan = {\n      id: planId,\n      farmId,\n      fieldId,\n      recordId,\n      treatments,\n      totalCost,\n      expectedDuration,\n      createdAt: Date.now(),\n    };\n\n    this.treatmentPlans.set(planId, plan);\n    this.emit('plan:created', { planId, farmId, totalCost });\n    return plan;\n  }\n\n  /**\n   * Get treatment plan\n   */\n  getTreatmentPlan(planId: string): TreatmentPlan | null {\n    return this.treatmentPlans.get(planId) || null;\n  }\n\n  /**\n   * Get treatment plans by field\n   */\n  getTreatmentPlansByField(fieldId: string): TreatmentPlan[] {\n    return Array.from(this.treatmentPlans.values()).filter((p) => p.fieldId === fieldId);\n  }\n\n  /**\n   * Get statistics\n   */\n  getStatistics(): {\n    totalPests: number;\n    totalDiseases: number;\n    totalRecords: number;\n    activeRecords: number;\n    totalAlerts: number;\n    totalTreatmentPlans: number;\n  } {\n    const activeRecords = Array.from(this.records.values()).filter((r) => !r.dateResolved).length;\n\n    return {\n      totalPests: this.pests.size,\n      totalDiseases: this.diseases.size,\n      totalRecords: this.records.size,\n      activeRecords,\n      totalAlerts: this.alerts.size,\n      totalTreatmentPlans: this.treatmentPlans.size,\n    };\n  }\n}\n
