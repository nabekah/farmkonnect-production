import { describe, it, expect, beforeEach, afterEach } from 'vitest';\nimport TemplatePreviewEngine from './template-preview-engine';\nimport AnalyticsExportReporting from './analytics-export-reporting';\n\ndescribe('TemplatePreviewEngine', () => {\n  let engine: TemplatePreviewEngine;\n\n  beforeEach(() => {\n    engine = new TemplatePreviewEngine();\n  });\n\n  afterEach(() => {\n    engine.destroy();\n  });\n\n  describe('Template Rendering', () => {\n    it('should render template with blocks', () => {\n      const blocks = [\n        { type: 'text', content: 'Hello {{name}}' },\n        { type: 'button', content: 'Click Here', url: 'https://example.com' },\n      ];\n\n      const rendered = engine.renderTemplate('tpl-1', blocks, { name: 'John' });\n\n      expect(rendered).toBeDefined();\n      expect(rendered.html).toContain('Hello John');\n      expect(rendered.html).toContain('Click Here');\n    });\n\n    it('should substitute variables', () => {\n      const blocks = [{ type: 'text', content: 'Hello {{firstName}} {{lastName}}' }];\n\n      const rendered = engine.renderTemplate('tpl-1', blocks, {\n        firstName: 'John',\n        lastName: 'Doe',\n      });\n\n      expect(rendered.plainText).toContain('John Doe');\n    });\n\n    it('should render different device types', () => {\n      const blocks = [{ type: 'text', content: 'Test' }];\n\n      const desktopRender = engine.renderTemplate('tpl-1', blocks, {}, { deviceType: 'desktop' });\n      const mobileRender = engine.renderTemplate('tpl-1', blocks, {}, { deviceType: 'mobile' });\n\n      expect(desktopRender).toBeDefined();\n      expect(mobileRender).toBeDefined();\n    });\n\n    it('should handle dark mode', () => {\n      const blocks = [{ type: 'text', content: 'Test' }];\n\n      const darkRender = engine.renderTemplate('tpl-1', blocks, {}, { darkMode: true });\n\n      expect(darkRender.html).toContain('background-color: #1a1a1a');\n    });\n  });\n\n  describe('Block Rendering', () => {\n    it('should render text block', () => {\n      const blocks = [{ type: 'text', content: 'Hello World' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {});\n\n      expect(rendered.html).toContain('Hello World');\n    });\n\n    it('should render image block', () => {\n      const blocks = [{ type: 'image', content: 'https://example.com/image.jpg', alt: 'Test Image' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {});\n\n      expect(rendered.html).toContain('img');\n      expect(rendered.html).toContain('Test Image');\n    });\n\n    it('should render button block', () => {\n      const blocks = [{ type: 'button', content: 'Click Me', url: 'https://example.com' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {});\n\n      expect(rendered.html).toContain('Click Me');\n      expect(rendered.html).toContain('https://example.com');\n    });\n\n    it('should render divider block', () => {\n      const blocks = [{ type: 'divider' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {});\n\n      expect(rendered.html).toContain('hr');\n    });\n\n    it('should render spacer block', () => {\n      const blocks = [{ type: 'spacer', height: 30 }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {});\n\n      expect(rendered.html).toContain('height: 30px');\n    });\n  });\n\n  describe('Client Compatibility', () => {\n    it('should check Gmail compatibility', () => {\n      const blocks = [{ type: 'text', content: 'Test' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {}, { emailClient: 'gmail' });\n\n      expect(rendered.compatibility.length).toBeGreaterThan(0);\n      expect(rendered.compatibility[0].client).toBe('gmail');\n    });\n\n    it('should detect Outlook limitations', () => {\n      const blocks = [{ type: 'text', content: 'Test' }];\n      const rendered = engine.renderTemplate('tpl-1', blocks, {}, { emailClient: 'outlook' });\n\n      expect(rendered.compatibility[0].supportLevel).toBe('partial');\n    });\n  });\n\n  describe('Preview Snapshots', () => {\n    it('should create snapshot', () => {\n      const snapshot = engine.createSnapshot('tpl-1', 'desktop', 'gmail', 'base64data', 600, 800);\n\n      expect(snapshot).toBeDefined();\n      expect(snapshot.deviceType).toBe('desktop');\n      expect(snapshot.emailClient).toBe('gmail');\n    });\n\n    it('should get snapshots for template', () => {\n      engine.createSnapshot('tpl-1', 'desktop', 'gmail', 'data1', 600, 800);\n      engine.createSnapshot('tpl-1', 'mobile', 'gmail', 'data2', 320, 600);\n\n      const snapshots = engine.getSnapshots('tpl-1');\n      expect(snapshots.length).toBe(2);\n    });\n  });\n\n  describe('Rendering Tests', () => {\n    it('should create rendering test', () => {\n      const test = engine.createTest('tpl-1', 'Gmail Desktop Test', {\n        variables: {},\n        deviceType: 'desktop',\n        emailClient: 'gmail',\n        darkMode: false,\n        fontSize: 16,\n      });\n\n      expect(test).toBeDefined();\n      expect(test.testName).toBe('Gmail Desktop Test');\n    });\n\n    it('should run test', () => {\n      const test = engine.createTest('tpl-1', 'Test', {\n        variables: {},\n        deviceType: 'desktop',\n        emailClient: 'gmail',\n        darkMode: false,\n        fontSize: 16,\n      });\n\n      const passed = engine.runTest(test.id);\n      expect(typeof passed).toBe('boolean');\n    });\n\n    it('should get tests for template', () => {\n      engine.createTest('tpl-1', 'Test 1', {\n        variables: {},\n        deviceType: 'desktop',\n        emailClient: 'gmail',\n        darkMode: false,\n        fontSize: 16,\n      });\n      engine.createTest('tpl-1', 'Test 2', {\n        variables: {},\n        deviceType: 'mobile',\n        emailClient: 'outlook',\n        darkMode: false,\n        fontSize: 16,\n      });\n\n      const tests = engine.getTests('tpl-1');\n      expect(tests.length).toBe(2);\n    });\n  });\n\n  describe('Client Test Results', () => {\n    it('should get client test results', () => {\n      engine.createTest('tpl-1', 'Gmail Test', {\n        variables: {},\n        deviceType: 'desktop',\n        emailClient: 'gmail',\n        darkMode: false,\n        fontSize: 16,\n      });\n\n      const results = engine.getClientTestResults('tpl-1');\n      expect(results.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Rendering Report', () => {\n    it('should generate rendering report', () => {\n      engine.createSnapshot('tpl-1', 'desktop', 'gmail', 'data', 600, 800);\n      engine.createTest('tpl-1', 'Test', {\n        variables: {},\n        deviceType: 'desktop',\n        emailClient: 'gmail',\n        darkMode: false,\n        fontSize: 16,\n      });\n\n      const report = engine.getRenderingReport('tpl-1');\n      expect(report).toBeDefined();\n      expect(report.snapshots).toBeGreaterThan(0);\n    });\n  });\n});\n\ndescribe('AnalyticsExportReporting', () => {\n  let reporting: AnalyticsExportReporting;\n\n  beforeEach(() => {\n    reporting = new AnalyticsExportReporting();\n  });\n\n  afterEach(() => {\n    reporting.destroy();\n  });\n\n  describe('Export Jobs', () => {\n    it('should create export job', () => {\n      const job = reporting.createExportJob({\n        format: 'csv',\n        includeMetrics: ['opens', 'clicks'],\n        dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n      });\n\n      expect(job).toBeDefined();\n      expect(job.status).toBe('pending');\n    });\n\n    it('should get export job', async () => {\n      const job = reporting.createExportJob({\n        format: 'csv',\n        includeMetrics: ['opens'],\n        dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n      });\n\n      // Wait for processing\n      await new Promise((resolve) => setTimeout(resolve, 1500));\n\n      const retrieved = reporting.getExportJob(job.id);\n      expect(retrieved).toBeDefined();\n    });\n\n    it('should get export jobs by status', async () => {\n      reporting.createExportJob({\n        format: 'csv',\n        includeMetrics: ['opens'],\n        dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n      });\n\n      const pending = reporting.getExportJobs('pending');\n      expect(pending.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Reports', () => {\n    it('should generate campaign performance report', () => {\n      const data = [\n        { sent: 1000, opens: 300, clicks: 50, conversions: 10 },\n        { sent: 1000, opens: 250, clicks: 40, conversions: 8 },\n      ];\n\n      const report = reporting.generateReport(\n        'Campaign Performance',\n        'campaign_performance',\n        'Monthly campaign metrics',\n        data,\n        'user-1'\n      );\n\n      expect(report).toBeDefined();\n      expect(report.metrics.length).toBeGreaterThan(0);\n    });\n\n    it('should generate recipient engagement report', () => {\n      const data = [\n        { engagement_score: 85, churn_risk: 10 },\n        { engagement_score: 45, churn_risk: 60 },\n      ];\n\n      const report = reporting.generateReport(\n        'Recipient Engagement',\n        'recipient_engagement',\n        'Engagement metrics',\n        data,\n        'user-1'\n      );\n\n      expect(report).toBeDefined();\n      expect(report.type).toBe('recipient_engagement');\n    });\n\n    it('should get report', () => {\n      const generated = reporting.generateReport(\n        'Test Report',\n        'campaign_performance',\n        'Test',\n        [],\n        'user-1'\n      );\n\n      const retrieved = reporting.getReport(generated.id);\n      expect(retrieved?.name).toBe('Test Report');\n    });\n\n    it('should get reports by type', () => {\n      reporting.generateReport('Report 1', 'campaign_performance', 'Test', [], 'user-1');\n      reporting.generateReport('Report 2', 'campaign_performance', 'Test', [], 'user-1');\n      reporting.generateReport('Report 3', 'recipient_engagement', 'Test', [], 'user-1');\n\n      const campaigns = reporting.getReportsByType('campaign_performance');\n      expect(campaigns.length).toBe(2);\n    });\n  });\n\n  describe('Scheduled Reports', () => {\n    it('should create scheduled report', () => {\n      const report = reporting.createScheduledReport(\n        'Daily Report',\n        'campaign_performance',\n        'daily',\n        ['user@example.com'],\n        {\n          format: 'csv',\n          includeMetrics: ['opens', 'clicks'],\n          dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n        }\n      );\n\n      expect(report).toBeDefined();\n      expect(report.frequency).toBe('daily');\n    });\n\n    it('should get scheduled report', () => {\n      const created = reporting.createScheduledReport(\n        'Weekly Report',\n        'campaign_performance',\n        'weekly',\n        ['user@example.com'],\n        {\n          format: 'csv',\n          includeMetrics: ['opens'],\n          dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n        }\n      );\n\n      const retrieved = reporting.getScheduledReport(created.id);\n      expect(retrieved?.frequency).toBe('weekly');\n    });\n\n    it('should get enabled scheduled reports', () => {\n      reporting.createScheduledReport(\n        'Report 1',\n        'campaign_performance',\n        'daily',\n        ['user@example.com'],\n        {\n          format: 'csv',\n          includeMetrics: ['opens'],\n          dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n        }\n      );\n\n      const enabled = reporting.getScheduledReports(true);\n      expect(enabled.length).toBeGreaterThan(0);\n    });\n\n    it('should update scheduled report', () => {\n      const created = reporting.createScheduledReport(\n        'Report',\n        'campaign_performance',\n        'daily',\n        ['user@example.com'],\n        {\n          format: 'csv',\n          includeMetrics: ['opens'],\n          dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n        }\n      );\n\n      const updated = reporting.updateScheduledReport(created.id, { enabled: false });\n      expect(updated).toBe(true);\n    });\n  });\n\n  describe('Report Delivery', () => {\n    it('should deliver report', async () => {\n      const report = reporting.generateReport('Test', 'campaign_performance', 'Test', [], 'user-1');\n\n      const delivery = reporting.deliverReport(report.id, ['user@example.com'], 'email');\n\n      expect(delivery).toBeDefined();\n      expect(delivery.deliveryMethod).toBe('email');\n\n      // Wait for delivery\n      await new Promise((resolve) => setTimeout(resolve, 1500));\n\n      const retrieved = reporting.getReportDelivery(delivery.id);\n      expect(retrieved?.status).toBe('sent');\n    });\n\n    it('should get delivery history', () => {\n      const report = reporting.generateReport('Test', 'campaign_performance', 'Test', [], 'user-1');\n\n      reporting.deliverReport(report.id, ['user1@example.com'], 'email');\n      reporting.deliverReport(report.id, ['user2@example.com'], 'email');\n\n      const history = reporting.getDeliveryHistory(report.id);\n      expect(history.length).toBe(2);\n    });\n  });\n\n  describe('Export Statistics', () => {\n    it('should get export statistics', async () => {\n      reporting.createExportJob({\n        format: 'csv',\n        includeMetrics: ['opens'],\n        dateRange: { start: Date.now() - 30 * 24 * 60 * 60 * 1000, end: Date.now() },\n      });\n\n      // Wait for processing\n      await new Promise((resolve) => setTimeout(resolve, 1500));\n\n      const stats = reporting.getExportStatistics();\n      expect(stats).toBeDefined();\n      expect(stats.totalExports).toBeGreaterThan(0);\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let engine: TemplatePreviewEngine;\n  let reporting: AnalyticsExportReporting;\n\n  beforeEach(() => {\n    engine = new TemplatePreviewEngine();\n    reporting = new AnalyticsExportReporting();\n  });\n\n  afterEach(() => {\n    engine.destroy();\n    reporting.destroy();\n  });\n\n  it('should integrate preview and reporting', () => {\n    // Create and render template\n    const blocks = [{ type: 'text', content: 'Hello {{name}}' }];\n    const rendered = engine.renderTemplate('tpl-1', blocks, { name: 'John' });\n\n    // Generate report\n    const report = reporting.generateReport(\n      'Template Report',\n      'campaign_performance',\n      'Template performance',\n      [],\n      'user-1'\n    );\n\n    expect(rendered).toBeDefined();\n    expect(report).toBeDefined();\n  });\n});\n
