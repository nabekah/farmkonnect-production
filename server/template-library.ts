import { EventEmitter } from 'events';\n\nexport type TemplateCategory =\n  | 'welcome'\n  | 'password_reset'\n  | 'order_confirmation'\n  | 'alert'\n  | 'promotion'\n  | 'reminder'\n  | 'custom';\n\nexport type TemplateChannel = 'sms' | 'email' | 'both';\n\nexport interface TemplateVariable {\n  name: string;\n  type: 'string' | 'number' | 'date' | 'url';\n  required: boolean;\n  defaultValue?: string;\n  description?: string;\n}\n\nexport interface NotificationTemplate {\n  id: string;\n  name: string;\n  category: TemplateCategory;\n  channel: TemplateChannel;\n  smsContent?: string;\n  emailSubject?: string;\n  emailHtmlContent?: string;\n  emailTextContent?: string;\n  variables: TemplateVariable[];\n  tags: string[];\n  isPrebuilt: boolean;\n  createdAt: number;\n  updatedAt: number;\n  usageCount: number;\n  lastUsedAt?: number;\n}\n\nexport interface TemplateUsageStats {\n  templateId: string;\n  templateName: string;\n  totalUsage: number;\n  lastUsed?: number;\n  successRate: number;\n  averageOpenRate?: number;\n  averageClickRate?: number;\n}\n\nclass TemplateLibrary extends EventEmitter {\n  private templates: Map<string, NotificationTemplate> = new Map();\n  private usageStats: Map<string, TemplateUsageStats> = new Map();\n  private prebuiltTemplates: NotificationTemplate[] = [];\n\n  constructor() {\n    super();\n    this.initializePrebuiltTemplates();\n  }\n\n  /**\n   * Initialize prebuilt templates\n   */\n  private initializePrebuiltTemplates(): void {\n    // Welcome template\n    const welcomeTemplate: NotificationTemplate = {\n      id: 'tpl-welcome-001',\n      name: 'Welcome to FarmKonnect',\n      category: 'welcome',\n      channel: 'both',\n      smsContent: 'Welcome {{firstName}}! Get started with FarmKonnect: {{loginUrl}}',\n      emailSubject: 'Welcome to FarmKonnect, {{firstName}}!',\n      emailHtmlContent: `\n        <h1>Welcome {{firstName}}!</h1>\n        <p>We're excited to have you join FarmKonnect.</p>\n        <p><a href=\"{{loginUrl}}\">Get Started</a></p>\n      `,\n      emailTextContent: 'Welcome {{firstName}}! Get started: {{loginUrl}}',\n      variables: [\n        { name: 'firstName', type: 'string', required: true, description: 'User first name' },\n        { name: 'loginUrl', type: 'url', required: true, description: 'Login URL' },\n      ],\n      tags: ['onboarding', 'welcome'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    // Password reset template\n    const passwordResetTemplate: NotificationTemplate = {\n      id: 'tpl-password-reset-001',\n      name: 'Password Reset Request',\n      category: 'password_reset',\n      channel: 'email',\n      emailSubject: 'Reset Your Password',\n      emailHtmlContent: `\n        <h2>Password Reset Request</h2>\n        <p>Hi {{firstName}},</p>\n        <p>We received a request to reset your password.</p>\n        <p><a href=\"{{resetLink}}\">Reset Password</a></p>\n        <p>This link expires in {{expirationHours}} hours.</p>\n      `,\n      emailTextContent: 'Reset your password: {{resetLink}} (expires in {{expirationHours}} hours)',\n      variables: [\n        { name: 'firstName', type: 'string', required: true },\n        { name: 'resetLink', type: 'url', required: true },\n        { name: 'expirationHours', type: 'number', required: true, defaultValue: '24' },\n      ],\n      tags: ['security', 'password'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    // Order confirmation template\n    const orderConfirmationTemplate: NotificationTemplate = {\n      id: 'tpl-order-confirmation-001',\n      name: 'Order Confirmation',\n      category: 'order_confirmation',\n      channel: 'both',\n      smsContent: 'Order {{orderId}} confirmed! Total: {{amount}}. Track: {{trackingUrl}}',\n      emailSubject: 'Order {{orderId}} Confirmed',\n      emailHtmlContent: `\n        <h2>Order Confirmed</h2>\n        <p>Hi {{firstName}},</p>\n        <p>Your order {{orderId}} has been confirmed.</p>\n        <p><strong>Total: {{amount}}</strong></p>\n        <p><a href=\"{{trackingUrl}}\">Track Order</a></p>\n      `,\n      emailTextContent: 'Order {{orderId}} confirmed. Total: {{amount}}. Track: {{trackingUrl}}',\n      variables: [\n        { name: 'firstName', type: 'string', required: true },\n        { name: 'orderId', type: 'string', required: true },\n        { name: 'amount', type: 'string', required: true },\n        { name: 'trackingUrl', type: 'url', required: true },\n      ],\n      tags: ['commerce', 'order'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    // Alert template\n    const alertTemplate: NotificationTemplate = {\n      id: 'tpl-alert-001',\n      name: 'Important Alert',\n      category: 'alert',\n      channel: 'both',\n      smsContent: 'Alert: {{alertMessage}} Details: {{detailsUrl}}',\n      emailSubject: 'Alert: {{alertTitle}}',\n      emailHtmlContent: `\n        <h2 style=\"color: #d32f2f;\">Alert</h2>\n        <p>{{alertMessage}}</p>\n        <p><a href=\"{{detailsUrl}}\">View Details</a></p>\n      `,\n      emailTextContent: 'Alert: {{alertMessage}} Details: {{detailsUrl}}',\n      variables: [\n        { name: 'alertTitle', type: 'string', required: true },\n        { name: 'alertMessage', type: 'string', required: true },\n        { name: 'detailsUrl', type: 'url', required: true },\n      ],\n      tags: ['urgent', 'alert'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    // Promotion template\n    const promotionTemplate: NotificationTemplate = {\n      id: 'tpl-promotion-001',\n      name: 'Special Offer',\n      category: 'promotion',\n      channel: 'both',\n      smsContent: '{{discount}}% off {{productName}}! Use code {{promoCode}}. {{offerUrl}}',\n      emailSubject: 'Exclusive: {{discount}}% Off {{productName}}',\n      emailHtmlContent: `\n        <h2>Special Offer</h2>\n        <p>Hi {{firstName}},</p>\n        <p>Get {{discount}}% off {{productName}}!</p>\n        <p>Use code: <strong>{{promoCode}}</strong></p>\n        <p><a href=\"{{offerUrl}}\" style=\"background: #4CAF50; color: white; padding: 10px 20px; text-decoration: none;\">Shop Now</a></p>\n      `,\n      emailTextContent: 'Get {{discount}}% off {{productName}}! Code: {{promoCode}} {{offerUrl}}',\n      variables: [\n        { name: 'firstName', type: 'string', required: true },\n        { name: 'productName', type: 'string', required: true },\n        { name: 'discount', type: 'number', required: true },\n        { name: 'promoCode', type: 'string', required: true },\n        { name: 'offerUrl', type: 'url', required: true },\n      ],\n      tags: ['marketing', 'promotion'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    // Reminder template\n    const reminderTemplate: NotificationTemplate = {\n      id: 'tpl-reminder-001',\n      name: 'Task Reminder',\n      category: 'reminder',\n      channel: 'both',\n      smsContent: 'Reminder: {{taskName}} due {{dueDate}}. {{actionUrl}}',\n      emailSubject: 'Reminder: {{taskName}}',\n      emailHtmlContent: `\n        <h2>Task Reminder</h2>\n        <p>Hi {{firstName}},</p>\n        <p>This is a reminder about: <strong>{{taskName}}</strong></p>\n        <p>Due: {{dueDate}}</p>\n        <p><a href=\"{{actionUrl}}\">Take Action</a></p>\n      `,\n      emailTextContent: 'Reminder: {{taskName}} due {{dueDate}}. {{actionUrl}}',\n      variables: [\n        { name: 'firstName', type: 'string', required: true },\n        { name: 'taskName', type: 'string', required: true },\n        { name: 'dueDate', type: 'date', required: true },\n        { name: 'actionUrl', type: 'url', required: true },\n      ],\n      tags: ['reminder', 'task'],\n      isPrebuilt: true,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    this.prebuiltTemplates = [\n      welcomeTemplate,\n      passwordResetTemplate,\n      orderConfirmationTemplate,\n      alertTemplate,\n      promotionTemplate,\n      reminderTemplate,\n    ];\n\n    for (const template of this.prebuiltTemplates) {\n      this.templates.set(template.id, template);\n    }\n  }\n\n  /**\n   * Get prebuilt templates\n   */\n  getPrebuiltTemplates(): NotificationTemplate[] {\n    return [...this.prebuiltTemplates];\n  }\n\n  /**\n   * Get template by ID\n   */\n  getTemplate(templateId: string): NotificationTemplate | undefined {\n    return this.templates.get(templateId);\n  }\n\n  /**\n   * Get templates by category\n   */\n  getTemplatesByCategory(category: TemplateCategory): NotificationTemplate[] {\n    return Array.from(this.templates.values()).filter((t) => t.category === category);\n  }\n\n  /**\n   * Get templates by channel\n   */\n  getTemplatesByChannel(channel: TemplateChannel): NotificationTemplate[] {\n    return Array.from(this.templates.values()).filter((t) => t.channel === channel);\n  }\n\n  /**\n   * Create custom template\n   */\n  createTemplate(\n    name: string,\n    category: TemplateCategory,\n    channel: TemplateChannel,\n    content: {\n      smsContent?: string;\n      emailSubject?: string;\n      emailHtmlContent?: string;\n      emailTextContent?: string;\n    },\n    variables: TemplateVariable[] = [],\n    tags: string[] = []\n  ): NotificationTemplate {\n    const template: NotificationTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name,\n      category,\n      channel,\n      smsContent: content.smsContent,\n      emailSubject: content.emailSubject,\n      emailHtmlContent: content.emailHtmlContent,\n      emailTextContent: content.emailTextContent,\n      variables,\n      tags,\n      isPrebuilt: false,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    this.templates.set(template.id, template);\n    this.emit('template:created', template);\n    return template;\n  }\n\n  /**\n   * Update template\n   */\n  updateTemplate(\n    templateId: string,\n    updates: Partial<NotificationTemplate>\n  ): boolean {\n    const template = this.templates.get(templateId);\n    if (!template || template.isPrebuilt) return false;\n\n    Object.assign(template, updates, { updatedAt: Date.now() });\n    this.emit('template:updated', template);\n    return true;\n  }\n\n  /**\n   * Delete template\n   */\n  deleteTemplate(templateId: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template || template.isPrebuilt) return false;\n\n    this.templates.delete(templateId);\n    this.usageStats.delete(templateId);\n    this.emit('template:deleted', template);\n    return true;\n  }\n\n  /**\n   * Record template usage\n   */\n  recordUsage(\n    templateId: string,\n    successRate: number = 100,\n    openRate?: number,\n    clickRate?: number\n  ): void {\n    const template = this.templates.get(templateId);\n    if (!template) return;\n\n    template.usageCount++;\n    template.lastUsedAt = Date.now();\n\n    let stats = this.usageStats.get(templateId);\n    if (!stats) {\n      stats = {\n        templateId,\n        templateName: template.name,\n        totalUsage: 0,\n        successRate: 100,\n      };\n      this.usageStats.set(templateId, stats);\n    }\n\n    stats.totalUsage++;\n    stats.lastUsed = Date.now();\n    stats.successRate = successRate;\n    if (openRate !== undefined) stats.averageOpenRate = openRate;\n    if (clickRate !== undefined) stats.averageClickRate = clickRate;\n\n    this.emit('template:used', { templateId, successRate });\n  }\n\n  /**\n   * Get template usage stats\n   */\n  getUsageStats(templateId: string): TemplateUsageStats | undefined {\n    return this.usageStats.get(templateId);\n  }\n\n  /**\n   * Get all usage stats\n   */\n  getAllUsageStats(): TemplateUsageStats[] {\n    return Array.from(this.usageStats.values());\n  }\n\n  /**\n   * Get popular templates\n   */\n  getPopularTemplates(limit: number = 10): NotificationTemplate[] {\n    return Array.from(this.templates.values())\n      .sort((a, b) => b.usageCount - a.usageCount)\n      .slice(0, limit);\n  }\n\n  /**\n   * Search templates\n   */\n  searchTemplates(query: string): NotificationTemplate[] {\n    const lowerQuery = query.toLowerCase();\n    return Array.from(this.templates.values()).filter(\n      (t) =>\n        t.name.toLowerCase().includes(lowerQuery) ||\n        t.tags.some((tag) => tag.toLowerCase().includes(lowerQuery)) ||\n        t.category.toLowerCase().includes(lowerQuery)\n    );\n  }\n\n  /**\n   * Clone template\n   */\n  cloneTemplate(templateId: string, newName: string): NotificationTemplate | null {\n    const original = this.templates.get(templateId);\n    if (!original) return null;\n\n    const cloned: NotificationTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name: newName,\n      category: original.category,\n      channel: original.channel,\n      smsContent: original.smsContent,\n      emailSubject: original.emailSubject,\n      emailHtmlContent: original.emailHtmlContent,\n      emailTextContent: original.emailTextContent,\n      variables: [...original.variables],\n      tags: [...original.tags],\n      isPrebuilt: false,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      usageCount: 0,\n    };\n\n    this.templates.set(cloned.id, cloned);\n    this.emit('template:cloned', { original, cloned });\n    return cloned;\n  }\n\n  /**\n   * Get all templates\n   */\n  getAllTemplates(): NotificationTemplate[] {\n    return Array.from(this.templates.values());\n  }\n\n  /**\n   * Get template count\n   */\n  getTemplateCount(): { total: number; prebuilt: number; custom: number } {\n    const all = this.getAllTemplates();\n    const prebuilt = all.filter((t) => t.isPrebuilt).length;\n    return {\n      total: all.length,\n      prebuilt,\n      custom: all.length - prebuilt,\n    };\n  }\n}\n\nexport default TemplateLibrary;\n
