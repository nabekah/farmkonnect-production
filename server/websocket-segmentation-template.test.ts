import { describe, it, expect, beforeEach } from 'vitest';\nimport WebSocketLayer from './websocket-layer';\nimport UserSegmentationSystem from './user-segmentation';\nimport NotificationTemplateBuilder from './template-builder';\n\ndescribe('WebSocketLayer', () => {\n  let wsLayer: WebSocketLayer;\n\n  beforeEach(() => {\n    wsLayer = new WebSocketLayer();\n  });\n\n  describe('Connection Management', () => {\n    it('should create connection', () => {\n      const conn = wsLayer.createConnection('user-1', { device: 'mobile' });\n\n      expect(conn).toBeDefined();\n      expect(conn.userId).toBe('user-1');\n      expect(conn.status).toBe('connected');\n    });\n\n    it('should close connection', () => {\n      const conn = wsLayer.createConnection('user-1');\n      const closed = wsLayer.closeConnection(conn.id);\n\n      expect(closed).toBe(true);\n    });\n\n    it('should get user connections', () => {\n      wsLayer.createConnection('user-1');\n      wsLayer.createConnection('user-1');\n      wsLayer.createConnection('user-2');\n\n      const conns = wsLayer.getUserConnections('user-1');\n      expect(conns.length).toBe(2);\n    });\n  });\n\n  describe('Messaging', () => {\n    it('should send message', async () => {\n      wsLayer.createConnection('user-1');\n      const msg = await wsLayer.sendMessage('user-1', 'notification', { text: 'Hello' });\n\n      expect(msg).toBeDefined();\n      expect(msg.type).toBe('notification');\n    });\n\n    it('should broadcast message', async () => {\n      wsLayer.createConnection('user-1');\n      wsLayer.createConnection('user-2');\n\n      const msgs = await wsLayer.broadcastMessage(\n        ['user-1', 'user-2'],\n        'alert',\n        { severity: 'high' }\n      );\n\n      expect(msgs.length).toBe(2);\n    });\n\n    it('should get message history', async () => {\n      wsLayer.createConnection('user-1');\n      await wsLayer.sendMessage('user-1', 'notification', { text: 'Msg 1' });\n      await wsLayer.sendMessage('user-1', 'notification', { text: 'Msg 2' });\n\n      const history = wsLayer.getMessageHistory('user-1');\n      expect(history.length).toBeGreaterThanOrEqual(2);\n    });\n  });\n\n  describe('Subscriptions', () => {\n    it('should subscribe to channel', () => {\n      const sub = wsLayer.subscribe('user-1', 'notifications');\n\n      expect(sub).toBeDefined();\n      expect(sub.channel).toBe('notifications');\n    });\n\n    it('should unsubscribe from channel', () => {\n      const sub = wsLayer.subscribe('user-1', 'notifications');\n      const unsubbed = wsLayer.unsubscribe('user-1', sub.id);\n\n      expect(unsubbed).toBe(true);\n    });\n\n    it('should publish to channel', async () => {\n      wsLayer.subscribe('user-1', 'alerts');\n      wsLayer.subscribe('user-2', 'alerts');\n\n      const count = await wsLayer.publishToChannel('alerts', 'alert', { level: 'high' });\n      expect(count).toBeGreaterThanOrEqual(2);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should get statistics', async () => {\n      wsLayer.createConnection('user-1');\n      await wsLayer.sendMessage('user-1', 'notification', { text: 'Test' });\n      wsLayer.recordLatency(50);\n\n      const stats = wsLayer.getStatistics();\n      expect(stats).toBeDefined();\n      expect(stats.activeConnections).toBeGreaterThan(0);\n    });\n  });\n});\n\ndescribe('UserSegmentationSystem', () => {\n  let segmentation: UserSegmentationSystem;\n\n  beforeEach(() => {\n    segmentation = new UserSegmentationSystem();\n  });\n\n  describe('Segment Creation', () => {\n    it('should create segment', () => {\n      const segment = segmentation.createSegment(\n        'Premium Users',\n        'Users with premium subscription',\n        'demographic',\n        []\n      );\n\n      expect(segment).toBeDefined();\n      expect(segment.name).toBe('Premium Users');\n    });\n  });\n\n  describe('User Profiles', () => {\n    it('should add user profile', () => {\n      segmentation.addUserProfile({\n        userId: 'user-1',\n        email: 'user@example.com',\n        role: 'admin',\n        joinedAt: Date.now(),\n        lastActiveAt: Date.now(),\n        properties: { tier: 'premium' },\n      });\n\n      const stats = segmentation.getStatistics();\n      expect(stats.totalUsers).toBeGreaterThan(0);\n    });\n\n    it('should update user profile', () => {\n      segmentation.addUserProfile({\n        userId: 'user-1',\n        email: 'user@example.com',\n        role: 'user',\n        joinedAt: Date.now(),\n        lastActiveAt: Date.now(),\n        properties: {},\n      });\n\n      const updated = segmentation.updateUserProfile('user-1', { role: 'admin' });\n      expect(updated).toBe(true);\n    });\n  });\n\n  describe('Segment Evaluation', () => {\n    beforeEach(() => {\n      segmentation.addUserProfile({\n        userId: 'user-1',\n        email: 'user@example.com',\n        role: 'admin',\n        joinedAt: Date.now(),\n        lastActiveAt: Date.now(),\n        properties: { tier: 'premium' },\n      });\n\n      segmentation.addUserProfile({\n        userId: 'user-2',\n        email: 'user2@example.com',\n        role: 'user',\n        joinedAt: Date.now(),\n        lastActiveAt: Date.now(),\n        properties: { tier: 'free' },\n      });\n    });\n\n    it('should evaluate segment', () => {\n      const segment = segmentation.createSegment('Admins', 'Admin users', 'demographic', [\n        {\n          id: 'group-1',\n          operator: 'AND',\n          rules: [\n            {\n              id: 'rule-1',\n              field: 'role',\n              operator: 'equals',\n              value: 'admin',\n            },\n          ],\n        },\n      ]);\n\n      const members = segmentation.evaluateSegment(segment.id);\n      expect(members.has('user-1')).toBe(true);\n      expect(members.has('user-2')).toBe(false);\n    });\n\n    it('should get user segments', () => {\n      const segment = segmentation.createSegment('Admins', 'Admin users', 'demographic', [\n        {\n          id: 'group-1',\n          operator: 'AND',\n          rules: [\n            {\n              id: 'rule-1',\n              field: 'role',\n              operator: 'equals',\n              value: 'admin',\n            },\n          ],\n        },\n      ]);\n\n      segmentation.evaluateSegment(segment.id);\n      const userSegments = segmentation.getUserSegments('user-1');\n\n      expect(userSegments.some((s) => s.id === segment.id)).toBe(true);\n    });\n  });\n\n  describe('Segment Management', () => {\n    it('should activate segment', () => {\n      const segment = segmentation.createSegment('Test', 'Test segment', 'demographic', []);\n      segmentation.deactivateSegment(segment.id);\n\n      const activated = segmentation.activateSegment(segment.id);\n      expect(activated).toBe(true);\n    });\n\n    it('should delete segment', () => {\n      const segment = segmentation.createSegment('Test', 'Test segment', 'demographic', []);\n      const deleted = segmentation.deleteSegment(segment.id);\n\n      expect(deleted).toBe(true);\n    });\n  });\n});\n\ndescribe('NotificationTemplateBuilder', () => {\n  let builder: NotificationTemplateBuilder;\n\n  beforeEach(() => {\n    builder = new NotificationTemplateBuilder();\n  });\n\n  describe('Template Creation', () => {\n    it('should create template', () => {\n      const template = builder.createTemplate(\n        'Welcome Email',\n        'Welcome message for new users',\n        'email',\n        'Welcome {{name}}!',\n        'admin'\n      );\n\n      expect(template).toBeDefined();\n      expect(template.name).toBe('Welcome Email');\n    });\n\n    it('should create template with variables', () => {\n      const template = builder.createTemplate(\n        'Alert',\n        'Alert template',\n        'email',\n        'Alert: {{message}}',\n        'admin',\n        {\n          variables: [\n            { name: 'message', type: 'string', required: true },\n            { name: 'severity', type: 'string', required: false, defaultValue: 'normal' },\n          ],\n        }\n      );\n\n      expect(template.variables.length).toBe(2);\n    });\n  });\n\n  describe('Template Rendering', () => {\n    it('should render template', () => {\n      const template = builder.createTemplate(\n        'Welcome',\n        'Welcome template',\n        'email',\n        'Hello {{name}}, welcome to {{app}}!',\n        'admin',\n        {\n          variables: [\n            { name: 'name', type: 'string', required: true },\n            { name: 'app', type: 'string', required: true },\n          ],\n        }\n      );\n\n      const rendered = builder.renderTemplate(template.id, {\n        name: 'John',\n        app: 'FarmKonnect',\n      });\n\n      expect(rendered).toBeDefined();\n      expect(rendered?.body).toContain('John');\n      expect(rendered?.body).toContain('FarmKonnect');\n    });\n\n    it('should render template with default values', () => {\n      const template = builder.createTemplate(\n        'Alert',\n        'Alert template',\n        'email',\n        'Severity: {{severity}}',\n        'admin',\n        {\n          variables: [\n            { name: 'severity', type: 'string', required: false, defaultValue: 'low' },\n          ],\n        }\n      );\n\n      const rendered = builder.renderTemplate(template.id, {});\n      expect(rendered?.body).toContain('low');\n    });\n  });\n\n  describe('Variables Management', () => {\n    it('should add variable', () => {\n      const template = builder.createTemplate(\n        'Test',\n        'Test template',\n        'email',\n        'Body',\n        'admin'\n      );\n\n      const added = builder.addVariable(template.id, {\n        name: 'username',\n        type: 'string',\n        required: true,\n      });\n\n      expect(added).toBe(true);\n    });\n\n    it('should remove variable', () => {\n      const template = builder.createTemplate(\n        'Test',\n        'Test template',\n        'email',\n        'Body',\n        'admin',\n        {\n          variables: [\n            { name: 'username', type: 'string', required: true },\n          ],\n        }\n      );\n\n      const removed = builder.removeVariable(template.id, 'username');\n      expect(removed).toBe(true);\n    });\n  });\n\n  describe('Template Versioning', () => {\n    it('should track template versions', () => {\n      const template = builder.createTemplate(\n        'Test',\n        'Test template',\n        'email',\n        'Body v1',\n        'admin'\n      );\n\n      builder.updateTemplate(template.id, { body: 'Body v2' }, 'admin');\n\n      const versions = builder.getTemplateVersions(template.id);\n      expect(versions.length).toBeGreaterThanOrEqual(2);\n    });\n\n    it('should restore template version', () => {\n      const template = builder.createTemplate(\n        'Test',\n        'Test template',\n        'email',\n        'Body v1',\n        'admin'\n      );\n\n      builder.updateTemplate(template.id, { body: 'Body v2' }, 'admin');\n      const restored = builder.restoreVersion(template.id, 1, 'admin');\n\n      expect(restored).toBe(true);\n    });\n  });\n\n  describe('Template Management', () => {\n    it('should list templates', () => {\n      builder.createTemplate('Email 1', 'Email template', 'email', 'Body', 'admin');\n      builder.createTemplate('SMS 1', 'SMS template', 'sms', 'Body', 'admin');\n\n      const emailTemplates = builder.listTemplates('email');\n      expect(emailTemplates.length).toBeGreaterThan(0);\n    });\n\n    it('should duplicate template', () => {\n      const original = builder.createTemplate(\n        'Original',\n        'Original template',\n        'email',\n        'Body',\n        'admin'\n      );\n\n      const duplicated = builder.duplicateTemplate(original.id, 'Duplicated', 'admin');\n      expect(duplicated).toBeDefined();\n      expect(duplicated?.name).toBe('Duplicated');\n    });\n\n    it('should activate/deactivate template', () => {\n      const template = builder.createTemplate(\n        'Test',\n        'Test template',\n        'email',\n        'Body',\n        'admin'\n      );\n\n      builder.deactivateTemplate(template.id);\n      const activated = builder.activateTemplate(template.id);\n\n      expect(activated).toBe(true);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should get statistics', () => {\n      builder.createTemplate('Email', 'Email template', 'email', 'Body', 'admin');\n      builder.createTemplate('SMS', 'SMS template', 'sms', 'Body', 'admin');\n\n      const stats = builder.getStatistics();\n      expect(stats.totalTemplates).toBeGreaterThanOrEqual(2);\n    });\n  });\n});\n\ndescribe('Integration Tests', () => {\n  let wsLayer: WebSocketLayer;\n  let segmentation: UserSegmentationSystem;\n  let builder: NotificationTemplateBuilder;\n\n  beforeEach(() => {\n    wsLayer = new WebSocketLayer();\n    segmentation = new UserSegmentationSystem();\n    builder = new NotificationTemplateBuilder();\n  });\n\n  it('should integrate WebSocket with segmentation', () => {\n    // Create segment\n    const segment = segmentation.createSegment('Active Users', 'Active users', 'behavioral', []);\n\n    // Add users\n    segmentation.addUserProfile({\n      userId: 'user-1',\n      email: 'user@example.com',\n      role: 'user',\n      joinedAt: Date.now(),\n      lastActiveAt: Date.now(),\n      properties: {},\n    });\n\n    // Create connection\n    wsLayer.createConnection('user-1');\n\n    expect(wsLayer.getActiveConnectionsCount()).toBeGreaterThan(0);\n  });\n\n  it('should integrate template with WebSocket messaging', async () => {\n    // Create template\n    const template = builder.createTemplate(\n      'Notification',\n      'Notification template',\n      'in_app',\n      'Hello {{name}}',\n      'admin',\n      {\n        variables: [{ name: 'name', type: 'string', required: true }],\n      }\n    );\n\n    // Render template\n    const rendered = builder.renderTemplate(template.id, { name: 'John' });\n\n    // Create connection and send message\n    wsLayer.createConnection('user-1');\n    const msg = await wsLayer.sendMessage('user-1', 'notification', {\n      content: rendered?.body,\n    });\n\n    expect(msg).toBeDefined();\n  });\n\n  it('should send templated messages to segment', async () => {\n    // Create segment\n    const segment = segmentation.createSegment('Admins', 'Admin users', 'demographic', [\n      {\n        id: 'group-1',\n        operator: 'AND',\n        rules: [\n          {\n            id: 'rule-1',\n            field: 'role',\n            operator: 'equals',\n            value: 'admin',\n          },\n        ],\n      },\n    ]);\n\n    // Add users\n    segmentation.addUserProfile({\n      userId: 'user-1',\n      email: 'admin@example.com',\n      role: 'admin',\n      joinedAt: Date.now(),\n      lastActiveAt: Date.now(),\n      properties: {},\n    });\n\n    // Evaluate segment\n    const members = segmentation.evaluateSegment(segment.id);\n\n    // Create connections\n    for (const userId of members) {\n      wsLayer.createConnection(userId);\n    }\n\n    // Create template\n    const template = builder.createTemplate(\n      'Admin Alert',\n      'Alert for admins',\n      'in_app',\n      'Alert: {{message}}',\n      'admin',\n      {\n        variables: [{ name: 'message', type: 'string', required: true }],\n      }\n    );\n\n    // Send to segment\n    const rendered = builder.renderTemplate(template.id, { message: 'System update' });\n    const messages = await wsLayer.broadcastMessage(\n      Array.from(members),\n      'alert',\n      { content: rendered?.body }\n    );\n\n    expect(messages.length).toBe(members.size);\n  });\n});\n
