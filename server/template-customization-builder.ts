import { EventEmitter } from 'events';\n\nexport type BlockType = 'text' | 'image' | 'button' | 'divider' | 'spacer' | 'conditional' | 'loop';\nexport type ConditionOperator = 'equals' | 'not_equals' | 'contains' | 'greater_than' | 'less_than';\n\nexport interface TemplateBlock {\n  id: string;\n  type: BlockType;\n  order: number;\n  content?: string;\n  styling?: {\n    fontSize?: number;\n    color?: string;\n    backgroundColor?: string;\n    alignment?: 'left' | 'center' | 'right';\n    padding?: number;\n  };\n  metadata?: Record<string, any>;\n}\n\nexport interface TextBlock extends TemplateBlock {\n  type: 'text';\n  content: string;\n}\n\nexport interface ImageBlock extends TemplateBlock {\n  type: 'image';\n  imageUrl: string;\n  altText?: string;\n  width?: number;\n  height?: number;\n}\n\nexport interface ButtonBlock extends TemplateBlock {\n  type: 'button';\n  text: string;\n  url: string;\n  backgroundColor?: string;\n  textColor?: string;\n}\n\nexport interface ConditionalBlock extends TemplateBlock {\n  type: 'conditional';\n  variable: string;\n  operator: ConditionOperator;\n  value: string;\n  trueBlocks: TemplateBlock[];\n  falseBlocks?: TemplateBlock[];\n}\n\nexport interface LoopBlock extends TemplateBlock {\n  type: 'loop';\n  variable: string;\n  items: string[];\n  blocks: TemplateBlock[];\n}\n\nexport interface CustomTemplate {\n  id: string;\n  name: string;\n  baseTemplateId: string;\n  blocks: TemplateBlock[];\n  variables: Map<string, string>;\n  variants: CustomTemplate[];\n  previewUrl?: string;\n  createdAt: number;\n  updatedAt: number;\n  version: number;\n}\n\nexport interface TemplateVariant {\n  id: string;\n  name: string;\n  templateId: string;\n  blocks: TemplateBlock[];\n  testWeight: number; // 0-100\n  performanceMetrics?: {\n    opens: number;\n    clicks: number;\n    conversions: number;\n  };\n}\n\nexport interface BlockPreset {\n  id: string;\n  name: string;\n  category: string;\n  block: TemplateBlock;\n  thumbnail?: string;\n  usageCount: number;\n}\n\nclass TemplateCustomizationBuilder extends EventEmitter {\n  private templates: Map<string, CustomTemplate> = new Map();\n  private variants: Map<string, TemplateVariant> = new Map();\n  private blockPresets: Map<string, BlockPreset> = new Map();\n  private presets: BlockPreset[] = [];\n\n  constructor() {\n    super();\n    this.initializePresets();\n  }\n\n  /**\n   * Initialize block presets\n   */\n  private initializePresets(): void {\n    const presets: BlockPreset[] = [\n      {\n        id: 'preset-header',\n        name: 'Header',\n        category: 'common',\n        block: {\n          id: 'block-header',\n          type: 'text',\n          order: 0,\n          content: 'Welcome to {{firstName}}',\n          styling: {\n            fontSize: 24,\n            color: '#000000',\n            alignment: 'center',\n            padding: 20,\n          },\n        },\n        usageCount: 0,\n      },\n      {\n        id: 'preset-cta-button',\n        name: 'Call-to-Action Button',\n        category: 'interactive',\n        block: {\n          id: 'block-cta',\n          type: 'button',\n          order: 1,\n          text: 'Click Here',\n          url: '{{actionUrl}}',\n          backgroundColor: '#4CAF50',\n          textColor: '#FFFFFF',\n        },\n        usageCount: 0,\n      },\n      {\n        id: 'preset-divider',\n        name: 'Divider',\n        category: 'layout',\n        block: {\n          id: 'block-divider',\n          type: 'divider',\n          order: 2,\n          styling: {\n            color: '#CCCCCC',\n          },\n        },\n        usageCount: 0,\n      },\n      {\n        id: 'preset-spacer',\n        name: 'Spacer',\n        category: 'layout',\n        block: {\n          id: 'block-spacer',\n          type: 'spacer',\n          order: 3,\n          metadata: { height: 20 },\n        },\n        usageCount: 0,\n      },\n      {\n        id: 'preset-footer',\n        name: 'Footer',\n        category: 'common',\n        block: {\n          id: 'block-footer',\n          type: 'text',\n          order: 99,\n          content: 'Â© 2026 FarmKonnect. All rights reserved.',\n          styling: {\n            fontSize: 12,\n            color: '#999999',\n            alignment: 'center',\n            padding: 10,\n          },\n        },\n        usageCount: 0,\n      },\n    ];\n\n    for (const preset of presets) {\n      this.blockPresets.set(preset.id, preset);\n      this.presets.push(preset);\n    }\n  }\n\n  /**\n   * Create custom template\n   */\n  createTemplate(name: string, baseTemplateId: string): CustomTemplate {\n    const template: CustomTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name,\n      baseTemplateId,\n      blocks: [],\n      variables: new Map(),\n      variants: [],\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      version: 1,\n    };\n\n    this.templates.set(template.id, template);\n    this.emit('template:created', template);\n    return template;\n  }\n\n  /**\n   * Get template\n   */\n  getTemplate(templateId: string): CustomTemplate | undefined {\n    return this.templates.get(templateId);\n  }\n\n  /**\n   * Add block to template\n   */\n  addBlock(templateId: string, block: TemplateBlock): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    // Assign order if not provided\n    if (!block.order) {\n      block.order = template.blocks.length;\n    }\n\n    template.blocks.push(block);\n    template.updatedAt = Date.now();\n    this.emit('block:added', { templateId, block });\n    return true;\n  }\n\n  /**\n   * Update block\n   */\n  updateBlock(templateId: string, blockId: string, updates: Partial<TemplateBlock>): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    const blockIndex = template.blocks.findIndex((b) => b.id === blockId);\n    if (blockIndex === -1) return false;\n\n    template.blocks[blockIndex] = { ...template.blocks[blockIndex], ...updates };\n    template.updatedAt = Date.now();\n    this.emit('block:updated', { templateId, blockId, updates });\n    return true;\n  }\n\n  /**\n   * Remove block\n   */\n  removeBlock(templateId: string, blockId: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    template.blocks = template.blocks.filter((b) => b.id !== blockId);\n    template.updatedAt = Date.now();\n    this.emit('block:removed', { templateId, blockId });\n    return true;\n  }\n\n  /**\n   * Reorder blocks\n   */\n  reorderBlocks(templateId: string, blockIds: string[]): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    const blockMap = new Map(template.blocks.map((b) => [b.id, b]));\n    const reordered: TemplateBlock[] = [];\n\n    for (let i = 0; i < blockIds.length; i++) {\n      const block = blockMap.get(blockIds[i]);\n      if (block) {\n        block.order = i;\n        reordered.push(block);\n      }\n    }\n\n    template.blocks = reordered;\n    template.updatedAt = Date.now();\n    this.emit('blocks:reordered', { templateId });\n    return true;\n  }\n\n  /**\n   * Add variable\n   */\n  addVariable(templateId: string, variableName: string, defaultValue: string = ''): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    template.variables.set(variableName, defaultValue);\n    template.updatedAt = Date.now();\n    this.emit('variable:added', { templateId, variableName });\n    return true;\n  }\n\n  /**\n   * Get variables\n   */\n  getVariables(templateId: string): Record<string, string> {\n    const template = this.templates.get(templateId);\n    if (!template) return {};\n\n    const obj: Record<string, string> = {};\n    for (const [key, value] of template.variables) {\n      obj[key] = value;\n    }\n    return obj;\n  }\n\n  /**\n   * Create variant\n   */\n  createVariant(\n    templateId: string,\n    variantName: string,\n    testWeight: number = 50\n  ): TemplateVariant | null {\n    const template = this.templates.get(templateId);\n    if (!template) return null;\n\n    const variant: TemplateVariant = {\n      id: `var-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name: variantName,\n      templateId,\n      blocks: JSON.parse(JSON.stringify(template.blocks)), // Deep copy\n      testWeight,\n      performanceMetrics: { opens: 0, clicks: 0, conversions: 0 },\n    };\n\n    this.variants.set(variant.id, variant);\n    template.variants.push(variant as any);\n    template.updatedAt = Date.now();\n    this.emit('variant:created', variant);\n    return variant;\n  }\n\n  /**\n   * Get variant\n   */\n  getVariant(variantId: string): TemplateVariant | undefined {\n    return this.variants.get(variantId);\n  }\n\n  /**\n   * Get variants for template\n   */\n  getVariants(templateId: string): TemplateVariant[] {\n    return Array.from(this.variants.values()).filter((v) => v.templateId === templateId);\n  }\n\n  /**\n   * Update variant block\n   */\n  updateVariantBlock(\n    variantId: string,\n    blockId: string,\n    updates: Partial<TemplateBlock>\n  ): boolean {\n    const variant = this.variants.get(variantId);\n    if (!variant) return false;\n\n    const blockIndex = variant.blocks.findIndex((b) => b.id === blockId);\n    if (blockIndex === -1) return false;\n\n    variant.blocks[blockIndex] = { ...variant.blocks[blockIndex], ...updates };\n    this.emit('variant:block_updated', { variantId, blockId });\n    return true;\n  }\n\n  /**\n   * Record variant performance\n   */\n  recordVariantPerformance(\n    variantId: string,\n    opens: number,\n    clicks: number,\n    conversions: number\n  ): boolean {\n    const variant = this.variants.get(variantId);\n    if (!variant || !variant.performanceMetrics) return false;\n\n    variant.performanceMetrics.opens += opens;\n    variant.performanceMetrics.clicks += clicks;\n    variant.performanceMetrics.conversions += conversions;\n    this.emit('variant:performance_updated', { variantId });\n    return true;\n  }\n\n  /**\n   * Get block presets\n   */\n  getBlockPresets(category?: string): BlockPreset[] {\n    if (!category) return [...this.presets];\n    return this.presets.filter((p) => p.category === category);\n  }\n\n  /**\n   * Add block from preset\n   */\n  addBlockFromPreset(templateId: string, presetId: string): boolean {\n    const preset = this.blockPresets.get(presetId);\n    if (!preset) return false;\n\n    const newBlock = JSON.parse(JSON.stringify(preset.block));\n    newBlock.id = `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const result = this.addBlock(templateId, newBlock);\n    if (result) {\n      preset.usageCount++;\n    }\n    return result;\n  }\n\n  /**\n   * Generate HTML preview\n   */\n  generateHtmlPreview(templateId: string, variables?: Record<string, string>): string {\n    const template = this.templates.get(templateId);\n    if (!template) return '';\n\n    let html = '<html><body style=\"font-family: Arial, sans-serif;\">';\n\n    for (const block of template.blocks) {\n      html += this.renderBlock(block, variables);\n    }\n\n    html += '</body></html>';\n    return html;\n  }\n\n  /**\n   * Render block to HTML\n   */\n  private renderBlock(block: TemplateBlock, variables?: Record<string, string>): string {\n    let html = '';\n    const styling = block.styling || {};\n    const style = `\n      font-size: ${styling.fontSize || 16}px;\n      color: ${styling.color || '#000000'};\n      background-color: ${styling.backgroundColor || 'transparent'};\n      text-align: ${styling.alignment || 'left'};\n      padding: ${styling.padding || 0}px;\n    `;\n\n    switch (block.type) {\n      case 'text':\n        const textBlock = block as TextBlock;\n        let content = textBlock.content || '';\n        if (variables) {\n          for (const [key, value] of Object.entries(variables)) {\n            content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);\n          }\n        }\n        html = `<div style=\"${style}\">${content}</div>`;\n        break;\n\n      case 'image':\n        const imgBlock = block as ImageBlock;\n        html = `<img src=\"${imgBlock.imageUrl}\" alt=\"${imgBlock.altText || ''}\" width=\"${imgBlock.width || 'auto'}\" height=\"${imgBlock.height || 'auto'}\" style=\"${style}\" />`;\n        break;\n\n      case 'button':\n        const btnBlock = block as ButtonBlock;\n        const btnUrl = variables\n          ? Object.entries(variables).reduce(\n              (acc, [key, value]) => acc.replace(new RegExp(`{{${key}}}`, 'g'), value),\n              btnBlock.url\n            )\n          : btnBlock.url;\n        html = `<a href=\"${btnUrl}\" style=\"${style} background-color: ${btnBlock.backgroundColor || '#4CAF50'}; color: ${btnBlock.textColor || '#FFFFFF'}; padding: 10px 20px; text-decoration: none; display: inline-block; border-radius: 4px;\">${btnBlock.text}</a>`;\n        break;\n\n      case 'divider':\n        html = `<hr style=\"border: none; border-top: 1px solid ${styling.color || '#CCCCCC'}; margin: 20px 0;\" />`;\n        break;\n\n      case 'spacer':\n        const height = block.metadata?.height || 20;\n        html = `<div style=\"height: ${height}px;\"></div>`;\n        break;\n    }\n\n    return html;\n  }\n\n  /**\n   * Duplicate template\n   */\n  duplicateTemplate(templateId: string, newName: string): CustomTemplate | null {\n    const original = this.templates.get(templateId);\n    if (!original) return null;\n\n    const duplicate: CustomTemplate = {\n      id: `tpl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      name: newName,\n      baseTemplateId: original.baseTemplateId,\n      blocks: JSON.parse(JSON.stringify(original.blocks)),\n      variables: new Map(original.variables),\n      variants: [],\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      version: 1,\n    };\n\n    this.templates.set(duplicate.id, duplicate);\n    this.emit('template:duplicated', { original, duplicate });\n    return duplicate;\n  }\n\n  /**\n   * Get all templates\n   */\n  getAllTemplates(): CustomTemplate[] {\n    return Array.from(this.templates.values());\n  }\n\n  /**\n   * Delete template\n   */\n  deleteTemplate(templateId: string): boolean {\n    const template = this.templates.get(templateId);\n    if (!template) return false;\n\n    // Delete associated variants\n    for (const variant of template.variants) {\n      this.variants.delete((variant as any).id);\n    }\n\n    this.templates.delete(templateId);\n    this.emit('template:deleted', { templateId });\n    return true;\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    // Cleanup if needed\n  }\n}\n\nexport default TemplateCustomizationBuilder;\n
