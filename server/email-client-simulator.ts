import { EventEmitter } from 'events';\n\nexport type EmailClient = 'gmail' | 'outlook' | 'apple' | 'thunderbird' | 'yahoo' | 'generic';\n\nexport interface ClientRenderingIssue {\n  id: string;\n  severity: 'critical' | 'warning' | 'info';\n  message: string;\n  element?: string;\n  suggestion?: string;\n  affectedClients: EmailClient[];\n}\n\nexport interface ClientRenderingResult {\n  client: EmailClient;\n  html: string;\n  issues: ClientRenderingIssue[];\n  supportedFeatures: string[];\n  unsupportedFeatures: string[];\n  renderingScore: number; // 0-100\n  cssSupport: CSSSupport;\n  htmlSupport: HTMLSupport;\n}\n\nexport interface CSSSupport {\n  flexbox: boolean;\n  grid: boolean;\n  mediaQueries: boolean;\n  animations: boolean;\n  gradients: boolean;\n  transforms: boolean;\n  filters: boolean;\n  customProperties: boolean;\n}\n\nexport interface HTMLSupport {\n  semanticTags: boolean;\n  dataAttributes: boolean;\n  ariaAttributes: boolean;\n  videoTag: boolean;\n  audioTag: boolean;\n  iframeTag: boolean;\n  formElements: boolean;\n}\n\nexport interface SimulationReport {\n  id: string;\n  templateId: string;\n  html: string;\n  results: ClientRenderingResult[];\n  overallScore: number;\n  recommendedFixes: string[];\n  bestPractices: string[];\n  createdAt: number;\n}\n\nexport interface RenderingComparison {\n  client1: EmailClient;\n  client2: EmailClient;\n  similarities: string[];\n  differences: string[];\n  commonIssues: string[];\n  client1OnlyIssues: string[];\n  client2OnlyIssues: string[];\n}\n\nclass EmailClientSimulator extends EventEmitter {\n  private simulations: Map<string, SimulationReport> = new Map();\n  private clientProfiles: Map<EmailClient, ClientProfile> = new Map();\n\n  constructor() {\n    super();\n    this.initializeClientProfiles();\n  }\n\n  /**\n   * Initialize client profiles\n   */\n  private initializeClientProfiles(): void {\n    const profiles: Record<EmailClient, ClientProfile> = {\n      gmail: {\n        name: 'Gmail',\n        cssSupport: {\n          flexbox: true,\n          grid: false,\n          mediaQueries: true,\n          animations: false,\n          gradients: true,\n          transforms: false,\n          filters: false,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: true,\n          dataAttributes: true,\n          ariaAttributes: true,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: true,\n        },\n        knownIssues: [\n          'CSS Grid not supported',\n          'CSS animations not supported',\n          'Transform properties not supported',\n        ],\n        supportLevel: 'excellent',\n      },\n      outlook: {\n        name: 'Outlook',\n        cssSupport: {\n          flexbox: false,\n          grid: false,\n          mediaQueries: false,\n          animations: false,\n          gradients: false,\n          transforms: false,\n          filters: false,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: false,\n          dataAttributes: false,\n          ariaAttributes: false,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: false,\n        },\n        knownIssues: [\n          'Limited CSS support - use inline styles only',\n          'No flexbox or grid support',\n          'VML rendering engine limitations',\n          'Complex layouts may break',\n        ],\n        supportLevel: 'limited',\n      },\n      apple: {\n        name: 'Apple Mail',\n        cssSupport: {\n          flexbox: true,\n          grid: false,\n          mediaQueries: true,\n          animations: false,\n          gradients: true,\n          transforms: true,\n          filters: true,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: true,\n          dataAttributes: true,\n          ariaAttributes: true,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: true,\n        },\n        knownIssues: [\n          'Webkit rendering differences',\n          'Some CSS properties may render differently',\n        ],\n        supportLevel: 'good',\n      },\n      thunderbird: {\n        name: 'Thunderbird',\n        cssSupport: {\n          flexbox: false,\n          grid: false,\n          mediaQueries: false,\n          animations: false,\n          gradients: true,\n          transforms: false,\n          filters: false,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: false,\n          dataAttributes: false,\n          ariaAttributes: false,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: false,\n        },\n        knownIssues: [\n          'Limited HTML5 support',\n          'No flexbox or grid',\n          'Basic CSS only',\n        ],\n        supportLevel: 'basic',\n      },\n      yahoo: {\n        name: 'Yahoo Mail',\n        cssSupport: {\n          flexbox: true,\n          grid: false,\n          mediaQueries: true,\n          animations: false,\n          gradients: true,\n          transforms: false,\n          filters: false,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: true,\n          dataAttributes: true,\n          ariaAttributes: true,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: true,\n        },\n        knownIssues: [\n          'Some CSS properties stripped',\n          'Media queries limited support',\n        ],\n        supportLevel: 'good',\n      },\n      generic: {\n        name: 'Generic Email Client',\n        cssSupport: {\n          flexbox: false,\n          grid: false,\n          mediaQueries: false,\n          animations: false,\n          gradients: false,\n          transforms: false,\n          filters: false,\n          customProperties: false,\n        },\n        htmlSupport: {\n          semanticTags: false,\n          dataAttributes: false,\n          ariaAttributes: false,\n          videoTag: false,\n          audioTag: false,\n          iframeTag: false,\n          formElements: false,\n        },\n        knownIssues: ['Basic HTML and inline CSS only'],\n        supportLevel: 'minimal',\n      },\n    };\n\n    for (const [client, profile] of Object.entries(profiles)) {\n      this.clientProfiles.set(client as EmailClient, profile);\n    }\n  }\n\n  /**\n   * Simulate rendering for all clients\n   */\n  simulateForAllClients(templateId: string, html: string): SimulationReport {\n    const results: ClientRenderingResult[] = [];\n    const clients: EmailClient[] = ['gmail', 'outlook', 'apple', 'thunderbird', 'yahoo', 'generic'];\n\n    for (const client of clients) {\n      const result = this.simulateForClient(client, html);\n      results.push(result);\n    }\n\n    const overallScore = results.reduce((sum, r) => sum + r.renderingScore, 0) / results.length;\n    const recommendedFixes = this.generateRecommendedFixes(results);\n    const bestPractices = this.generateBestPractices(html);\n\n    const report: SimulationReport = {\n      id: `sim-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      templateId,\n      html,\n      results,\n      overallScore: Math.round(overallScore),\n      recommendedFixes,\n      bestPractices,\n      createdAt: Date.now(),\n    };\n\n    this.simulations.set(report.id, report);\n    this.emit('simulation:completed', report);\n    return report;\n  }\n\n  /**\n   * Simulate rendering for specific client\n   */\n  simulateForClient(client: EmailClient, html: string): ClientRenderingResult {\n    const profile = this.clientProfiles.get(client);\n    if (!profile) throw new Error(`Unknown client: ${client}`);\n\n    const issues = this.detectIssues(html, profile);\n    const supportedFeatures = this.getSupportedFeatures(profile);\n    const unsupportedFeatures = this.getUnsupportedFeatures(profile);\n    const renderingScore = this.calculateRenderingScore(issues, supportedFeatures);\n\n    const transformedHtml = this.transformHtmlForClient(html, client, profile);\n\n    return {\n      client,\n      html: transformedHtml,\n      issues,\n      supportedFeatures,\n      unsupportedFeatures,\n      renderingScore,\n      cssSupport: profile.cssSupport,\n      htmlSupport: profile.htmlSupport,\n    };\n  }\n\n  /**\n   * Detect rendering issues\n   */\n  private detectIssues(html: string, profile: ClientProfile): ClientRenderingIssue[] {\n    const issues: ClientRenderingIssue[] = [];\n    let issueId = 0;\n\n    // Check for unsupported CSS features\n    if (html.includes('display: grid') && !profile.cssSupport.grid) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'critical',\n        message: 'CSS Grid is not supported',\n        element: 'div with grid layout',\n        suggestion: 'Use table-based layout or flexbox instead',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    if (html.includes('display: flex') && !profile.cssSupport.flexbox) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'critical',\n        message: 'Flexbox is not supported',\n        element: 'div with flex layout',\n        suggestion: 'Use table-based layout instead',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    if (html.includes('@media') && !profile.cssSupport.mediaQueries) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'warning',\n        message: 'Media queries are not supported',\n        element: 'CSS media queries',\n        suggestion: 'Use fluid layouts or provide fallback styles',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    if (html.includes('animation') && !profile.cssSupport.animations) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'info',\n        message: 'CSS animations are not supported',\n        element: 'CSS animations',\n        suggestion: 'Remove animations or provide static fallback',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    if (html.includes('<video') && !profile.htmlSupport.videoTag) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'critical',\n        message: 'Video tag is not supported',\n        element: '<video>',\n        suggestion: 'Use animated GIF or image with link instead',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    if (html.includes('<iframe') && !profile.htmlSupport.iframeTag) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'critical',\n        message: 'iFrame tag is not supported',\n        element: '<iframe>',\n        suggestion: 'Use image or fallback content instead',\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    // Add known issues from profile\n    for (const knownIssue of profile.knownIssues) {\n      issues.push({\n        id: `issue-${issueId++}`,\n        severity: 'warning',\n        message: knownIssue,\n        affectedClients: [profile.name as EmailClient],\n      });\n    }\n\n    return issues;\n  }\n\n  /**\n   * Get supported features\n   */\n  private getSupportedFeatures(profile: ClientProfile): string[] {\n    const features: string[] = [];\n\n    if (profile.cssSupport.flexbox) features.push('CSS Flexbox');\n    if (profile.cssSupport.grid) features.push('CSS Grid');\n    if (profile.cssSupport.mediaQueries) features.push('Media Queries');\n    if (profile.cssSupport.animations) features.push('CSS Animations');\n    if (profile.cssSupport.gradients) features.push('CSS Gradients');\n    if (profile.cssSupport.transforms) features.push('CSS Transforms');\n    if (profile.cssSupport.filters) features.push('CSS Filters');\n    if (profile.htmlSupport.videoTag) features.push('Video Tag');\n    if (profile.htmlSupport.audioTag) features.push('Audio Tag');\n    if (profile.htmlSupport.iframeTag) features.push('iFrame Tag');\n\n    return features;\n  }\n\n  /**\n   * Get unsupported features\n   */\n  private getUnsupportedFeatures(profile: ClientProfile): string[] {\n    const features: string[] = [];\n\n    if (!profile.cssSupport.flexbox) features.push('CSS Flexbox');\n    if (!profile.cssSupport.grid) features.push('CSS Grid');\n    if (!profile.cssSupport.mediaQueries) features.push('Media Queries');\n    if (!profile.cssSupport.animations) features.push('CSS Animations');\n    if (!profile.cssSupport.transforms) features.push('CSS Transforms');\n    if (!profile.cssSupport.filters) features.push('CSS Filters');\n    if (!profile.cssSupport.customProperties) features.push('CSS Custom Properties');\n    if (!profile.htmlSupport.videoTag) features.push('Video Tag');\n    if (!profile.htmlSupport.audioTag) features.push('Audio Tag');\n    if (!profile.htmlSupport.iframeTag) features.push('iFrame Tag');\n\n    return features;\n  }\n\n  /**\n   * Calculate rendering score\n   */\n  private calculateRenderingScore(issues: ClientRenderingIssue[], supportedFeatures: string[]): number {\n    let score = 100;\n\n    // Deduct points for issues\n    for (const issue of issues) {\n      switch (issue.severity) {\n        case 'critical':\n          score -= 20;\n          break;\n        case 'warning':\n          score -= 10;\n          break;\n        case 'info':\n          score -= 5;\n          break;\n      }\n    }\n\n    // Add points for supported features\n    score += supportedFeatures.length * 2;\n\n    return Math.max(0, Math.min(100, score));\n  }\n\n  /**\n   * Transform HTML for client\n   */\n  private transformHtmlForClient(html: string, client: EmailClient, profile: ClientProfile): string {\n    let transformed = html;\n\n    // For Outlook, convert to VML-compatible format\n    if (client === 'outlook') {\n      // Remove unsupported CSS\n      transformed = transformed.replace(/display:\\s*flex/g, 'display: block');\n      transformed = transformed.replace(/display:\\s*grid/g, 'display: block');\n      transformed = transformed.replace(/@media[^{]*{[^}]*}/g, ''); // Remove media queries\n    }\n\n    // For generic clients, strip advanced CSS\n    if (client === 'generic') {\n      transformed = transformed.replace(/style=\"[^\"]*\"/g, (match) => {\n        // Keep only basic styles\n        const basicStyles = match\n          .split(';')\n          .filter((style) => {\n            return (\n              style.includes('color:') ||\n              style.includes('font-size:') ||\n              style.includes('font-weight:') ||\n              style.includes('text-align:')\n            );\n          })\n          .join(';');\n        return `style=\"${basicStyles}\"`;\n      });\n    }\n\n    return transformed;\n  }\n\n  /**\n   * Generate recommended fixes\n   */\n  private generateRecommendedFixes(results: ClientRenderingResult[]): string[] {\n    const fixes: Set<string> = new Set();\n\n    for (const result of results) {\n      for (const issue of result.issues) {\n        if (issue.suggestion) {\n          fixes.add(issue.suggestion);\n        }\n      }\n    }\n\n    return Array.from(fixes);\n  }\n\n  /**\n   * Generate best practices\n   */\n  private generateBestPractices(html: string): string[] {\n    const practices: string[] = [];\n\n    if (!html.includes('<!DOCTYPE html>')) {\n      practices.push('Add DOCTYPE declaration');\n    }\n\n    if (!html.includes('meta charset')) {\n      practices.push('Add charset meta tag');\n    }\n\n    if (!html.includes('meta name=\"viewport\"')) {\n      practices.push('Add viewport meta tag for mobile responsiveness');\n    }\n\n    if (html.includes('style=')) {\n      practices.push('Use inline styles for maximum compatibility');\n    }\n\n    if (!html.includes('alt=')) {\n      practices.push('Add alt text to all images for accessibility');\n    }\n\n    if (html.includes('display: flex') || html.includes('display: grid')) {\n      practices.push('Consider using table-based layouts for better compatibility');\n    }\n\n    return practices;\n  }\n\n  /**\n   * Get simulation report\n   */\n  getSimulationReport(reportId: string): SimulationReport | undefined {\n    return this.simulations.get(reportId);\n  }\n\n  /**\n   * Compare rendering between two clients\n   */\n  compareClients(client1: EmailClient, client2: EmailClient, html: string): RenderingComparison {\n    const result1 = this.simulateForClient(client1, html);\n    const result2 = this.simulateForClient(client2, html);\n\n    const similarities: string[] = [];\n    const differences: string[] = [];\n\n    // Compare CSS support\n    const css1 = result1.cssSupport;\n    const css2 = result2.cssSupport;\n\n    if (css1.flexbox === css2.flexbox) {\n      similarities.push(`Flexbox: ${css1.flexbox ? 'Both supported' : 'Both unsupported'}`);\n    } else {\n      differences.push(`Flexbox: ${client1} ${css1.flexbox ? 'supported' : 'unsupported'}, ${client2} ${css2.flexbox ? 'supported' : 'unsupported'}`);\n    }\n\n    const commonIssues = result1.issues\n      .filter((i1) => result2.issues.some((i2) => i2.message === i1.message))\n      .map((i) => i.message);\n\n    const client1OnlyIssues = result1.issues\n      .filter((i1) => !result2.issues.some((i2) => i2.message === i1.message))\n      .map((i) => i.message);\n\n    const client2OnlyIssues = result2.issues\n      .filter((i2) => !result1.issues.some((i1) => i1.message === i2.message))\n      .map((i) => i.message);\n\n    return {\n      client1,\n      client2,\n      similarities,\n      differences,\n      commonIssues,\n      client1OnlyIssues,\n      client2OnlyIssues,\n    };\n  }\n\n  /**\n   * Get rendering statistics\n   */\n  getRenderingStatistics(): Record<string, any> {\n    const reports = Array.from(this.simulations.values());\n    const avgScore = reports.length > 0 ? reports.reduce((sum, r) => sum + r.overallScore, 0) / reports.length : 0;\n\n    const issuesByClient: Record<string, number> = {};\n    for (const report of reports) {\n      for (const result of report.results) {\n        if (!issuesByClient[result.client]) {\n          issuesByClient[result.client] = 0;\n        }\n        issuesByClient[result.client] += result.issues.length;\n      }\n    }\n\n    return {\n      totalSimulations: reports.length,\n      averageScore: Math.round(avgScore),\n      issuesByClient,\n    };\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    // Cleanup if needed\n  }\n}\n\ninterface ClientProfile {\n  name: string;\n  cssSupport: CSSSupport;\n  htmlSupport: HTMLSupport;\n  knownIssues: string[];\n  supportLevel: 'excellent' | 'good' | 'basic' | 'limited' | 'minimal';\n}\n\nexport default EmailClientSimulator;\n
