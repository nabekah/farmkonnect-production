import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\nimport { RealtimeDashboardManager } from './realtime-dashboard';\nimport { DataSourceTester, DataSourceConfig } from './datasource-testing';\n\ndescribe('RealtimeDashboardManager', () => {\n  let manager: RealtimeDashboardManager;\n\n  beforeEach(() => {\n    manager = new RealtimeDashboardManager();\n  });\n\n  afterEach(() => {\n    manager.destroy();\n  });\n\n  describe('Subscriptions', () => {\n    it('should create subscription', () => {\n      const sub = manager.subscribe('user-1', ['widget-1', 'widget-2']);\n\n      expect(sub).toBeDefined();\n      expect(sub.userId).toBe('user-1');\n      expect(sub.widgetIds).toContain('widget-1');\n      expect(sub.connected).toBe(true);\n    });\n\n    it('should unsubscribe', () => {\n      const sub = manager.subscribe('user-1', ['widget-1']);\n      const result = manager.unsubscribe(sub.id);\n\n      expect(result).toBe(true);\n      expect(manager.getSubscription(sub.id)).toBeUndefined();\n    });\n\n    it('should update subscription widgets', () => {\n      const sub = manager.subscribe('user-1', ['widget-1']);\n      const updated = manager.updateSubscription(sub.id, ['widget-2', 'widget-3']);\n\n      expect(updated).toBeDefined();\n      expect(updated?.widgetIds).toEqual(['widget-2', 'widget-3']);\n    });\n\n    it('should get subscriptions by user', () => {\n      manager.subscribe('user-1', ['widget-1']);\n      manager.subscribe('user-1', ['widget-2']);\n      manager.subscribe('user-2', ['widget-3']);\n\n      const subs = manager.getSubscriptionsByUser('user-1');\n      expect(subs).toHaveLength(2);\n    });\n\n    it('should get subscriptions for widget', () => {\n      manager.subscribe('user-1', ['widget-1', 'widget-2']);\n      manager.subscribe('user-2', ['widget-1']);\n      manager.subscribe('user-3', ['widget-3']);\n\n      const subs = manager.getSubscriptionsForWidget('widget-1');\n      expect(subs).toHaveLength(2);\n    });\n  });\n\n  describe('Updates and Queueing', () => {\n    it('should queue update', () => {\n      const update = manager.queueUpdate('widget-1', { value: 100 });\n\n      expect(update).toBeDefined();\n      expect(update.widgetId).toBe('widget-1');\n      expect(update.priority).toBe('normal');\n    });\n\n    it('should prioritize updates', () => {\n      manager.queueUpdate('widget-1', { value: 1 }, 'data-source', 'low');\n      manager.queueUpdate('widget-1', { value: 2 }, 'data-source', 'critical');\n      manager.queueUpdate('widget-1', { value: 3 }, 'data-source', 'high');\n\n      const stats = manager.getQueueStats();\n      expect(stats.queueSize).toBe(3);\n      expect(stats.priorityCounts.critical).toBe(1);\n      expect(stats.priorityCounts.high).toBe(1);\n      expect(stats.priorityCounts.low).toBe(1);\n    });\n\n    it('should flush updates', () => {\n      const sub = manager.subscribe('user-1', ['widget-1']);\n      manager.queueUpdate('widget-1', { value: 100 });\n      manager.queueUpdate('widget-1', { value: 200 });\n\n      const listener = vi.fn();\n      manager.on('updates:flushed', listener);\n\n      manager.flushUpdates();\n\n      expect(listener).toHaveBeenCalled();\n      const stats = manager.getQueueStats();\n      expect(stats.queueSize).toBe(0);\n    });\n\n    it('should broadcast widget update', () => {\n      manager.subscribe('user-1', ['widget-1']);\n      manager.subscribe('user-2', ['widget-1']);\n\n      const listener = vi.fn();\n      manager.on('broadcast:sent', listener);\n\n      manager.broadcastWidgetUpdate('widget-1', { value: 100 });\n\n      expect(listener).toHaveBeenCalled();\n      const call = listener.mock.calls[0][0];\n      expect(call.subscribers).toBe(2);\n    });\n  });\n\n  describe('Connection Management', () => {\n    it('should mark subscription as disconnected', () => {\n      const sub = manager.subscribe('user-1', ['widget-1']);\n      manager.markDisconnected(sub.id);\n\n      const retrieved = manager.getSubscription(sub.id);\n      expect(retrieved?.connected).toBe(false);\n    });\n\n    it('should mark subscription as reconnected', () => {\n      const sub = manager.subscribe('user-1', ['widget-1']);\n      manager.markDisconnected(sub.id);\n      manager.markReconnected(sub.id);\n\n      const retrieved = manager.getSubscription(sub.id);\n      expect(retrieved?.connected).toBe(true);\n    });\n\n    it('should get connection statistics', () => {\n      manager.subscribe('user-1', ['widget-1']);\n      manager.subscribe('user-2', ['widget-1']);\n      const sub3 = manager.subscribe('user-3', ['widget-1']);\n\n      manager.markDisconnected(sub3.id);\n\n      const stats = manager.getConnectionStats();\n      expect(stats.totalSubscriptions).toBe(3);\n      expect(stats.connectedSubscriptions).toBe(2);\n      expect(stats.disconnectedSubscriptions).toBe(1);\n    });\n  });\n\n  describe('Events', () => {\n    it('should emit subscription:created event', () => {\n      const listener = vi.fn();\n      manager.on('subscription:created', listener);\n\n      manager.subscribe('user-1', ['widget-1']);\n\n      expect(listener).toHaveBeenCalled();\n    });\n\n    it('should emit update:queued event', () => {\n      const listener = vi.fn();\n      manager.on('update:queued', listener);\n\n      manager.queueUpdate('widget-1', { value: 100 });\n\n      expect(listener).toHaveBeenCalled();\n    });\n  });\n});\n\ndescribe('DataSourceTester', () => {\n  let tester: DataSourceTester;\n\n  beforeEach(() => {\n    tester = new DataSourceTester();\n  });\n\n  describe('Test Creation', () => {\n    it('should create test', () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: { url: 'https://api.example.com/data' },\n      };\n\n      const test = tester.createTest('source-1', config);\n\n      expect(test).toBeDefined();\n      expect(test.sourceId).toBe('source-1');\n      expect(test.config.type).toBe('api');\n    });\n\n    it('should get test', () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: { url: 'https://api.example.com/data' },\n      };\n\n      const created = tester.createTest('source-1', config);\n      const retrieved = tester.getTest(created.id);\n\n      expect(retrieved).toBeDefined();\n      expect(retrieved?.id).toBe(created.id);\n    });\n\n    it('should delete test', () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: { url: 'https://api.example.com/data' },\n      };\n\n      const test = tester.createTest('source-1', config);\n      const deleted = tester.deleteTest(test.id);\n\n      expect(deleted).toBe(true);\n      expect(tester.getTest(test.id)).toBeUndefined();\n    });\n  });\n\n  describe('API Source Testing', () => {\n    it('should test API source with success', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: {\n          url: 'https://jsonplaceholder.typicode.com/posts/1',\n          method: 'GET',\n          timeout: 5000,\n        },\n      };\n\n      const result = await tester.testApiSource(config);\n\n      expect(result.status).toBe('success');\n      expect(result.duration).toBeGreaterThanOrEqual(0);\n      expect(result.data).toBeDefined();\n    });\n\n    it('should handle API source error', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: {\n          url: 'https://invalid-url-that-does-not-exist.example.com',\n          method: 'GET',\n          timeout: 1000,\n        },\n      };\n\n      const result = await tester.testApiSource(config);\n\n      expect(['error', 'timeout']).toContain(result.status);\n      expect(result.error).toBeDefined();\n    });\n  });\n\n  describe('Database Source Testing', () => {\n    it('should test database source', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test DB',\n        type: 'database',\n        enabled: true,\n        config: {\n          query: 'SELECT * FROM users LIMIT 5',\n          timeout: 5000,\n        },\n      };\n\n      const result = await tester.testDatabaseSource(config);\n\n      expect(result.status).toBe('success');\n      expect(Array.isArray(result.data)).toBe(true);\n    });\n\n    it('should handle missing query', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test DB',\n        type: 'database',\n        enabled: true,\n        config: { timeout: 5000 },\n      };\n\n      const result = await tester.testDatabaseSource(config);\n\n      expect(result.status).toBe('error');\n      expect(result.error).toContain('query is required');\n    });\n  });\n\n  describe('Cache Source Testing', () => {\n    it('should test cache source', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test Cache',\n        type: 'cache',\n        enabled: true,\n        config: {\n          key: 'cache:user:1',\n          timeout: 1000,\n        },\n      };\n\n      const result = await tester.testCacheSource(config);\n\n      expect(result.status).toBe('success');\n      expect(result.data).toBeDefined();\n    });\n  });\n\n  describe('Computed Source Testing', () => {\n    it('should test computed source', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test Computed',\n        type: 'computed',\n        enabled: true,\n        config: {\n          script: 'return inputs.a + inputs.b',\n          inputs: { a: 10, b: 20 },\n        },\n      };\n\n      const result = await tester.testComputedSource(config);\n\n      expect(result.status).toBe('success');\n      expect(result.data).toBeDefined();\n    });\n  });\n\n  describe('Webhook Source Testing', () => {\n    it('should test webhook source', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test Webhook',\n        type: 'webhook',\n        enabled: true,\n        config: {\n          url: 'https://jsonplaceholder.typicode.com/posts',\n          method: 'POST',\n          payload: { title: 'Test', body: 'Test body' },\n          timeout: 5000,\n        },\n      };\n\n      const result = await tester.testWebhookSource(config);\n\n      expect(result.status).toBe('success');\n      expect(result.data).toBeDefined();\n    });\n  });\n\n  describe('Data Validation', () => {\n    it('should validate array data', () => {\n      const schema = {\n        type: 'array',\n        items: {\n          type: 'object',\n          properties: {\n            id: { type: 'number' },\n            name: { type: 'string' },\n          },\n          required: ['id', 'name'],\n        },\n      };\n\n      const data = [\n        { id: 1, name: 'Item 1' },\n        { id: 2, name: 'Item 2' },\n      ];\n\n      const errors = tester.validateData(data, schema);\n      expect(errors).toHaveLength(0);\n    });\n\n    it('should detect validation errors', () => {\n      const schema = {\n        type: 'array',\n        items: {\n          type: 'object',\n          properties: {\n            id: { type: 'number' },\n            name: { type: 'string' },\n          },\n          required: ['id', 'name'],\n        },\n      };\n\n      const data = [\n        { id: 1 }, // missing name\n        { name: 'Item 2' }, // missing id\n      ];\n\n      const errors = tester.validateData(data, schema);\n      expect(errors.length).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Test Results', () => {\n    it('should store test results', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test Cache',\n        type: 'cache',\n        enabled: true,\n        config: {\n          key: 'cache:test',\n          timeout: 1000,\n        },\n      };\n\n      const test = tester.createTest('source-1', config);\n      await tester.runTest(test.id);\n      await tester.runTest(test.id);\n\n      const results = tester.getTestResults(test.id);\n      expect(results.length).toBeGreaterThanOrEqual(2);\n    });\n\n    it('should get latest result', async () => {\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test Cache',\n        type: 'cache',\n        enabled: true,\n        config: {\n          key: 'cache:test',\n          timeout: 1000,\n        },\n      };\n\n      const test = tester.createTest('source-1', config);\n      await tester.runTest(test.id);\n\n      const latest = tester.getLatestResult(test.id);\n      expect(latest).toBeDefined();\n      expect(latest?.status).toBe('success');\n    });\n  });\n\n  describe('Events', () => {\n    it('should emit test:created event', () => {\n      const listener = vi.fn();\n      tester.on('test:created', listener);\n\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: { url: 'https://api.example.com' },\n      };\n\n      tester.createTest('source-1', config);\n\n      expect(listener).toHaveBeenCalled();\n    });\n\n    it('should emit test:deleted event', () => {\n      const listener = vi.fn();\n      tester.on('test:deleted', listener);\n\n      const config: DataSourceConfig = {\n        id: 'source-1',\n        name: 'Test API',\n        type: 'api',\n        enabled: true,\n        config: { url: 'https://api.example.com' },\n      };\n\n      const test = tester.createTest('source-1', config);\n      tester.deleteTest(test.id);\n\n      expect(listener).toHaveBeenCalled();\n    });\n  });\n});\n
